<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üîî Notifications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
}
header{
  background:#1e3a8a;
  color:white;
  padding:15px;
  text-align:center;
  font-size:20px;
}
#container{
  padding:15px;
}
.top-actions{
  text-align:right;
  margin-bottom:10px;
}
.top-actions button{
  background:#dc2626;
  color:white;
  border:none;
  padding:6px 12px;
  border-radius:5px;
  cursor:pointer;
  font-size:13px;
}
.notification{
  background:white;
  border-left:5px solid #2563eb;
  margin-bottom:12px;
  padding:12px;
  border-radius:6px;
  box-shadow:0 2px 5px rgba(0,0,0,0.08);
  position:relative;
}
.notification h3{
  margin:0;
  font-size:16px;
}
.notification p{
  margin:6px 0;
  color:#333;
}
.time{
  font-size:12px;
  color:#666;
}
.badge{
  display:inline-block;
  padding:3px 8px;
  font-size:11px;
  border-radius:10px;
  margin-bottom:6px;
  color:white;
}
.global{ background:#16a34a; }
.class{ background:#f97316; }
.personal{ background:#dc2626; }

.clear-btn{
  position:absolute;
  top:10px;
  right:10px;
  background:#e5e7eb;
  border:none;
  padding:4px 8px;
  font-size:11px;
  border-radius:4px;
  cursor:pointer;
}

.empty{
  text-align:center;
  color:#777;
  margin-top:40px;
}
</style>
</head>

<body>

<header>üîî Notifications</header>

<div id="container">
  <div class="empty">Loading notifications...</div>
</div>
<script type="module">
let res = await fetch('/api/notifications?enrollment=123&class=A');
let data = await res.json();
console.log(data);
</script>

<script>
const enrollment   = localStorage.getItem("enrollment");
const studentClass = localStorage.getItem("studentClass");
const API_BASE = "https://college-hwbb.onrender.com";
const messaging = firebase.messaging();

const token = await messaging.getToken({
  vapidKey: "BNubnwV8CTYrdDmpyhdl4f8kHXQ8Q9XpTDYNsuN59eEgDXDgsm3ecXvO-rRWbQH6MR25RJWUm3-_813aDEHpzZ8"
});

await fetch("/api/save-token", {
  method: "POST",
  headers: {"Content-Type":"application/json"},
  body: JSON.stringify({
    enrollment,
    studentClass,
    token
  })
});

if(!enrollment){
  document.getElementById("container").innerHTML =
    "<div class='empty'>‚ùå Please login first</div>";
}else{
  loadNotifications();
}

function loadNotifications(){
  fetch(`${API_BASE}/api/notifications?enrollment=${enrollment}&class=${studentClass}`)
    .then(res => res.json())
    .then(data => {
      const box = document.getElementById("container");
      box.innerHTML = "";

      if(!data.success || data.notifications.length === 0){
        box.innerHTML = "<div class='empty'>No notifications yet</div>";
        return;
      }

      // Clear All button
      box.innerHTML += `
        <div class="top-actions">
          <button onclick="clearAll()">üßπ Clear All</button>
        </div>
      `;

      data.notifications.forEach(n => {

        let badgeClass = "global";
        let badgeText  = "GLOBAL";

        if(n.target_type === "class"){
          badgeClass = "class";
          badgeText  = "CLASS";
        }
        if(n.target_type === "enrollment"){
          badgeClass = "personal";
          badgeText  = "PERSONAL";
        }

        box.innerHTML += `
          <div class="notification" id="note-${n._id}">
            <button class="clear-btn" onclick="clearOne('${n._id}')">‚úñ</button>
            <span class="badge ${badgeClass}">${badgeText}</span>
            <h3>${n.title}</h3>
            <p>${n.body}</p>
            <div class="time">üïí ${n.timestamp}</div>
          </div>
        `;
      });
    })
    .catch(err => {
      document.getElementById("container").innerHTML =
        "<div class='empty'>‚ö†Ô∏è Failed to load notifications</div>";
      console.error(err);
    });
}

/* ---------- CLEAR ONE (BACKEND) ---------- */
function clearOne(id){
  if(!confirm("Delete this notification?")) return;

  fetch(`${API_BASE}/api/notifications/${id}`, {
    method: "DELETE"
  })
  .then(res => res.json())
  .then(r => {
    if(r.success){
      const el = document.getElementById("note-" + id);
      if(el) el.remove();
    }else{
      alert("Failed to delete notification");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Server error");
  });
}

/* ---------- CLEAR ALL (BACKEND) ---------- */
function clearAll(){
  if(!confirm("Clear ALL notifications?")) return;

  fetch(`${API_BASE}/api/notifications/clear-all`, {
    method: "POST",
    headers: { "Content-Type":"application/json" },
    body: JSON.stringify({ enrollment })
  })
  .then(res => res.json())
  .then(r => {
    if(r.success){
      document.getElementById("container").innerHTML =
        "<div class='empty'>All notifications cleared</div>";
    }else{
      alert("Failed to clear notifications");
    }
  })
  .catch(err => {
    console.error(err);
    alert("Server error");
  });
}
</script>

</body>
</html>
