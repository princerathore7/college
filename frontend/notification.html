<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üîî Notifications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
}
header{
  background:#1e3a8a;
  color:white;
  padding:15px;
  text-align:center;
  font-size:20px;
}
#container{
  padding:15px;
}
.top-actions{
  text-align:right;
  margin-bottom:10px;
}
.top-actions button{
  background:#dc2626;
  color:white;
  border:none;
  padding:6px 12px;
  border-radius:5px;
  cursor:pointer;
  font-size:13px;
}
.notification{
  background:white;
  border-left:5px solid #2563eb;
  margin-bottom:12px;
  padding:12px;
  border-radius:6px;
  box-shadow:0 2px 5px rgba(0,0,0,0.08);
  position:relative;
}
.notification h3{
  margin:0;
  font-size:16px;
}
.notification p{
  margin:6px 0;
  color:#333;
}
.time{
  font-size:12px;
  color:#666;
}
.badge{
  display:inline-block;
  padding:3px 8px;
  font-size:11px;
  border-radius:10px;
  margin-bottom:6px;
  color:white;
}
.global{ background:#16a34a; }
.class{ background:#f97316; }
.personal{ background:#dc2626; }

.clear-btn{
  position:absolute;
  top:10px;
  right:10px;
  background:#e5e7eb;
  border:none;
  padding:4px 8px;
  font-size:11px;
  border-radius:4px;
  cursor:pointer;
}

.empty{
  text-align:center;
  color:#777;
  margin-top:40px;
}
</style>
</head>

<body>

<header>üîî Notifications</header>

<div id="container">
  <div class="empty">Loading notifications...</div>
</div>

<!-- üî• Firebase SDKs (COMPAT ONLY) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>
/* ---------------- FIREBASE INIT ---------------- */
firebase.initializeApp({
  apiKey: "AIzaSyCTjF_PJW03icRfxtnmwIhI8hDqv6XJscc",
  authDomain: "college-notifications-18747.firebaseapp.com",
  projectId: "college-notifications-18747",
  messagingSenderId: "721889955640",
  appId: "1:721889955640:web:d29f3d3f0829e8af89fbcd"
});

const API_BASE = "https://college-hwbb.onrender.com";

/* ---------------- INIT ---------------- */
async function init() {
  const enrollment   = localStorage.getItem("enrollment");
  const studentClass = localStorage.getItem("studentClass");

  if (!enrollment) {
    document.getElementById("container").innerHTML =
      "<div class='empty'>‚ùå Please login first</div>";
    return;
  }

  /* üîî PUSH NOTIFICATION SETUP */
  try {
    if ("serviceWorker" in navigator) {
      const registration = await navigator.serviceWorker.register(
        "/firebase-messaging-sw.js"
      );

      await navigator.serviceWorker.ready;

      const messaging = firebase.messaging();

      const token = await messaging.getToken({
        vapidKey: "BNubnwV8CTYrdDmpyhdl4f8kHXQ8Q9XpTDYNsuN59eEgDXDgsm3ecXvO-rRWbQH6MR25RJWUm3-_813aDEHpzZ8",
        serviceWorkerRegistration: registration
      });

      if (token) {
        await fetch(`${API_BASE}/api/save-token`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ enrollment, studentClass, token })
        });
        console.log("‚úÖ Push token saved");
      }
    }
  } catch (err) {
    console.warn("Firebase token error:", err);
  }

  /* üîî LOAD PANEL NOTIFICATIONS */
  loadNotifications(enrollment, studentClass);
}

/* ---------------- LOAD NOTIFICATIONS ---------------- */
async function loadNotifications(enrollment, studentClass) {
  const container = document.getElementById("container");
  container.innerHTML = "<div class='empty'>Loading notifications...</div>";

  try {
    const res = await fetch(
      `${API_BASE}/api/notifications?enrollment=${enrollment}&class=${studentClass}`
    );
    const data = await res.json();

    container.innerHTML = "";

    if (!data.success || data.notifications.length === 0) {
      container.innerHTML = "<div class='empty'>No notifications yet</div>";
      return;
    }

    container.innerHTML += `
      <div class="top-actions">
        <button onclick="clearAll('${enrollment}')">üßπ Clear All</button>
      </div>
    `;

    data.notifications.forEach(n => {
      let badge = "GLOBAL";
      if (n.target_type === "class") badge = "CLASS";
      if (n.target_type === "enrollment") badge = "PERSONAL";

      container.innerHTML += `
        <div class="notification" id="note-${n._id}">
          <button class="clear-btn" onclick="clearOne('${n._id}')">‚úñ</button>
          <span class="badge">${badge}</span>
          <h3>${n.title}</h3>
          <p>${n.body}</p>
          <div class="time">üïí ${n.timestamp}</div>
        </div>
      `;
    });

  } catch (err) {
    console.error(err);
    container.innerHTML =
      "<div class='empty'>‚ö†Ô∏è Failed to load notifications</div>";
  }
}

/* ---------------- CLEAR ONE ---------------- */
async function clearOne(id) {
  if (!confirm("Delete this notification?")) return;
  const res = await fetch(`${API_BASE}/api/notifications/${id}`, {
    method: "DELETE"
  });
  const r = await res.json();
  if (r.success) document.getElementById("note-" + id)?.remove();
}

/* ---------------- CLEAR ALL ---------------- */
async function clearAll(enrollment) {
  if (!confirm("Clear ALL notifications?")) return;
  const res = await fetch(`${API_BASE}/api/notifications/clear-all`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      enrollment,
      studentClass: localStorage.getItem("studentClass")
    })
  });
  const r = await res.json();
  if (r.success) {
    document.getElementById("container").innerHTML =
      "<div class='empty'>All notifications cleared</div>";
  }
}

/* üîë expose for onclick */
window.clearOne = clearOne;
window.clearAll = clearAll;

/* üöÄ START */
init();
</script>

</body>

</html>
.