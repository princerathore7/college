<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üîî Notifications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
}
header{
  background:#1e3a8a;
  color:white;
  padding:15px;
  text-align:center;
  font-size:20px;
}
#container{
  padding:15px;
}
.top-actions{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
  gap:10px;
}
.top-actions button, .top-actions select, .top-actions input{
  padding:6px 10px;
  border-radius:5px;
  border:none;
  font-size:13px;
  cursor:pointer;
}
.top-actions button{
  background:#dc2626;
  color:white;
}
.top-actions select{
  background:#2563eb;
  color:white;
}
.top-actions input{
  flex:1;
  border:1px solid #ccc;
}

.notification{
  background:white;
  border-left:5px solid #2563eb;
  margin-bottom:12px;
  padding:12px;
  border-radius:6px;
  box-shadow:0 2px 5px rgba(0,0,0,0.08);
  position:relative;
  cursor:pointer;
  transition: background 0.3s;
}
.notification.read{
  opacity:0.7;
  background:#f0f0f0;
}
.notification h3{
  margin:0;
  font-size:16px;
}
.notification p{
  margin:6px 0;
  color:#333;
}
.time{
  font-size:12px;
  color:#666;
}
.badge{
  display:inline-block;
  padding:3px 8px;
  font-size:11px;
  border-radius:10px;
  margin-bottom:6px;
  color:white;
}
.global{ background:#16a34a; }
.class{ background:#f97316; }
.personal{ background:#dc2626; }

.clear-btn{
  position:absolute;
  top:10px;
  right:10px;
  background:#e5e7eb;
  border:none;
  padding:4px 8px;
  font-size:11px;
  border-radius:4px;
  cursor:pointer;
}

.empty{
  text-align:center;
  color:#777;
  margin-top:40px;
}
</style>
</head>

<body>

<header>üîî Notifications</header>

<div id="container">
  <div class="empty">Loading notifications...</div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-messaging-compat.js"></script>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyCTjF_PJW03icRfxtnmwIhI8hDqv6XJscc",
  authDomain: "college-notifications-18747.firebaseapp.com",
  projectId: "college-notifications-18747",
  messagingSenderId: "721889955640",
  appId: "1:721889955640:web:d29f3d3f0829e8af89fbcd"
});

const API_BASE = "https://college-hwbb.onrender.com";

let allNotifications = []; // store for filtering/search

async function init() {
  const enrollment   = localStorage.getItem("enrollment");
  const studentClass = localStorage.getItem("studentClass");

  if (!enrollment) {
    document.getElementById("container").innerHTML =
      "<div class='empty'>‚ùå Please login first</div>";
    return;
  }

  // üîî PUSH NOTIFICATION SETUP
  try {
    if ("serviceWorker" in navigator) {
      const registration = await navigator.serviceWorker.register("/firebase-messaging-sw.js");
      await navigator.serviceWorker.ready;
      const messaging = firebase.messaging();
      const token = await messaging.getToken({
        vapidKey: "BNubnwV8CTYrdDmpyhdl4f8kHXQ8Q9XpTDYNsuN59eEgDXDgsm3ecXvO-rRWbQH6MR25RJWUm3-_813aDEHpzZ8",
        serviceWorkerRegistration: registration
      });
      if (token) {
        await fetch(`${API_BASE}/api/save-token`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ enrollment, studentClass, token })
        });
        console.log("‚úÖ Push token saved");
      }
    }
  } catch (err) {
    console.warn("Firebase token error:", err);
  }

  loadNotifications(enrollment, studentClass);
}

// ---------------- LOAD NOTIFICATIONS ----------------
async function loadNotifications(enrollment, studentClass){
  try {
    const res = await fetch(`${API_BASE}/api/notifications?enrollment=${enrollment}&class=${studentClass}`);
    const data = await res.json();

    if(!data.success || data.notifications.length===0){
      document.getElementById("container").innerHTML = "<div class='empty'>No notifications yet</div>";
      return;
    }

    allNotifications = data.notifications; // save for filters/search

    renderNotifications(allNotifications);
  } catch(err){
    console.error(err);
    document.getElementById("container").innerHTML = "<div class='empty'>‚ö†Ô∏è Failed to load notifications</div>";
  }
}

// ---------------- RENDER NOTIFICATIONS ----------------
function renderNotifications(notifications){
  const container = document.getElementById("container");
  container.innerHTML = `
    <div class="top-actions">
      <input type="text" id="searchBox" placeholder="Search notifications..." oninput="applyFilters()"/>
      <select id="filterSelect" onchange="applyFilters()">
        <option value="all">All</option>
        <option value="notices">Notices</option>
        <option value="events">Events</option>
        <option value="attendance">Attendance</option>
        <option value="class">Class</option>
        <option value="personal">Personal</option>
      </select>
      <button onclick="clearAll('${localStorage.getItem('enrollment')}')">üßπ Clear All</button>
    </div>
  `;

  notifications.forEach(n=>{
    let badge = "GLOBAL"; 
    let colorClass="global";
    if(n.target_type==="class"){ badge="CLASS"; colorClass="class"; }
    if(n.target_type==="enrollment"){ badge="PERSONAL"; colorClass="personal"; }

    container.innerHTML += `
      <div class="notification ${n.read?'read':''}" id="note-${n._id}" onclick="gotoNotification('${n._id}','${n.target_type}','${encodeURIComponent(n.title)}')">
        <button class="clear-btn" onclick="event.stopPropagation(); clearOne('${n._id}')">‚úñ</button>
        <span class="badge ${colorClass}">${badge}</span>
        <h3>${n.title}</h3>
        <p>${n.body}</p>
        <div class="time">üïí ${n.timestamp}</div>
      </div>
    `;
  });
}

// ---------------- REDIRECT / MARK READ ----------------
function gotoNotification(id,type,title){
  fetch(`${API_BASE}/api/notifications/${id}`, {method:"DELETE"}); // mark read
  let url = "/";
  if(title.toLowerCase().includes("notice")) url="notice-read.html?userType=students";
  else if(title.toLowerCase().includes("event")) url="events.html";
  else if(title.toLowerCase().includes("attendance")) url="attendance.html";
  else if(title.toLowerCase().includes("class")) url="student-dashboard.html";
  window.location.href = url;
}

// ---------------- FILTER & SEARCH ----------------
function applyFilters(){
  const filter = document.getElementById("filterSelect").value;
  const search = document.getElementById("searchBox").value.toLowerCase();
  let filtered = allNotifications;

  if(filter!=="all"){
    if(filter==="notices") filtered = filtered.filter(n=>n.title.toLowerCase().includes("notice"));
    else if(filter==="events") filtered = filtered.filter(n=>n.title.toLowerCase().includes("event"));
    else if(filter==="attendance") filtered = filtered.filter(n=>n.title.toLowerCase().includes("attendance"));
    else if(filter==="class") filtered = filtered.filter(n=>n.title.toLowerCase().includes("class"));
    else if(filter==="personal") filtered = filtered.filter(n=>n.target_type==="enrollment");
  }

  if(search) filtered = filtered.filter(n=>
    n.title.toLowerCase().includes(search) || n.body.toLowerCase().includes(search)
  );

  renderNotifications(filtered);
}

// ---------------- CLEAR ONE ----------------
async function clearOne(id){
  if(!confirm("Delete this notification?")) return;
  const res = await fetch(`${API_BASE}/api/notifications/${id}`,{method:"DELETE"});
  const r = await res.json();
  if(r.success) document.getElementById("note-"+id)?.remove();
}

// ---------------- CLEAR ALL ----------------
async function clearAll(enrollment){
  if(!confirm("Clear ALL notifications?")) return;
  const res = await fetch(`${API_BASE}/api/notifications/clear-all`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({enrollment, studentClass:localStorage.getItem("studentClass")})
  });
  const r = await res.json();
  if(r.success) document.getElementById("container").innerHTML = "<div class='empty'>All notifications cleared</div>";
}

window.clearOne=clearOne;
window.clearAll=clearAll;
window.applyFilters=applyFilters;

init();
</script>

</body>
</html>
