<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>üîî Notifications</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body{
  font-family: Arial, sans-serif;
  background:#f4f6f9;
  margin:0;
}

/* HEADER */
header{
  background:#1e3a8a;
  color:white;
  padding:15px;
  text-align:center;
  font-size:20px;
  position:sticky;
  top:0;
  z-index:10;
}

/* CONTAINER */
#container{
  padding:15px;
}

/* LOADING ANIMATION */
.loader-wrap{
  display:flex;
  justify-content:center;
  align-items:center;
  height:60vh;
}
.loader{
  width:60px;
  height:60px;
  border-radius:12px;
  background:linear-gradient(135deg,#2563eb,#1e3a8a);
  animation:spin3d 1.4s infinite ease-in-out;
  box-shadow:0 0 25px rgba(37,99,235,.6);
}
@keyframes spin3d{
  0%{transform:rotateX(0) rotateY(0)}
  50%{transform:rotateX(180deg) rotateY(0)}
  100%{transform:rotateX(180deg) rotateY(180deg)}
}

/* TOP ACTIONS */
.top-actions{
  display:flex;
  gap:10px;
  margin-bottom:12px;
}
.top-actions input{
  flex:1;
  padding:8px;
  border-radius:6px;
  border:1px solid #ccc;
}
.top-actions select{
  background:#2563eb;
  color:white;
  border:none;
  padding:8px;
  border-radius:6px;
}
.top-actions button{
  background:#dc2626;
  color:white;
  border:none;
  padding:8px 12px;
  border-radius:6px;
  cursor:pointer;
}

/* NOTIFICATION CARD */
.notification{
  background:white;
  border-left:5px solid #2563eb;
  margin-bottom:12px;
  padding:14px;
  border-radius:8px;
  box-shadow:0 6px 16px rgba(0,0,0,0.08);
  cursor:pointer;
  position:relative;
  animation:fadeIn .4s ease;
  transition:.3s;
}
@keyframes fadeIn{
  from{opacity:0; transform:translateY(8px)}
  to{opacity:1; transform:translateY(0)}
}
.notification:hover{
  transform:scale(1.01);
}

/* READ STYLE */
.notification.read{
  background:#eef2ff;
  opacity:.75;
  border-left-color:#94a3b8;
}

/* TEXT */
.notification h3{margin:0;font-size:16px}
.notification p{margin:6px 0;color:#333}
.time{font-size:12px;color:#555}

/* BADGES */
.badge{
  display:inline-block;
  padding:3px 8px;
  font-size:11px;
  border-radius:10px;
  margin-bottom:6px;
  color:white;
}
.global{background:#16a34a}
.class{background:#f97316}
.personal{background:#dc2626}

/* CLEAR ONE */
.clear-btn{
  position:absolute;
  top:10px;
  right:10px;
  background:#e5e7eb;
  border:none;
  padding:4px 7px;
  border-radius:5px;
  cursor:pointer;
}

/* EMPTY */
.empty{
  text-align:center;
  color:#777;
  margin-top:40px;
}
</style>
</head>

<body>

<header>üîî Notifications</header>

<div id="container">
  <div class="loader-wrap">
    <div class="loader"></div>
  </div>
</div>

<script>
const API_BASE="https://college-hwbb.onrender.com";
let allNotifications=[];

async function init(){
  const enrollment=localStorage.getItem("enrollment");
  const studentClass=localStorage.getItem("studentClass");

  if(!enrollment){
    container.innerHTML="<div class='empty'>‚ùå Please login first</div>";
    return;
  }
  loadNotifications(enrollment,studentClass);
}

async function loadNotifications(enrollment,studentClass){
  try{
    const res=await fetch(`${API_BASE}/api/notifications?enrollment=${enrollment}&class=${studentClass}`);
    const data=await res.json();
    if(!data.success || data.notifications.length===0){
      container.innerHTML="<div class='empty'>No notifications</div>";
      return;
    }
    allNotifications=data.notifications;
    renderNotifications(allNotifications);
  }catch{
    container.innerHTML="<div class='empty'>‚ö†Ô∏è Failed to load</div>";
  }
}

function renderNotifications(list){
  container.innerHTML=`
    <div class="top-actions">
      <input placeholder="Search..." oninput="applyFilters()">
      <select id="filterSelect" onchange="applyFilters()">
        <option value="all">All</option>
        <option value="attendance">Attendance</option>
        <option value="event">Event</option>
        <option value="notice">Notice</option>
      </select>
      <button onclick="clearAll()">Clear All</button>
    </div>
  `;

  list.forEach(n=>{
    let badge="GLOBAL",cls="global";
    if(n.target_type==="class"){badge="CLASS";cls="class";}
    if(n.target_type==="enrollment"){badge="PERSONAL";cls="personal";}

    container.innerHTML+=`
      <div class="notification ${n.read?'read':''}" id="note-${n._id}"
      onclick="openNotification('${n._id}','${encodeURIComponent(n.title)}')">
        <button class="clear-btn" onclick="event.stopPropagation();clearOne('${n._id}')">‚úñ</button>
        <span class="badge ${cls}">${badge}</span>
        <h3>${n.title}</h3>
        <p>${n.body}</p>
        <div class="time">üïí ${n.timestamp}</div>
      </div>
    `;
  });
}

/* MARK AS READ ONLY */
function openNotification(id,title){
  fetch(`${API_BASE}/api/notifications/${id}/read`,{method:"PATCH"});
  document.getElementById("note-"+id)?.classList.add("read");

  let t=decodeURIComponent(title).toLowerCase();
  if(t.includes("attendance")) location.href="attendance.html";
  else if(t.includes("event")) location.href="events.html";
  else location.href="student-dashboard.html";
}

/* FILTER */
function applyFilters(){
  const f=document.getElementById("filterSelect").value;
  let r=allNotifications;
  if(f!=="all") r=r.filter(n=>n.title.toLowerCase().includes(f));
  renderNotifications(r);
}

/* DELETE ONLY ON CLEAR */
async function clearOne(id){
  if(!confirm("Delete notification?"))return;
  await fetch(`${API_BASE}/api/notifications/${id}`,{method:"DELETE"});
  document.getElementById("note-"+id)?.remove();
}

async function clearAll(){
  if(!confirm("Clear all notifications?"))return;
  await fetch(`${API_BASE}/api/notifications/clear-all`,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      enrollment:localStorage.getItem("enrollment"),
      studentClass:localStorage.getItem("studentClass")
    })
  });
  container.innerHTML="<div class='empty'>All cleared</div>";
}

init();
</script>

</body>
</html>
