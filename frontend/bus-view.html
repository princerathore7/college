<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üöå View Bus Routes ‚Äî Acropolis</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root{
    --primary:#e6c700;
    --accent:#b37400;
    --muted:#555;
    --bus-yellow:#ffeb3b;
    --bus-maroon:#800000;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Poppins',sans-serif;background:#f4f6f8;color:#222;min-height:100vh;display:flex;flex-direction:column;}
  
  .topbar{
    background: linear-gradient(135deg,var(--bus-maroon),var(--accent));
    color:#fff;
    padding:14px 18px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    box-shadow:0 2px 8px rgba(0,0,0,0.15);
  }
  .topbar h1{font-size:1.1rem;font-weight:600}
  .topbar .small{font-size:0.85rem;color:#ffd700;}
  
  main{max-width:1100px;margin:28px auto;padding:18px;width:94%;}
  
  .card{
    background:#fff;
    border-radius:12px;
    box-shadow:0 8px 26px rgba(10,20,30,0.08);
    display:flex;
    flex-direction:column;
    overflow:hidden;
    border-top:4px solid var(--bus-yellow);
  }
  .card-head{
    padding:18px;
    border-bottom:1px solid #f0f0f0;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    flex-wrap:wrap;
  }
  .card-head .title{
    font-weight:700;
    color:var(--bus-maroon);
    font-size:1.05rem;
  }
  .status{
    font-size:0.95rem;
    color:var(--muted);
    margin-top:4px;
  }
  .controls{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
  }
  .btn{
    background:var(--bus-yellow);
    color:var(--bus-maroon);
    padding:10px 16px;
    border-radius:8px;
    border:none;
    cursor:pointer;
    font-weight:600;
    transition:0.2s;
    position:relative;
  }
  .btn:hover{transform:scale(1.05);}
  .btn.ghost{
    background:transparent;
    color:var(--bus-yellow);
    border:1px solid var(--bus-yellow);
  }
  
  .viewer{
    height:76vh;
    display:flex;
    flex-direction:column;
    margin-top:12px;
    border-radius:8px;
    overflow:hidden;
    position:relative;
    animation: busBounce 1s infinite alternate;
  }
  @keyframes busBounce{
    0%{transform:translateY(0);}
    100%{transform:translateY(2px);}
  }
  .pdf-wrap{
    flex:1;
    background:#fff;
    border-radius:8px;
    overflow:hidden;
    box-shadow:0 4px 12px rgba(0,0,0,0.05);
  }
  iframe{
    width:100%;
    height:100%;
    border:0;
    display:block;
  }
  .fallback{
    padding:32px;
    text-align:center;
    background:#fff;
    border-radius:8px;
    box-shadow:0 4px 12px rgba(0,0,0,0.05);
  }
  .msg{color:var(--bus-yellow);font-weight:700;margin-bottom:12px;font-size:1.05rem;}
  .hint{color:var(--muted);margin-bottom:18px;}
  @media(max-width:720px){
    .card-head{flex-direction:column;align-items:flex-start;gap:8px;}
    .controls{width:100%;justify-content:flex-start;}
    .viewer{height:66vh;}
  }
</style>
</head>
<body>

<header class="topbar">
  <h1>üöå Acropolis ‚Äî Bus Routes</h1>
  <div class="small">Student Panel</div>
</header>

<main>
  <div class="card" id="card">
    <div class="card-head">
      <div>
        <div class="title">Bus Routes PDF</div>
        <div class="status" id="statusText">Checking availability‚Ä¶</div>
      </div>
      <div class="controls">
        <button class="btn" id="refreshBtn">üîÑ Refresh</button>
        <button class="btn ghost" id="openNewBtn">üåê Open in new tab</button>
        <button class="btn ghost" id="backBtn">‚¨Ö Back</button>
        <button class="btn ghost" id="downloadBtn">üíæ Download PDF</button>
      </div>
    </div>

    <div class="viewer" id="viewer">
      <div class="pdf-wrap" id="pdfWrap" style="display:none">
        <iframe id="pdfFrame" src="" title="Bus Routes PDF"></iframe>
      </div>
      <div class="fallback" id="fallback" style="display:none">
        <div class="msg" id="fallbackMsg">No Bus PDF uploaded yet.</div>
        <div class="hint" id="fallbackHint">The bus routes PDF is not available right now. Contact admin or try again later.</div>
        <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
          <button class="btn" id="retryBtn">üîÅ Try Again</button>
          <a id="openDirectLink" class="btn ghost" style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center">üåê Open direct link</a>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
const API_ROOT = "https://college-hwbb.onrender.com/api/bus";
let currentPdfUrl = "";

// DOM
const statusText = document.getElementById('statusText');
const pdfWrap = document.getElementById('pdfWrap');
const pdfFrame = document.getElementById('pdfFrame');
const fallback = document.getElementById('fallback');
const fallbackMsg = document.getElementById('fallbackMsg');
const fallbackHint = document.getElementById('fallbackHint');
const downloadBtn = document.getElementById('downloadBtn');
const openDirectLink = document.getElementById('openDirectLink');

document.getElementById('refreshBtn').addEventListener('click', checkAndLoad);
document.getElementById('retryBtn').addEventListener('click', checkAndLoad);
document.getElementById('openNewBtn').addEventListener('click', ()=>{ if(currentPdfUrl) window.open(currentPdfUrl,'_blank'); });
document.getElementById('backBtn').addEventListener('click', ()=> window.history.back());
openDirectLink.addEventListener('click', ()=>{ if(currentPdfUrl) window.open(currentPdfUrl,'_blank'); });

// ‚úÖ Download PDF like Notes system
downloadBtn.addEventListener('click', async ()=> {
    if (!currentPdfUrl) return;

    try {
        const res = await fetch(`${API_ROOT}/direct`);
        const data = await res.json();

        if (!data.success) {
            alert("Bus PDF not found!");
            return;
        }

        const fileUrl = data.url;

        // Correct download method for raw PDFs
        const xhr = new XMLHttpRequest();
        xhr.open("GET", fileUrl, true);
        xhr.responseType = "blob";

        xhr.onload = function () {
            if (xhr.status === 200) {
                const blob = xhr.response;
                const link = document.createElement("a");
                link.href = window.URL.createObjectURL(blob);
                link.download = "Bus_Routes.pdf";
                link.click();
            } else {
                alert("Download failed!");
            }
        };

        xhr.onerror = () => alert("Download error!");

        xhr.send();

    } catch (err) {
        console.error(err);
        alert("Download failed!");
    }
});


// Fetch & display
async function checkAndLoad(){
    statusText.textContent = 'Fetching Bus PDF‚Ä¶';
    pdfWrap.style.display='none';
    fallback.style.display='none';
    try{
        const res = await fetch(`${API_ROOT}/view`);
        const data = await res.json();

        if(data.success && data.pdf_url){
            currentPdfUrl = data.pdf_url;
            pdfFrame.src = currentPdfUrl;
            pdfWrap.style.display='block';
            fallback.style.display='none';
            statusText.textContent = 'Bus PDF is available üöå';
            openDirectLink.href = currentPdfUrl;
            downloadBtn.style.display='inline-block';
        }else{
            currentPdfUrl='';
            statusText.textContent='Bus PDF not available ‚ùå';
            fallbackMsg.textContent='No Bus PDF uploaded yet.';
            fallbackHint.textContent='Contact admin or try again later.';
            fallback.style.display='block';
            openDirectLink.href='#';
            downloadBtn.style.display='none';
        }
    }catch(err){
        console.error(err);
        currentPdfUrl='';
        statusText.textContent='Unable to fetch PDF ‚ö†';
        fallbackMsg.textContent='Cannot load Bus PDF.';
        fallbackHint.textContent='Check your internet connection or try again later.';
        fallback.style.display='block';
        openDirectLink.href='#';
        downloadBtn.style.display='none';
    }
}

// Auto-load
document.addEventListener('DOMContentLoaded', checkAndLoad);
</script>

</body>
</html>

