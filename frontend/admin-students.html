<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin — Students Management</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --accent:#4f46e5;
  --muted:#6b7280;
  --green:#16a34a;
  --yellow:#ca8a04;
  --red:#dc2626;
}
body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:#111}
header{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:12px 20px;border-bottom:1px solid #e6e9f2}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden}
th,td{padding:10px 12px;border-bottom:1px solid #eee;font-size:14px}
th{background:#f1f3f8}
.controls{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
.badge{padding:4px 8px;border-radius:12px;font-size:12px;font-weight:600;color:#fff}
.green{background:var(--green)}
.yellow{background:var(--yellow)}
.red{background:var(--red)}
.actionBtn{padding:4px 8px;font-size:12px;border:0;border-radius:6px;cursor:pointer;background:var(--accent);color:#fff}
.no-data{text-align:center;color:#888}
</style>
</head>

<body>

<header>
  <h2>Admin — Students</h2>
  <button class="actionBtn" onclick="logout()">Logout</button>
</header>

<main style="padding:20px;max-width:1400px;margin:auto">

<div class="controls">
  <select id="year"><option value="">All Years</option><option>1</option><option>2</option><option>3</option><option>4</option></select>
  <select id="branch"><option value="">All Branches</option><option>CSE</option><option>IT</option><option>AIML</option><option>ECE</option></select>
  <button class="actionBtn" id="refreshBtn">Refresh</button>
</div>

<table>
<thead>
<tr>
  <th>Enrollment</th>
  <th>Name</th>
  <th>Year</th>
  <th>Branch</th>
  <th>Attendance</th>
  <th>Pending Fees</th>
  <th>Fine</th>
</tr>
</thead>
<tbody id="studentsBody">
<tr><td colspan="7" class="no-data">Loading...</td></tr>
</tbody>
</table>

</main>

<script>
const API_STUDENTS = "https://college-hwbb.onrender.com/api/admin/students";
const API_ATT = "https://college-hwbb.onrender.com/api/attendance/student/";
const API_FINE = "https://college-hwbb.onrender.com/api/fines/student-dashboard/";

function logout(){
  localStorage.clear();
  location.href="login.html";
}

/* -------------------------
   FETCH STUDENTS (CACHE)
-------------------------- */
async function fetchStudents(force=false){
  if(!force){
    const cached = localStorage.getItem("admin_students");
    if(cached) return JSON.parse(cached);
  }

  const res = await fetch(API_STUDENTS);
  const data = await res.json();
  if(data.success){
    localStorage.setItem("admin_students", JSON.stringify(data.students));
    return data.students;
  }
  return [];
}

/* -------------------------
   FETCH ATTENDANCE (REFRESH)
-------------------------- */
async function fetchAttendance(enr){
  const res = await fetch(API_ATT + enr);
  const d = await res.json();
  return d.success ? d.attendance : null;
}

/* -------------------------
   FETCH FINE (REFRESH)
-------------------------- */
async function fetchFine(enr){
  const res = await fetch(API_FINE + enr);
  const d = await res.json();
  if(d.success && d.fines.length){
    return d.fines.reduce((s,f)=>s+f.fine,0);
  }
  return 0;
}

/* -------------------------
   RENDER
-------------------------- */
async function render(refresh=false){
  const body = document.getElementById("studentsBody");
  const students = await fetchStudents(refresh);

  body.innerHTML = "";

  for(const s of students){
    let att = s.attendance;
    let fine = s.fine ?? 0;

    if(refresh){
      att = await fetchAttendance(s.enrollment);
      fine = await fetchFine(s.enrollment);
      s.attendance = att;
      s.fine = fine;
    }

    const badge = att
      ? `<span class="badge ${att.percentage>=75?"green":att.percentage>=60?"yellow":"red"}">${att.percentage}%</span>
         <button class="actionBtn" onclick="editAttendance('${s.enrollment}')">Edit</button>`
      : "—";

    body.innerHTML += `
      <tr>
        <td>${s.enrollment}</td>
        <td>${s.name}</td>
        <td>${s.year}</td>
        <td>${s.branch}</td>
        <td>${badge}</td>
        <td>₹ ${s.pendingFees ?? 0}
          <button class="actionBtn" onclick="editFees('${s.enrollment}')">Update</button>
        </td>
        <td>₹ ${fine}</td>
      </tr>
    `;
  }

  localStorage.setItem("admin_students", JSON.stringify(students));
}

function editAttendance(enr){
  location.href = `admin.html?enrollment=${enr}`;
}

function editFees(enr){
  location.href = `pending.html?enrollment=${enr}`;
}

refreshBtn.onclick = ()=>render(true);
document.addEventListener("DOMContentLoaded",()=>render(false));
</script>

</body>
</html>
