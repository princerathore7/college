<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin â€” Students Management</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f4f6fb;
  --card:#ffffff;
  --accent:#4f46e5;
  --muted:#6b7280;
  --green:#16a34a;
  --yellow:#ca8a04;
  --red:#dc2626;
}
body{margin:0;font-family:Inter,system-ui,sans-serif;background:var(--bg);color:#111}
header{display:flex;justify-content:space-between;align-items:center;background:#fff;padding:12px 20px;border-bottom:1px solid #e6e9f2}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:8px;overflow:hidden}
th,td{padding:10px 12px;border-bottom:1px solid #eee;font-size:14px}
th{background:#f1f3f8}
.controls{display:flex;gap:10px;margin-bottom:14px;flex-wrap:wrap}
.badge{padding:4px 8px;border-radius:12px;font-size:12px;font-weight:600;color:#fff}
.green{background:var(--green)}
.yellow{background:var(--yellow)}
.red{background:var(--red)}
.actionBtn{padding:4px 8px;font-size:12px;border:0;border-radius:6px;cursor:pointer;background:var(--accent);color:#fff;margin-left:4px}
.no-data{text-align:center;color:#888}
</style>
</head>

<body>

<header>
  <h2>Admin â€” Students</h2>
  <button class="actionBtn" onclick="logout()">Logout</button>
</header>

<main style="padding:20px;max-width:1400px;margin:auto">

<div class="controls">
  <select id="year">
    <option value="">All Years</option>
    <option value="1">1st Year</option>
    <option value="2">2nd Year</option>
    <option value="3">3rd Year</option>
    <option value="4">4th Year</option>
  </select>

  <select id="branch">
    <option value="">All Branches</option>

    <!-- Computer / IT -->
    <option value="CSE">CSE - Computer Science Engineering</option>
    <option value="IT">IT - Information Technology</option>
    <option value="AIML">AIML - Artificial Intelligence & Machine Learning</option>
    <option value="AIDS">AIDS - Artificial Intelligence & Data Science</option>
    <option value="CSBS">CSBS - Computer Science & Business Systems</option>
    <option value="IOT">IoT - Internet of Things</option>

    <!-- Electrical / Electronics -->
    <option value="ECE">ECE - Electronics & Communication</option>
    <option value="EEE">EEE - Electrical & Electronics</option>
    <option value="EE">EE - Electrical Engineering</option>

    <!-- Mechanical / Automobile -->
    <option value="ME">ME - Mechanical Engineering</option>
    <option value="AU">AU - Automobile Engineering</option>
    <option value="MT">MT - Mechatronics</option>

    <!-- Civil / Core -->
    <option value="CE">CE - Civil Engineering</option>
    <option value="CHE">CHE - Chemical Engineering</option>
    <option value="MIN">MIN - Mining Engineering</option>
    <option value="PET">PET - Petroleum Engineering</option>

    <!-- Bio / Agri -->
    <option value="BT">BT - Biotechnology</option>
    <option value="BME">BME - Biomedical Engineering</option>
    <option value="AG">AG - Agriculture Engineering</option>
    <option value="FT">FT - Food Technology</option>
    <option value="ENV">ENV - Environmental Engineering</option>
    <option value="TX">TX - Textile Engineering</option>

    <!-- Management / Pharma -->
    <option value="PIE">PIE - Production & Industrial Engineering</option>
    <option value="IM">IM - Industrial Management</option>
    <option value="DPHARMA">D.Pharmacy</option>
    <option value="BPHARMA">B.Pharmacy</option>
    <option value="MPHARMA">M.Pharmacy</option>
    <option value="PHARMA-CHEM">Pharmaceutical Chemistry</option>
    <option value="PHARMA-ANALYTICAL">Pharmaceutical Analysis</option>
    <option value="PHARMA-QUALITY">Quality Assurance</option>
    <option value="PHARMA-PHARMACO">Pharmacology</option>
    <option value="PHARMA-PHARMACEUTICS">Pharmaceutics</option>
    <option value="PHARMA-BIOTECH">Pharmaceutical Biotechnology</option>
    <option value="PHARMA-REGULATORY">Regulatory Affairs</option>

    <!-- Diploma -->
    <option value="DCSE">Diploma - Computer Science Engineering</option>
    <option value="DIT">Diploma - Information Technology</option>
    <option value="DCYBER">Diploma - Cyber Security</option>
    <option value="DECE">Diploma - Electronics & Communication</option>
    <option value="DEEE">Diploma - Electrical & Electronics</option>
    <option value="DEE">Diploma - Electrical Engineering</option>
    <option value="DME">Diploma - Mechanical Engineering</option>
    <option value="DCE">Diploma - Civil Engineering</option>
    <option value="DMIN">Diploma - Mining Engineering</option>
    <option value="DCHE">Diploma - Chemical Engineering</option>
    <option value="DAG">Diploma - Agriculture Engineering</option>
    <option value="DTX">Diploma - Textile Technology</option>
    <option value="DPLASTIC">Diploma - Plastic Engineering</option>
    <option value="DPOLY">Diploma - Polymer Engineering</option>
  </select>

  <button class="actionBtn" id="refreshBtn">Refresh</button>
</div>

<input
  type="text"
  id="searchEnrollment"
  placeholder="Search by Enrollment Number"
  oninput="render(false)"
  style="
    padding:8px 12px;
    border-radius:8px;
    border:1px solid #d1d5db;
    font-size:14px;
    min-width:220px;
    outline:none;
  "
>

<table>
<thead>
<tr>
  <th>Enrollment</th>
  <th>Name</th>
  <th>Year</th>
  <th>Branch</th>
  <th>Attendance</th>
  <th>Pending Fees</th>
  <th>Fine</th>
</tr>
</thead>
<tbody id="studentsBody">
<tr><td colspan="7" class="no-data">Loading...</td></tr>
</tbody>
</table>

</main>

<script>
const API_STUDENTS = "https://college-hwbb.onrender.com/api/admin/students";
const API_ATT = "https://college-hwbb.onrender.com/api/attendance/student/";
const API_FINE = "https://college-hwbb.onrender.com/api/fines/student-dashboard/";

function logout(){
  localStorage.clear();
  location.href="login.html";
}

/* -------------------------
   FETCH STUDENTS (CACHE)
-------------------------- */
async function fetchStudents(force=false){
  if(!force){
    const cached = localStorage.getItem("admin_students");
    if(cached) return JSON.parse(cached);
  }

  const res = await fetch(API_STUDENTS);
  const data = await res.json();
  if(data.success){
    localStorage.setItem("admin_students", JSON.stringify(data.students));
    return data.students;
  }
  return [];
}

/* -------------------------
   FETCH ATTENDANCE (REFRESH)
-------------------------- */
async function fetchAttendance(enr){
  const res = await fetch(API_ATT + enr);
  const d = await res.json();
  return d.success ? d.attendance : null;
}

/* -------------------------
   FETCH FINE (REFRESH)
-------------------------- */
async function fetchFine(enr){
  const res = await fetch(API_FINE + enr);
  const d = await res.json();
  if(d.success && d.fines.length){
    return d.fines.reduce((s,f)=>s+f.fine,0);
  }
  return 0;
}

/* -------------------------
   RENDER
-------------------------- */
async function render(refresh=false){
  const body = document.getElementById("studentsBody");

  const yearVal = document.getElementById("year").value;
  const branchVal = document.getElementById("branch").value.toLowerCase();
  const searchEnr = document.getElementById("searchEnrollment").value.trim().toLowerCase();

  const students = await fetchStudents(refresh);

  // ðŸ”¹ FILTER LOGIC (FIXED)
  let filtered = students.filter(s => {
    let ok = true;

    if(yearVal) ok = ok && String(s.year) === yearVal;
    if(branchVal) ok = ok && s.branch.toLowerCase().includes(branchVal);
    if(searchEnr) ok = ok && s.enrollment.toLowerCase().includes(searchEnr);

    return ok;
  });

  // ðŸ”¹ Enrollment search ko top pe laane ke liye
  if(searchEnr){
    filtered.sort((a,b)=>{
      return a.enrollment.toLowerCase().startsWith(searchEnr) ? -1 : 1;
    });
  }

  body.innerHTML = "";

  if(!filtered.length){
    body.innerHTML = `<tr><td colspan="7" class="no-data">No students found</td></tr>`;
    return;
  }

  for(const s of filtered){
    let att = s.attendance;
    let fine = s.fine ?? 0;

    if(refresh){
      att = await fetchAttendance(s.enrollment);
      fine = await fetchFine(s.enrollment);
      s.attendance = att;
      s.fine = fine;
    }

    const badge = att
      ? `<span class="badge ${att.percentage>=75?"green":att.percentage>=60?"yellow":"red"}">${att.percentage}%</span>
         <button class="actionBtn" onclick="editAttendance('${s.enrollment}')">Edit</button>`
      : "â€”";

    body.innerHTML += `
      <tr>
        <td>${s.enrollment}</td>
        <td>${s.name}</td>
        <td>${s.year}</td>
        <td>${s.branch}</td>
        <td>${badge}</td>
        <td>â‚¹ ${s.pendingFees ?? 0}
          <button class="actionBtn" onclick="editFees('${s.enrollment}')">Update</button>
        </td>
        <td>â‚¹ ${fine}
          <button class="actionBtn" onclick="editFine('${s.enrollment}')">Update</button>
        </td>
      </tr>
    `;
  }

  localStorage.setItem("admin_students", JSON.stringify(students));
}
/* -------------------------
   REDIRECTION LOGIC
-------------------------- */
function editAttendance(enr){
  localStorage.setItem("selectedEnrollment", enr);
  window.location.href = "admin.html";
}

function editFees(enr){
  localStorage.setItem("selectedEnrollment", enr);
  window.location.href = "pending.html";
}

function editFine(enr){
  localStorage.setItem("selectedEnrollment", enr);
  window.location.href = "admin-fine.html";
}

/* -------------------------
   FILTERS + REFRESH
-------------------------- */
["year","branch"].forEach(id=>{
  document.getElementById(id).addEventListener("change",()=>render(false));
});
refreshBtn.onclick = ()=>render(true);

document.addEventListener("DOMContentLoaded",()=>render(false));
</script>

</body>
</html>
