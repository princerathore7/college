<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Student Dashboard ‚Äî Acropolis</title>

<!-- Fonts & icons -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Poppins', sans-serif;
    background: #f6f8fb;
    color: #222;
    overflow-y: auto;
}

/* HEADER */
header {
    background: linear-gradient(135deg, #004d40, #009688);
    color: #fff;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    position: sticky;
    top: 0;
    z-index: 1000;
    width: 100%;
}

.logo-area {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-area img {
    height: 44px;
    border-radius: 6px;
}

.logo-area h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
}

.top-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.action-btn {
    padding: 9px 14px;
    border-radius: 8px;
    border: none;
    background: #fff;
    color: #004d40;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
}

.action-btn:hover {
    transform: translateY(-2px);
}

/* SIDEBAR FIX */
/* Position & styling */
.sidebar {
  position: fixed;
  top: 0;
  left: 0;
  width: 260px;
  height: 100%;
  background: #004d40;
  color: #fff;
  padding-top: 70px;
  transform: translateX(-260px);
  transition: 0.3s ease;
  z-index: 1500;
}

/* Sidebar visible */
.sidebar-open {
  transform: translateX(0);
}

/* Backdrop */
.backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.4);
  display: none;
  z-index: 1400;
}

/* Sidebar links */
.sidebar a {
  display: block;
  padding: 14px 18px;
  color: white;
  text-decoration: none;
  font-size: 16px;
}

.sidebar a:hover {
  background: rgba(255,255,255,0.1);
}

/* MAIN */
main {
    max-width: 1200px;
    margin: 28px auto;
    padding: 24px;
}

.grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 18px;
}

.col-4 { grid-column: span 4; }
.col-8 { grid-column: span 8; }

/* SECTIONS */
.section {
    background: #fff;
    padding: 18px;
    border-radius: 12px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.06);
}

.profile-box {
    text-align: center;
    padding: 20px;
    border-radius: 12px;
}

.profile-box h2 {
    color: #004d40;
    margin-bottom: 8px;
}

.profile-row {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 8px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
}

table th,
table td {
    padding: 8px;
    border-bottom: 1px solid #eee;
    text-align: left;
}

h2.section-title {
    font-family: 'Playfair Display', serif;
    color: #004d40;
    margin-bottom: 10px;
}

/* EVENT BANNER */
#eventsBanner {
    display: flex;
    overflow-x: auto;
    gap: 12px;
    padding: 12px;
    border-radius: 10px;
    background: #e0f2f1;
    border: 1px solid #b2dfdb;
}

#eventsBanner img {
    width: 220px;
    height: 130px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    transition: transform .25s;
}

#eventsBanner img:hover {
    transform: scale(1.04);
}

/* BADGES */
.badge { 
    display: inline-block;
    padding: 5px 8px;
    border-radius: 8px;
    color: #fff;
    font-weight: 700;
}
.badge.pending { background: #ff9800; }
.badge.paid { background: #28a745; }

/* MODAL */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.45);
    z-index: 1300;
}

.modal.show {
    display: flex;
}

.modal-box {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    width: 360px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    position: relative;
}

.close-x {
    position: absolute;
    right: 14px;
    top: 10px;
    cursor: pointer;
    font-size: 20px;
}

/* ----------------------------- */
/*         RESPONSIVE            */
/* ----------------------------- */

/* Tablet + Small Laptops */
@media (max-width: 900px) {
    .logo-area h1 {
        font-size: 1.1rem;
    }

    .col-4, .col-8 {
        grid-column: span 12;
    }

    #eventsBanner img {
        width: 160px;
        height: 100px;
    }
}

/* Phones */
@media (max-width: 600px) {
    header {
        padding: 10px 14px;
    }

    .logo-area img {
        height: 36px;
    }

    .logo-area h1 {
        font-size: 1rem;
    }

    .top-actions {
        gap: 6px;
    }

    .action-btn {
        padding: 7px 12px;
        font-size: 0.85rem;
    }

    main {
        padding: 14px;
    }

    .section {
        padding: 14px;
    }

    table th, table td {
        padding: 6px;
        font-size: 0.85rem;
    }

    #eventsBanner img {
        width: 140px;
        height: 90px;
    }
}


.refresh-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  background: linear-gradient(135deg, #4f46e5, #6366f1);
  color: #fff;
  border: none;
  padding: 10px 18px;
  font-size: 15px;
  font-weight: 600;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.25s ease;
  box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3);
}

.refresh-btn svg {
  stroke: white;
  transition: 0.25s ease;
}

.refresh-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 18px rgba(79, 70, 229, 0.4);
}

.refresh-btn:active {
  transform: scale(0.95);
}

.refresh-btn:hover svg {
  rotate: 180deg;
}

</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo-area">
    <span style="font-size:22px;cursor:pointer;margin-right:6px" id="menuToggle">‚ò∞</span>
    <img src="logo.jpg" alt="logo">
    <h1>Acropolis ‚Äî Student</h1>
  </div>

  <div class="top-actions">
    <div id="mentorIdDisplay" style="color:#fff;margin-right:8px">Student</div>
    <button class="action-btn" id="logoutBtn">Logout</button>
  </div>
</header>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <h2 style="text-align:center;margin:0 0 12px 0;font-family:'Playfair Display',serif">Menu</h2>

  <a href="student-dashboard.html">üè† Dashboard</a>
  <a href="student-ass.html">üíª Assignments</a>
  <a href="notes-view.html">üìö Notes</a>
  <a href="exams.html">üìù Exams</a>
  <a href="marks-view.html">üèÜ Results</a>
<a href="notice-read.html?userType=students">
  üì∞ Notices <span class="notice-badge">0</span>
</a>

  <a href="rules.html">üìò Rules</a>
  <a href="bus-view.html">üöå Bus</a>
  <a href="fees.html">üí∞ Fees</a>

  <!-- NEW FINES BUTTON -->
  <a href="#" id="finesBtn">üí≥ Your Fines</a>

  <a href="#" onclick="logout()">üö™ Logout</a>
</div>

<div class="backdrop" id="backdrop" onclick="closeSidebar()"></div>

<!-- MAIN -->
<main>
  <div class="grid">
    <!-- left -->
    <div class="col-4">
      <div class="section profile-box">
        <h2 id="studentName">Loading...</h2>
        <p><strong>Enrollment:</strong> <span id="studentEnrollment">‚Äî</span></p>
        <p><strong>Class:</strong> <span id="studentClass">‚Äî</span></p>
      </div>
      

<button id="refreshDashboard" class="refresh-btn">
  <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
    <path d="M4 4v6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round"/>
    <path d="M20 20v-6h-6" stroke="currentColor" stroke-width="2" stroke-linecap="round"
      stroke-linejoin="round"/>
    <path d="M5 19a9 9 0 0 1 0-14l5 5H4" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round"/>
    <path d="M19 5a9 9 0 0 1 0 14l-5-5h6" stroke="currentColor" stroke-width="2"
      stroke-linecap="round" stroke-linejoin="round"/>
  </svg>
  Refresh
</button>

      <div class="section" id="attendanceSection">
        
        <h2 class="section-title">Attendance</h2>
        <p><strong>Total:</strong> <span id="attTotal">0</span></p>
        <p><strong>Present:</strong> <span id="attPresent">0</span></p>
        <p><strong>Percent:</strong> <span id="attPercent">0%</span></p>
      </div>

      <div class="section">
        <h2 class="section-title">Quick Actions</h2>
        <button class="action-btn" onclick="window.location.href='student-ass.html'">Assignments</button>
        <button class="action-btn" id="openFeesBtn">.</button>
             <button class="action-btn" onclick="window.location.href='fees.html'">fees</button>
        <button class="action-btn" onclick="window.location.href='timetable-view.html'">View Timetable</button>
      </div>
      
    </div>

    <!-- right -->
    <div class="col-8">
      <div id="eventsBanner" class="section"></div>
      

        <!-- Assignments Section -->
  <div class="section" id="assignmentsSection">
    <h2>Assignments</h2>
    <table id="assignmentsTable">
      <thead>
        <tr>
          <th>Title</th>
          <th>Subject</th>
          <th>Deadline</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>


      <div class="section" id="examsSection">
        <h2 class="section-title">Upcoming Exams</h2>
        <table>
          <thead><tr><th>Exam</th><th>Subject</th><th>Date</th><th>Room</th></tr></thead>
          <tbody id="examsBody">
            <tr><td colspan="4" style="text-align:center;color:#888">Loading exams...</td></tr>
          </tbody>
        </table>
      </div>
<!-- 
  üìÖ Timetable Section 
<div class="section" id="timetableSection">
  <h2>Class Timetable And Notes</h2>

  <label for="classSelect">Select Your Class:</label>
  <select id="classSelect">
    <option value="">-- Select Class --</option>
    <option>1A</option><option>1B</option>
    <option>2A</option><option>2B</option>
    <option>3A</option><option>3B</option>
    <option>4A</option><option>4B</option>
    <option>5A</option><option>5B</option>
    <option>6A</option><option>6B</option>
    <option>7A</option><option>7B</option>
    <option>8A</option><option>8B</option>
    <option>9A</option><option>9B</option>
    <option>10A</option><option>10B</option>
    <option>11A</option><option>11B</option>
    <option>12A</option><option>12B</option>
  </select>

  <button onclick="fetchTimetable()">View Timetable</button> -->
<h2>Class Notes & PDF Resources</h2>

<label for="yearSelect">Select Year:</label>
<select id="yearSelect">
  <option value="">-- Select Year --</option>
  <option value="1">1st Year</option>
  <option value="2nd Year">2nd Year</option>
  <option value="3rd Year">3rd Year</option>
  <option value="4th Year">4th Year</option>
  <option value="5th Year">5th Year</option>
</select>

<label for="branchSelect">Select Branch:</label>
<select id="branchSelect">
  <option value="">-- Select Branch --</option>
  <option value="CSE">CSE</option>
  <option value="IT">IT</option>
  <option value="ECE">ECE</option>
  <option value="ME">ME</option>
  <option value="CIVIL">CIVIL</option>
</select>

<label for="sectionSelect">Select Section:</label>
<select id="sectionSelect">
  <option value="">-- Select Section --</option>
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
</select>

<button onclick="fetchNotes()">View Notes & PDF</button>

<div id="notesContainer"></div>



  <div id="pdfContainer" style="margin-top:20px; text-align:center;">
    <p style="color:#666;">Select your class and click ‚ÄúView Timetable‚Äù to see the PDF.</p>
  </div>
</div>
<!-- Fees Modal -->
<div class="modal" id="feesModal" aria-hidden="true">
  <div class="modal-box">
    <span class="close-x" id="feesClose">&times;</span>
    <h3>Check Pending Fees</h3>
    <p>Enrollment</p>
    <input id="feeEnrollment" type="text" placeholder="Enter Enrollment" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd" />
    <button style="margin-top:10px;padding:10px 12px;border-radius:8px;background:#007bff;color:#fff;border:none;width:100%" id="checkFeeBtn">Check</button>
    <div id="feeResult" style="margin-top:12px"></div>
  </div>
</div>

<script>
/* ------------------------------------------
      CONFIG
------------------------------------------- */
const API_ROOT = "https://college-hwbb.onrender.com";

/* ------------------------------------------
      LOCAL STORAGE HELPERS
------------------------------------------- */
function saveLS(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}
function getLS(key) {
  const v = localStorage.getItem(key);
  if (!v) return null;
  try { return JSON.parse(v); } catch { return null; }
}

/* ------------------------------------------
      LOAD FROM API (REFRESH BUTTON ONLY)
------------------------------------------- */
async function refreshDashboard() {
  const enrollment = localStorage.getItem("enrollment");
  if (!enrollment) return;

  console.log("üîÑ Refreshing dashboard from API...");

  await loadStudentProfileAPI(enrollment);
  await loadAttendanceAPI(enrollment);
  await loadAssignmentsAPI(enrollment);
  await loadExamsAPI();
  await loadEventsAPI();
  await loadNoticesAPI(enrollment);

  alert("Dashboard refreshed!");
}

/* ------------------------------------------
      PROFILE ‚Äî API + SAVE
------------------------------------------- */
async function loadStudentProfileAPI(enrollment) {
  try {
    const res = await fetch(`${API_ROOT}/api/students/${enrollment}/class`);
    const data = await res.json();

    if (data.success) {
      saveLS("studentProfile", data.student);
      renderProfile(data.student);
    }
  } catch (err) {
    console.error("Profile fetch failed:", err);
  }
}

function renderProfile(s) {
  if (!s) return;
  document.getElementById("studentName").textContent = s.name || "Student";
  document.getElementById("studentEnrollment").textContent = s.enrollment;
  document.getElementById("studentClass").textContent = s.class || s.branch;
  localStorage.setItem("studentClass", s.class || s.branch);
}

/* ------------------------------------------
      ATTENDANCE ‚Äî API + SAVE
------------------------------------------- */
async function loadAttendanceAPI(enrollment) {
  try {
    const res = await fetch(`${API_ROOT}/api/attendance/student/${enrollment}`);
    const data = await res.json();

    if (data.success) {
      saveLS("studentAttendance", data.attendance);
      renderAttendance(data.attendance);
    }
  } catch (err) { console.error("Attendance API error:", err); }
}

function renderAttendance(a) {
  if (!a) return;
  document.getElementById("attTotal").textContent = a.total;
  document.getElementById("attPresent").textContent = a.present;
  document.getElementById("attPercent").textContent = a.percentage + "%";
}

/* ------------------------------------------
      ASSIGNMENTS ‚Äî API + SAVE
------------------------------------------- */
async function loadAssignmentsAPI(enrollment) {
  const className = localStorage.getItem("studentClass") || "IT";

  try {
    const res = await fetch(`${API_ROOT}/api/assignments/class/${className}`);
    const data = await res.json();

    if (data.success) {
      saveLS("studentAssignments", data.assignments);
      renderAssignments(data.assignments);
    }
  } catch (err) { console.error("Assignments API error:", err); }
}

function renderAssignments(list) {
  const tbody = document.querySelector("#assignmentsTable tbody");
  tbody.innerHTML = "";

  if (!list || list.length === 0) {
    tbody.innerHTML =
      `<tr><td colspan="4" style="text-align:center;color:gray;">No assignments</td></tr>`;
    return;
  }

  list.forEach(a => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${a.title}</td>
      <td>${a.subject}</td>
      <td>${a.deadline}</td>
      <td>${a.status || "Pending"}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ------------------------------------------
      EXAMS ‚Äî API + SAVE
------------------------------------------- */
async function loadExamsAPI() {
  try {
    const res = await fetch(`${API_ROOT}/api/exams`);
    const data = await res.json();

    if (data.success) {
      saveLS("studentExams", data.exams);
      renderExams(data.exams);
    }
  } catch (err) { console.error("Exams fetch error:", err); }
}

function renderExams(list) {
  const tbody = document.getElementById("examsBody");
  tbody.innerHTML = "";

  if (!list || list.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#888">No upcoming exams</td></tr>`;
    return;
  }

  list.forEach(e => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${e.examName}</td>
      <td>${e.subject}</td>
      <td>${e.date}</td>
      <td>${e.room}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ------------------------------------------
      EVENTS ‚Äî API + SAVE
------------------------------------------- */
async function loadEventsAPI() {
  try {
    const res = await fetch(`${API_ROOT}/api/events`);
    const data = await res.json();

    if (data.success) {
      saveLS("studentEvents", data.events);
      renderEvents(data.events);
    }
  } catch (err) { console.error("Events error:", err); }
}

function renderEvents(events) {
  const b = document.getElementById("eventsBanner");
  b.innerHTML = "";

  if (!events || events.length === 0) {
    b.innerHTML = `<p>No upcoming events</p>`;
    return;
  }

  events.forEach(ev => {
    const img = document.createElement("img");
    img.src = ev.image;
    img.title = ev.title;
    img.onclick = () => (location.href = `events.html?eventId=${ev.eventId}`);
    b.appendChild(img);
  });
}

/* ------------------------------------------
      NOTICES ‚Äî API + SAVE
------------------------------------------- */
async function loadNoticesAPI(enrollment) {
  try {
    const res = await fetch(`${API_ROOT}/api/notices/get/students`);
    const data = await res.json();

    if (data.success) {
      saveLS("studentNotices", data.notices);
      renderUnreadNotices(data.notices, enrollment);
    }
  } catch (err) { console.error("Notices fetch error:", err); }
}

function renderUnreadNotices(list, enrollment) {
  const unread = list.filter(n => !n.readBy?.includes(enrollment)).length;
  const badge = document.querySelector(".notice-badge");
  if (badge) badge.textContent = unread;
}

/* ------------------------------------------
    FINE BUTTON 
------------------------------------------- */
document.getElementById("finesBtn").addEventListener("click", function () {
    const enrollment = localStorage.getItem("studentEnrollment") 
                    || localStorage.getItem("enrollment");

    if (!enrollment) {
        alert("Enrollment number missing! Please login again.");
        return;
    }

    window.location.href = "fines.html";
});

/* ------------------------------------------
      ON PAGE LOAD ‚Üí LOAD ONLY FROM LOCALSTORAGE
------------------------------------------- */
document.addEventListener("DOMContentLoaded", () => {
  const enrollment = localStorage.getItem("enrollment");
  if (!enrollment) {
    window.location.href = "student-login.html";
    return;
  }

  console.log("‚ö° Dashboard loaded instantly from LocalStorage");

  renderProfile(getLS("studentProfile"));
  renderAttendance(getLS("studentAttendance"));
  renderAssignments(getLS("studentAssignments"));
  renderExams(getLS("studentExams"));
  renderEvents(getLS("studentEvents"));
  renderUnreadNotices(getLS("studentNotices") || [], enrollment);

  // Refresh button event
  const btn = document.getElementById("refreshDashboard");
  if (btn) btn.addEventListener("click", refreshDashboard);
});
function openSidebar() {
  document.getElementById("sidebar").classList.add("sidebar-open");
  document.getElementById("backdrop").style.display = "block";
}

function closeSidebar() {
  document.getElementById("sidebar").classList.remove("sidebar-open");
  document.getElementById("backdrop").style.display = "none";
}

document.getElementById("menuToggle").addEventListener("click", openSidebar);
</script>

 <!-- Your notification logic -->
<script src="/static/js/notification.js"></script>
<script>
  window.addEventListener("load", () => {
    enableNotifications();
  });
  /* =========================================================
   PUSH SUBSCRIPTION (CLIENT SIDE)
   ========================================================= */

const PUBLIC_VAPID_KEY = "BNubnwV8CTYrdDmpyhdl4f8kHXQ8Q9XpTDYNsuN59eEgDXDgsm3ecXvO-rRWbQH6MR25RJWUm3-_813aDEHpzZ8";

/* ---------- Base64 ‚Üí Uint8Array ---------- */
function urlBase64ToUint8Array(base64String) {
  const padding = "=".repeat((4 - base64String.length % 4) % 4);
  const base64 = (base64String + padding)
    .replace(/-/g, "+")
    .replace(/_/g, "/");

  const rawData = window.atob(base64);
  const outputArray = new Uint8Array(rawData.length);

  for (let i = 0; i < rawData.length; ++i) {
    outputArray[i] = rawData.charCodeAt(i);
  }
  return outputArray;
}

/* ---------- Subscribe User ---------- */
async function subscribeUserToPush() {
  try {
    if (!("serviceWorker" in navigator)) {
      console.log("Service Worker not supported");
      return;
    }

    if (!("PushManager" in window)) {
      console.log("Push not supported");
      return;
    }

    const permission = Notification.permission;
    if (permission !== "granted") {
      console.log("Notification permission not granted");
      return;
    }

    const registration = await navigator.serviceWorker.ready;

    let subscription = await registration.pushManager.getSubscription();

    if (!subscription) {
      subscription = await registration.pushManager.subscribe({
        userVisibleOnly: true,
        applicationServerKey: urlBase64ToUint8Array(PUBLIC_VAPID_KEY)
      });

      console.log("‚úÖ New Push Subscription:", subscription);
    } else {
      console.log("‚ÑπÔ∏è Already subscribed");
    }

    // Send subscription to backend
    await fetch("https://college-hwbb.onrender.com/api/subscribe", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(subscription)
    });

    console.log("üì° Subscription sent to backend");

  } catch (err) {
    console.error("‚ùå Push subscription failed:", err);
  }
}

/* ---------- Auto Subscribe ---------- */
document.addEventListener("DOMContentLoaded", () => {
  subscribeUserToPush();
});

</script>
</body>
</html>
