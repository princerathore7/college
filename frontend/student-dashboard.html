<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Student Dashboard ‚Äî Acropolis</title>

<!-- Fonts & icons -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
* {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
}

body {
    font-family: 'Poppins', sans-serif;
    background: #f6f8fb;
    color: #222;
    overflow-y: auto;
}

/* HEADER */
header {
    background: linear-gradient(135deg, #004d40, #009688);
    color: #fff;
    padding: 14px 18px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    box-shadow: 0 2px 10px rgba(0,0,0,0.12);
    position: sticky;
    top: 0;
    z-index: 1000;
    width: 100%;
}

.logo-area {
    display: flex;
    align-items: center;
    gap: 12px;
}

.logo-area img {
    height: 44px;
    border-radius: 6px;
}

.logo-area h1 {
    font-family: 'Playfair Display', serif;
    font-size: 1.4rem;
}

.top-actions {
    display: flex;
    align-items: center;
    gap: 12px;
}

.action-btn {
    padding: 9px 14px;
    border-radius: 8px;
    border: none;
    background: #fff;
    color: #004d40;
    font-weight: 600;
    cursor: pointer;
    transition: 0.2s;
}

.action-btn:hover {
    transform: translateY(-2px);
}

/* SIDEBAR */
.sidebar {
    position: fixed;
    left: -260px;
    top: 0;
    width: 250px;
    height: 100%;
    background: linear-gradient(180deg, #004d40, #009688);
    color: #fff;
    padding-top: 74px;
    transition: left .28s ease-in-out;
    z-index: 1200;
}

.sidebar.active {
    left: 0;
}

.sidebar a {
    display: block;
    color: #fff;
    padding: 12px 18px;
    text-decoration: none;
    font-weight: 500;
}

/* BACKDROP */
.backdrop {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.35);
    z-index: 1100;
}

.backdrop.active {
    display: block;
}

/* MAIN */
main {
    max-width: 1200px;
    margin: 28px auto;
    padding: 24px;
}

.grid {
    display: grid;
    grid-template-columns: repeat(12, 1fr);
    gap: 18px;
}

.col-4 { grid-column: span 4; }
.col-8 { grid-column: span 8; }

/* SECTIONS */
.section {
    background: #fff;
    padding: 18px;
    border-radius: 12px;
    box-shadow: 0 6px 14px rgba(0,0,0,0.06);
}

.profile-box {
    text-align: center;
    padding: 20px;
    border-radius: 12px;
}

.profile-box h2 {
    color: #004d40;
    margin-bottom: 8px;
}

.profile-row {
    display: flex;
    justify-content: space-between;
    gap: 10px;
    margin-top: 8px;
}

table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 8px;
}

table th,
table td {
    padding: 8px;
    border-bottom: 1px solid #eee;
    text-align: left;
}

h2.section-title {
    font-family: 'Playfair Display', serif;
    color: #004d40;
    margin-bottom: 10px;
}

/* EVENT BANNER */
#eventsBanner {
    display: flex;
    overflow-x: auto;
    gap: 12px;
    padding: 12px;
    border-radius: 10px;
    background: #e0f2f1;
    border: 1px solid #b2dfdb;
}

#eventsBanner img {
    width: 220px;
    height: 130px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    transition: transform .25s;
}

#eventsBanner img:hover {
    transform: scale(1.04);
}

/* BADGES */
.badge { 
    display: inline-block;
    padding: 5px 8px;
    border-radius: 8px;
    color: #fff;
    font-weight: 700;
}
.badge.pending { background: #ff9800; }
.badge.paid { background: #28a745; }

/* MODAL */
.modal {
    display: none;
    position: fixed;
    inset: 0;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.45);
    z-index: 1300;
}

.modal.show {
    display: flex;
}

.modal-box {
    background: #fff;
    padding: 20px;
    border-radius: 10px;
    width: 360px;
    box-shadow: 0 8px 20px rgba(0,0,0,0.2);
    position: relative;
}

.close-x {
    position: absolute;
    right: 14px;
    top: 10px;
    cursor: pointer;
    font-size: 20px;
}

/* ----------------------------- */
/*         RESPONSIVE            */
/* ----------------------------- */

/* Tablet + Small Laptops */
@media (max-width: 900px) {
    .logo-area h1 {
        font-size: 1.1rem;
    }

    .col-4, .col-8 {
        grid-column: span 12;
    }

    #eventsBanner img {
        width: 160px;
        height: 100px;
    }
}

/* Phones */
@media (max-width: 600px) {
    header {
        padding: 10px 14px;
    }

    .logo-area img {
        height: 36px;
    }

    .logo-area h1 {
        font-size: 1rem;
    }

    .top-actions {
        gap: 6px;
    }

    .action-btn {
        padding: 7px 12px;
        font-size: 0.85rem;
    }

    main {
        padding: 14px;
    }

    .section {
        padding: 14px;
    }

    table th, table td {
        padding: 6px;
        font-size: 0.85rem;
    }

    #eventsBanner img {
        width: 140px;
        height: 90px;
    }
}



</style>
</head>
<body>

<!-- HEADER -->
<header>
  <div class="logo-area">
    <span style="font-size:22px;cursor:pointer;margin-right:6px" id="menuToggle">‚ò∞</span>
    <img src="logo.jpg" alt="logo">
    <h1>Acropolis ‚Äî Student</h1>
  </div>

  <div class="top-actions">
    <div id="mentorIdDisplay" style="color:#fff;margin-right:8px">Student</div>
    <button class="action-btn" id="logoutBtn">Logout</button>
  </div>
</header>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <h2 style="text-align:center;margin:0 0 12px 0;font-family:'Playfair Display',serif">Menu</h2>
  <a href="student-dashboard.html">üè† Dashboard</a>
  <a href="student-ass.html">üíª Assignments</a>
  <a href="notes-view.html">üóì üìöNOTES</a>
  <a href="exams.html">üìù Exams</a>
   <a href="marks-view.html">üèÜ results</a>
  <a href="notice-read.html?userType=students">üì∞ Notices</a>
    <a href="rules.html">üì∞   RULES</a>
    <a href="bus-view.html">üìö BUS</a>
      <a href="fees.html">üí∞ Fees</a>

  <a href="#" onclick="logout()">üö™ Logout</a>

    <a href="#" id="openFeesNav"></a>
</div>
<div class="backdrop" id="backdrop" onclick="closeSidebar()"></div>

<!-- MAIN -->
<main>
  <div class="grid">
    <!-- left -->
    <div class="col-4">
      <div class="section profile-box">
        <h2 id="studentName">Loading...</h2>
        <p><strong>Enrollment:</strong> <span id="studentEnrollment">‚Äî</span></p>
        <p><strong>Class:</strong> <span id="studentClass">‚Äî</span></p>
      </div>

      <div class="section" id="attendanceSection">
        <button id="refreshBtn">üîÑ Refresh</button>

        <h2 class="section-title">Attendance</h2>
        <p><strong>Total:</strong> <span id="attTotal">0</span></p>
        <p><strong>Present:</strong> <span id="attPresent">0</span></p>
        <p><strong>Percent:</strong> <span id="attPercent">0%</span></p>
      </div>

      <div class="section">
        <h2 class="section-title">Quick Actions</h2>
        <button class="action-btn" onclick="window.location.href='student-ass.html'">Assignments</button>
        <button class="action-btn" id="openFeesBtn">.</button>
             <button class="action-btn" onclick="window.location.href='fees.html'">fees</button>
        <button class="action-btn" onclick="window.location.href='timetable-view.html'">View Timetable</button>
      </div>
      
    </div>

    <!-- right -->
    <div class="col-8">
      <div id="eventsBanner" class="section"></div>
      

        <!-- Assignments Section -->
  <div class="section" id="assignmentsSection">
    <h2>Assignments</h2>
    <table id="assignmentsTable">
      <thead>
        <tr>
          <th>Title</th>
          <th>Subject</th>
          <th>Deadline</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>


      <div class="section" id="examsSection">
        <h2 class="section-title">Upcoming Exams</h2>
        <table>
          <thead><tr><th>Exam</th><th>Subject</th><th>Date</th><th>Room</th></tr></thead>
          <tbody id="examsBody">
            <tr><td colspan="4" style="text-align:center;color:#888">Loading exams...</td></tr>
          </tbody>
        </table>
      </div>
<!-- 
  üìÖ Timetable Section 
<div class="section" id="timetableSection">
  <h2>Class Timetable And Notes</h2>

  <label for="classSelect">Select Your Class:</label>
  <select id="classSelect">
    <option value="">-- Select Class --</option>
    <option>1A</option><option>1B</option>
    <option>2A</option><option>2B</option>
    <option>3A</option><option>3B</option>
    <option>4A</option><option>4B</option>
    <option>5A</option><option>5B</option>
    <option>6A</option><option>6B</option>
    <option>7A</option><option>7B</option>
    <option>8A</option><option>8B</option>
    <option>9A</option><option>9B</option>
    <option>10A</option><option>10B</option>
    <option>11A</option><option>11B</option>
    <option>12A</option><option>12B</option>
  </select>

  <button onclick="fetchTimetable()">View Timetable</button> -->
<h2>Class Notes & PDF Resources</h2>

<label for="yearSelect">Select Year:</label>
<select id="yearSelect">
  <option value="">-- Select Year --</option>
  <option value="1">1st Year</option>
  <option value="2nd Year">2nd Year</option>
  <option value="3rd Year">3rd Year</option>
  <option value="4th Year">4th Year</option>
  <option value="5th Year">5th Year</option>
</select>

<label for="branchSelect">Select Branch:</label>
<select id="branchSelect">
  <option value="">-- Select Branch --</option>
  <option value="CSE">CSE</option>
  <option value="IT">IT</option>
  <option value="ECE">ECE</option>
  <option value="ME">ME</option>
  <option value="CIVIL">CIVIL</option>
</select>

<label for="sectionSelect">Select Section:</label>
<select id="sectionSelect">
  <option value="">-- Select Section --</option>
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
</select>

<button onclick="fetchNotes()">View Notes & PDF</button>

<div id="notesContainer"></div>



  <div id="pdfContainer" style="margin-top:20px; text-align:center;">
    <p style="color:#666;">Select your class and click ‚ÄúView Timetable‚Äù to see the PDF.</p>
  </div>
</div>
<!-- Fees Modal -->
<div class="modal" id="feesModal" aria-hidden="true">
  <div class="modal-box">
    <span class="close-x" id="feesClose">&times;</span>
    <h3>Check Pending Fees</h3>
    <p>Enrollment</p>
    <input id="feeEnrollment" type="text" placeholder="Enter Enrollment" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd" />
    <button style="margin-top:10px;padding:10px 12px;border-radius:8px;background:#007bff;color:#fff;border:none;width:100%" id="checkFeeBtn">Check</button>
    <div id="feeResult" style="margin-top:12px"></div>
  </div>
</div>

<script>
/* ---------- Configuration ---------- */
const API_ROOT = "https://college-hwbb.onrender.com/"; // change if backend host is different
const API_TIMETABLES = `${API_ROOT}/api/timetables`;

/* ---------- UI helpers ---------- */
const sidebar = document.getElementById('sidebar');
const backdrop = document.getElementById('backdrop');
document.getElementById('menuToggle').addEventListener('click', ()=> {
  sidebar.classList.toggle('active'); backdrop.classList.toggle('active');
});
function closeSidebar(){ sidebar.classList.remove('active'); backdrop.classList.remove('active'); }
document.getElementById('logoutBtn').addEventListener('click', logout);
document.getElementById('openFeesBtn').addEventListener('click', openFeesModal);
document.getElementById('openFeesNav').addEventListener('click', openFeesModal);

/* ---------- Modal (fees) ---------- */
const feesModal = document.getElementById('feesModal');
const feesClose = document.getElementById('feesClose');
feesClose.addEventListener('click', closeFeesModal);
function openFeesModal(){ feesModal.classList.add('show'); document.getElementById('feeEnrollment').value = localStorage.getItem('enrollment') || ''; }
function closeFeesModal(){ feesModal.classList.remove('show'); document.getElementById('feeResult').innerHTML=''; }

/* ---------- Logout ---------- */
function logout(){ localStorage.removeItem('enrollment'); localStorage.removeItem('studentClass'); window.location.href='student-login.html'; }

/* ---------- Branch fees (example values; change as required) ---------- */
const branchFees = { "IT":140000, "CS":135000, "EC":130000, "ME":125000, "1A":50000, "1B":50000 };

/* ---------- Load functions ---------- */

async function loadStudentProfile(enrollment){
  try{
    const res = await fetch(`${API_ROOT}/api/students/${encodeURIComponent(enrollment)}/class`, {cache:'no-store'});
    if(!res.ok) throw new Error('Profile fetch failed');
    const data = await res.json();
    if(data.success && data.student){
      const s = data.student;
      document.getElementById('studentName').textContent = s.name || 'Student';
      document.getElementById('studentEnrollment').textContent = s.enrollment || enrollment;
      document.getElementById('studentClass').textContent = s.class || s.branch || '‚Äî';
      localStorage.setItem('studentClass', s.class || s.branch || '');
      localStorage.setItem('enrollment', s.enrollment || enrollment);
      document.getElementById('mentorIdDisplay').textContent = `Welcome`;
    } else {
      document.getElementById('studentName').textContent = 'Student';
      console.warn('Profile response:', data);
    }
  } catch(err){
    console.error('Error fetching profile:', err);
    document.getElementById('studentName').textContent = 'Student';
  }
}

// Attendance loader ‚Äî table-based version

  // üîπ Load attendance
 // üîπ Load attendance FROM LOCALSTORAGE (if exists)
function loadAttendanceFromCache() {
  const cached = localStorage.getItem("studentAttendance");
  if (!cached) return;

  const data = JSON.parse(cached);

  document.getElementById("attTotal").textContent = data.total || 0;
  document.getElementById("attPresent").textContent = data.present || 0;
  document.getElementById("attPercent").textContent = (data.percentage || 0) + "%";
}



// üîπ Fetch ATTENDANCE from backend & save to cache
async function fetchAttendance(enrollment) {
  try {
    const res = await fetch(`https://college-hwbb.onrender.com/api/attendance/student/${enrollment}`);
    const data = await res.json();

    if (res.ok && data.success) {

      // ‚ö° SAVE to localStorage
      localStorage.setItem("studentAttendance", JSON.stringify(data.attendance));

      // ‚ö° Update UI
      loadAttendanceFromCache();

    } else {
      console.warn("Attendance fetch failed");
    }
  } catch (err) {
    console.error("Error fetching attendance:", err);
  }
}

  

 // üîπ Load assignments
 // üîπ Load assignments (table version)
  // üîπ Load assignments
  async function loadAssignments(enrollment) {
    try {
      // 1Ô∏è‚É£ Get student class (from localStorage or fetch if missing)
      let studentClass = localStorage.getItem("studentClass");
      if (!studentClass) {
        const stuRes = await fetch(`https://college-hwbb.onrender.com/api/students/${enrollment}/class`);
        const stuData = await stuRes.json();

        // Backend may store class under 'class' or 'branch'
        studentClass = stuData?.student?.class || stuData?.student?.branch || "IT";

        // Save in localStorage for next time
        localStorage.setItem("studentClass", studentClass);
      }

      // Normalize class for backend
      const branch = normalizeClassName(studentClass);
      console.log("üì¶ Fetching assignments for class:", branch);

      // 2Ô∏è‚É£ Fetch assignments for this class
      const assignmentsRes = await fetch(`https://college-hwbb.onrender.com/api/assignments/class/${branch}`);
      if (!assignmentsRes.ok) throw new Error("Failed to fetch assignments");
      const assignmentsData = await assignmentsRes.json();

      // 3Ô∏è‚É£ Populate table
      const assignmentsTable = document.getElementById('assignmentsTable').querySelector('tbody');
      assignmentsTable.innerHTML = '';

      if (assignmentsData.success && Array.isArray(assignmentsData.assignments)) {
        const assignments = assignmentsData.assignments;

        if (assignments.length === 0) {
          assignmentsTable.innerHTML = `<tr><td colspan="4" style="text-align:center; color:gray;">No assignments posted yet</td></tr>`;
        } else {
          assignments.forEach(a => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${a.title || 'N/A'}</td>
              <td>${a.subject || 'N/A'}</td>
              <td>${a.deadline || 'N/A'}</td>
              <td>${a.status || 'Pending'}</td>
            `;
            assignmentsTable.appendChild(tr);
          });
        }
      } else {
        assignmentsTable.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">No assignments found</td></tr>`;
      }
    } catch (err) {
      console.error("Error fetching assignments:", err);
      const assignmentsTable = document.getElementById('assignmentsTable').querySelector('tbody');
      assignmentsTable.innerHTML = `<tr><td colspan="4" style="text-align:center; color:red;">Error fetching assignments</td></tr>`;
    }
  }

  // üîπ Normalize class name to match backend
  function normalizeClassName(str) {
    if (!str) return "IT";
    str = str.trim().toLowerCase();
str = str.replace(/[^a-z0-9]/g, '');  // remove spaces, dashes, special chars
str = str.replace(/st|nd|rd|th/g, ''); // remove ordinals
return str.toUpperCase();
               // backend expects uppercase, e.g. "1A", "IT"
  }


async function loadExams(){
  try{
    const res = await fetch(`${API_ROOT}/api/exams`, {cache:'no-store'});
    const data = await res.json();
    const tbody = document.getElementById('examsBody');
    tbody.innerHTML = '';
    if(res.ok && data.success && Array.isArray(data.exams) && data.exams.length>0){
      data.exams.forEach(e=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${e.examName||'Exam'}</td><td>${e.subject||'N/A'}</td><td>${e.date||'N/A'}</td><td>${e.room||'N/A'}</td>`;
        tbody.appendChild(tr);
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:#888">No upcoming exams</td></tr>`;
    }
  }catch(err){ console.error('Error fetching exams:', err); }
}

// // ‚úÖ Function to fetch timetable for selected class
// async function fetchTimetable() {
//   const className = document.getElementById("classSelect").value.trim();
//   const container = document.getElementById("pdfContainer");

//   if (!className) {
//     container.innerHTML = `<p style="color:#e11d48;">‚ö†Ô∏è Please select a class first.</p>`;
//     return;
//   }

//   container.innerHTML = `<p style="color:#666;">‚è≥ Fetching timetable for ${className}...</p>`;

//   try {
//     const res = await fetch(`${API_BASE}?class=${encodeURIComponent(className)}`);
//     const data = await res.json();

//     if (res.ok && data.success && data.timetables.length > 0) {
//       const fileUrl = `${API_BASE}/${data.timetables[0].timetableId}/file`;
//       container.innerHTML = `<iframe src="${fileUrl}" width="100%" height="600px" style="border-radius:8px;border:1px solid #ccc;"></iframe>`;
//     } else {
//       container.innerHTML = `<p style="color:#666;">‚ùå No timetable found for class <b>${className}</b>.</p>`;
//     }
//   } catch (err) {
//     console.error(err);
//     container.innerHTML = `<p style="color:#e11d48;">‚ö†Ô∏è Error fetching timetable. Check console for details.</p>`;
//   }
// }

// // ‚úÖ Optional: Auto-load function (to prevent console errors if called onload)
// // ‚úÖ Function to fetch timetable for selected class
// async function fetchTimetable() {
//   const className = document.getElementById("classSelect").value.trim();
//   const container = document.getElementById("pdfContainer");

//   if (!className) {
//     container.innerHTML = `<p style="color:#e11d48;">‚ö†Ô∏è Please select a class first.</p>`;
//     return;
//   }

//   container.innerHTML = `<p style="color:#666;">‚è≥ Fetching timetable for ${className}...</p>`;

//   try {
//     const res = await fetch(`${API_TIMETABLES}?class=${encodeURIComponent(className)}`);
//     const data = await res.json();

//     if (res.ok && data.success && data.timetables.length > 0) {
//       const fileUrl = `${API_TIMETABLES}/${data.timetables[0].timetableId}/file`;
//       container.innerHTML = `
//         <iframe src="${fileUrl}" width="100%" height="600px" 
//           style="border-radius:8px;border:1px solid #ccc;"></iframe>`;
//     } else {
//       container.innerHTML = `<p style="color:#666;">‚ùå No timetable found for class <b>${className}</b>.</p>`;
//     }
//   } catch (err) {
//     console.error(err);
//     container.innerHTML = `<p style="color:#e11d48;">‚ö†Ô∏è Error fetching timetable. Check console for details.</p>`;
//   }
// }

// // ‚úÖ Optional: prevents console error onload
// function loadTimetable() {
//   console.log("loadTimetable() called ‚Äî waiting for class selection");
// }

/// ‚úÖ Function to fetch notes/PDF for selected class (college version)
async function fetchNotes() {
  const year = document.getElementById("yearSelect").value;
  const branch = document.getElementById("branchSelect").value;
  const section = document.getElementById("sectionSelect").value;
  const container = document.getElementById("notesContainer");

  if(!year || !branch || !section){
    container.innerHTML = `<p style="color:#e11d48;">‚ö†Ô∏è Please select Year, Branch and Section first.</p>`;
    return;
  }

  // use the same normalizeClass as timetable
  function normalizeClass(year, branch, section){
    return (year + branch + section).toUpperCase(); // e.g., 1IT3
  }

  const className = normalizeClass(year, branch, section);

  container.innerHTML = `<p style="color:#666;">‚è≥ Fetching Notes/PDF for ${year} ${branch} ${section}...</p>`;

  try {
    const res = await fetch(`https://college-hwbb.onrender.com/api/assignments/class/${className}`);
    const data = await res.json();

    if(res.ok && data.success && data.assignments.length>0){
      container.innerHTML = '';
      data.assignments.forEach(a=>{
        const div = document.createElement("div");
        div.style.marginBottom="15px";
        div.innerHTML = `<p><strong>${a.title}</strong> (${a.subject}) - Deadline: ${a.deadline}</p>
                         <p>Class: ${a.class}</p><hr/>`;
        container.appendChild(div);
      });
    } else {
      container.innerHTML = `<p style="color:#666;">‚ùå No Notes/Assignments found for ${year} ${branch} ${section}</p>`;
    }

  } catch(err){
    console.error(err);
    container.innerHTML = `<p style="color:#e11d48;">‚ö†Ô∏è Error fetching Notes/Assignments. Check console.</p>`;
  }
}

// ‚úÖ Optional: prevents console error on load
function loadNotes() {
  console.log("loadNotes() called ‚Äî waiting for class selection");
}



/* Events banner (mentor-like) */
async function loadEventsBanner(){
  try{
    const res = await fetch(`${API_ROOT}/api/events`, {cache:'no-store'});
    const data = await res.json();
    const banner = document.getElementById('eventsBanner');
    banner.innerHTML = '';
    if(res.ok && data.success && Array.isArray(data.events) && data.events.length>0){
      data.events.forEach(ev=>{
        const img = document.createElement('img');
        img.src = ev.image || 'placeholder.jpg';
        img.alt = ev.title || 'Event';
        img.title = ev.title || '';
        img.addEventListener('click', ()=> window.location.href = `events.html?eventId=${ev.eventId || ''}`);
        banner.appendChild(img);
      });
    } else {
      banner.innerHTML = `<p style="color:#777">No upcoming events</p>`;
    }
  }catch(err){ console.error('Error loading events:', err); }
}

/* unread notice count */
async function loadUnreadCount(userType, enrollment){
  try{
    const res = await fetch(`${API_ROOT}/api/notices/get/${encodeURIComponent(userType)}`, {cache:'no-store'});
    const data = await res.json();
    if(res.ok && data.success && Array.isArray(data.notices)){
      const unread = data.notices.filter(n => !Array.isArray(n.readBy) || !n.readBy.includes(enrollment)).length;
      const badge = document.querySelector('.notice-badge') || null;
      if(badge) badge.textContent = unread;
      // also show in header
      const top = document.getElementById('mentorIdDisplay');
      if(top) top.textContent = `You have ${unread} unread notices`;
    }
  }catch(err){ console.error('Error loading notices:', err); }
}
document.getElementById("refreshBtn").addEventListener("click", refreshAllData);

async function refreshAllData() {
  const enrollment = localStorage.getItem("studentEnrollment");
  if (!enrollment) return alert("Enrollment not found!");

  await fetchProfile(enrollment);
  await fetchAttendance(enrollment);
  await fetchAssignments(enrollment);
  await fetchUpcomingExams(enrollment);

  localStorage.setItem("lastRefresh", Date.now());
  alert("Dashboard Updated!");
}

/* ---------- Init on load ---------- */
/* ---------- Init on load (FINAL MERGED VERSION) ---------- */
document.addEventListener('DOMContentLoaded', async () => {
  let enrollment = localStorage.getItem('enrollment');

  if (!enrollment) {
    enrollment = prompt('Enter enrollment to continue:');
    if (!enrollment) {
      alert('No enrollment provided');
      window.location.href = 'student-login.html';
      return;
    }
    localStorage.setItem('enrollment', enrollment);
  }

  try {
    // Basic student info
    await loadStudentProfile(enrollment);

    // UI elements
    loadEventsBanner();
    loadUnreadCount('students', enrollment);

    // Main modules
    await loadAttendance(enrollment);
    await loadAssignments(enrollment);
    await loadExams();
    await loadTimetable();
  } catch (err) {
    console.error("Error loading dashboard:", err);
  }
});
function loadDashboardFromCache() {
  loadProfile(localStorage.getItem("studentProfile"));
  loadAttendance(localStorage.getItem("studentAttendance"));
  loadAssignments(localStorage.getItem("studentAssignments"));
  loadUpcomingExams(localStorage.getItem("upcomingExams"));
}
window.onload = () => {
  loadAttendanceFromCache();  // Load old data instantly
};

/* close modal when clicking outside */
document.addEventListener('click', (e) => {
  if (e.target === feesModal) closeFeesModal();
});

</script>

</body>
</html>
