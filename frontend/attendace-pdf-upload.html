<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Upload Attendance PDF</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body {
    font-family: 'Inter', system-ui, sans-serif;
    margin: 0; padding: 20px;
    background: #f8fafc; color: #1e293b;
    display: flex; justify-content: center; align-items: center; min-height: 100vh;
}
.container {
    max-width: 480px; width: 100%; background: #fff;
    padding: 30px; border-radius: 16px;
    box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1), 0 10px 10px -5px rgba(0,0,0,0.04);
    position: relative; overflow: hidden;
}
/* Loader */
.loader-overlay {
    position: absolute; top:0; left:0; width:100%; height:100%;
    background: rgba(255,255,255,0.8); display: none;
    flex-direction: column; justify-content:center; align-items:center;
    z-index:10; backdrop-filter: blur(2px);
}
.spinner {
    width:40px; height:40px; border:4px solid #f3f3f3;
    border-top:4px solid #2563eb; border-radius:50%;
    animation:spin 1s linear infinite;
}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
/* UI */
.topbar { display:flex; justify-content:space-between; align-items:center; margin-bottom:25px; }
h2{margin:0;font-size:1.25rem;font-weight:700;}
.back-btn {
    background:#f1f5f9; color:#1e293b; padding:8px 14px;
    border-radius:8px; border:none; cursor:pointer; font-size:13px;
}
.back-btn:hover{background:#e2e8f0;}
.form-group{margin-bottom:18px;}
label{font-weight:600;margin-bottom:6px;display:block;font-size:14px;}
input, select{
    width:100%; padding:12px; border-radius:8px;
    border:1px solid #cbd5e1; font-size:14px; outline:none;
    box-sizing:border-box; transition:border-color 0.2s, box-shadow 0.2s;
}
input:focus, select:focus{border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,0.1);}
button.main-btn{
    width:100%; padding:14px; background:#2563eb; color:#fff;
    border:none; border-radius:10px; font-size:15px; font-weight:600; cursor:pointer;
}
button.main-btn:hover{background:#1d4ed8;}
button:disabled{opacity:0.6;cursor:not-allowed;}
.note{margin-top:20px;font-size:12px;color:#64748b;padding:10px;background:#f8fafc;border-radius:8px;border-left:4px solid #fbbf24;}
.status{margin-top:20px;text-align:center;font-size:14px;font-weight:600;min-height:20px;}
.success{color:#16a34a;background:#f0fdf4;padding:10px;border-radius:8px;}
.error{color:#dc2626;background:#fef2f2;padding:10px;border-radius:8px;}
</style>
</head>
<body>

<div class="container">
    <div id="loader" class="loader-overlay">
        <div class="spinner"></div>
        <p style="margin-top:10px;font-weight:600;font-size:14px;">Uploading PDF...</p>
    </div>

    <div class="topbar">
        <h2>üìÑ Upload Attendance</h2>
        <button class="back-btn" onclick="window.history.back()">‚¨Ö Back</button>
    </div>

    <div class="form-group">
        <label>Subject Name</label>
        <input type="text" id="subject" placeholder="Eg: Data Structures" required>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
        <div class="form-group">
            <label>Year</label>
            <select id="year">
                <option value="">Select</option>
                <option value="1">1st Year</option>
                <option value="2">2nd Year</option>
                <option value="3">3rd Year</option>
                <option value="4">4th Year</option>
            </select>
        </div>
        <div class="form-group">
            <label>Branch</label>
            <select id="branch">
                <option value="">Select</option>
                <option value="CSE1">CSE1</option>
                <option value="CSE2">CSE2</option>
                <option value="IT1">IT1</option>
                <option value="IT2">IT2</option>
            </select>
        </div>
    </div>

    <div class="form-group">
        <label>Select Week</label>
        <select id="week">
            <option value="">Choose Week</option>
            <option value="1">Week 1</option>
            <option value="2">Week 2</option>
            <option value="3">Week 3</option>
            <option value="4">Week 4</option>
        </select>
    </div>

    <div class="form-group">
        <label>Attendance PDF</label>
        <input type="file" id="pdfFile" accept="application/pdf">
    </div>

    <button id="uploadBtn" class="main-btn" onclick="uploadPDF()">Upload / Replace PDF</button>

    <div class="note"><b>Note:</b> Only one PDF per subject per week is allowed. Uploading a new file will replace the previous one.</div>

    <div id="status" class="status"></div>
</div>

<script>
/* ===================== TOKEN FROM ADMIN PANEL ===================== */
const mentorToken = localStorage.getItem("mentorToken"); // ‚úÖ existing admin token
const source = sessionStorage.getItem("accessSource");
const ALLOWED_SOURCES = ["ad","admin"];

if(!mentorToken || !ALLOWED_SOURCES.includes(source)){
    document.body.innerHTML = `
    <div style="text-align:center;padding:50px;">
        <h2 style="color:#dc2626">‚ùå Access Denied</h2>
        <p>Please open this page via the Administration Panel.</p>
    </div>`;
    throw new Error("Unauthorized access");
}

/* ================= UPLOAD FUNCTION ================= */
async function uploadPDF(){
    const subject = document.getElementById("subject").value.trim();
    const year    = document.getElementById("year").value;
    const branch  = document.getElementById("branch").value;
    const week    = document.getElementById("week").value;
    const file    = document.getElementById("pdfFile").files[0];

    const status = document.getElementById("status");
    const btn = document.getElementById("uploadBtn");
    const loader = document.getElementById("loader");

    status.textContent = ""; status.className="status";

    if(!subject || !year || !branch || !week || !file){
        status.textContent = "‚ùå Please fill all fields";
        status.className="status error";
        return;
    }

    if(file.type !== "application/pdf"){
        status.textContent = "‚ùå Only PDF files allowed";
        status.className="status error";
        return;
    }

    btn.disabled = true;
    loader.style.display = "flex";

    const formData = new FormData();
    formData.append("subject", subject);
    formData.append("year", year);
    formData.append("branch", branch);
    formData.append("week", week);
    formData.append("pdf", file);

    try {
        const res = await fetch("/api/attendance-pdf/upload", {
            method:"POST",
            headers:{
                "Authorization": `Bearer ${mentorToken}` // ‚úÖ using admin token
            },
            body: formData
        });

        let data;
        try { data = await res.json(); } 
        catch(e){ throw new Error("Invalid server response"); }

        if(!data.success){
            throw new Error(data.message || "Upload failed");
        }

        status.textContent = "‚úÖ Attendance PDF uploaded successfully";
        status.className = "status success";
        document.getElementById("pdfFile").value = "";

    } catch(err){
        console.error(err);
        status.textContent = "‚ùå Error: "+err.message;
        status.className="status error";
    } finally {
        btn.disabled=false;
        loader.style.display="none";
    }
}
</script>

</body>
</html>
