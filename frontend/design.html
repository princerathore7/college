<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Post Event - Mentor Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Roboto:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 0;
    background: #eef2f7;
    color: #333;
  }

  header {
    background: #4a90e2;
    color: white;
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  header h1 {
    margin: 0;
    font-size: 1.4rem;
  }

  .manage-btn {
    background: white;
    color: #4a90e2;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
  }

  .manage-btn:hover {
    background: #e6eef9;
    transform: translateY(-1px);
  }

  main {
    max-width: 900px;
    margin: 2rem auto;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  }

  label {
    display: block;
    margin: 0.5rem 0 0.2rem 0;
    font-weight: 600;
  }

  input[type="text"],
  input[type="date"],
  input[type="file"] {
    width: 100%;
    padding: 0.6rem;
    margin-bottom: 1rem;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  #description {
    width: 100%;
    min-height: 180px;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 0.5rem;
    overflow-y: auto;
  }

  .toolbar {
    margin-bottom: 0.5rem;
  }

  .toolbar button,
  .toolbar select,
  .toolbar input[type=color] {
    margin-right: 0.3rem;
    padding: 0.3rem 0.5rem;
    cursor: pointer;
  }

  button#postEvent {
    background: #4a90e2;
    color: white;
    padding: 0.8rem 1.2rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    width: 100%;
    margin-top: 1rem;
    font-size: 16px;
    transition: 0.3s;
  }

  button#postEvent:hover {
    background: #357ab8;
  }

  .preview-img {
    display: block;
    max-width: 150px;
    margin: 10px 0;
    border-radius: 8px;
  }
  .editor-btn {
  padding: 6px 10px;
  border: 1px solid #ccc;
  background: #f8f8f8;
  cursor: pointer;
  border-radius: 6px;
}
.editor-btn.active {
  background: #2563eb;
  color: #fff;
  border-color: #2563eb;
}

</style>
</head>

<body>

<header>
  <h1>Post New Event</h1>
  <button class="manage-btn" onclick="goToManage()">Manage Events</button>
</header>

<main>
  <label for="title">Event Title:</label>
  <input type="text" id="title" placeholder="Enter event title" required>

  <label for="image">Event Image:</label>
  <input type="file" id="imageFile" accept="image/*">
  <img id="previewImage" class="preview-img" style="display:none;">

  <label for="date">Event Date:</label>
  <input type="date" id="date">

  <label for="description">Event Description:</label>

 <div class="toolbar">
  <button type="button" id="btnBold" class="editor-btn"><b>B</b></button>
  <button type="button" id="btnItalic" class="editor-btn"><i>I</i></button>
  <button type="button" id="btnUnderline" class="editor-btn"><u>U</u></button>

  <select id="fontSizeSelect">
    <option value="">Font Size</option>
    <option value="2">Small</option>
    <option value="3">Normal</option>
    <option value="4">Large</option>
    <option value="5">Extra Large</option>
  </select>

  <select id="fontFamilySelect">
    <option value="">Font Family</option>
    <option value="Inter">Inter</option>
    <option value="Roboto">Roboto</option>
    <option value="Montserrat">Montserrat</option>
    <option value="Arial">Arial</option>
    <option value="Times New Roman">Times New Roman</option>
  </select>

  <input type="color" id="colorPicker">
</div>

   

  <div id="description" contenteditable="true"></div>

  <button id="postEvent">Post Event</button>

  <hr>
  <h3>Live Preview</h3>
  <div id="livePreview" style="border:1px solid #ccc; padding:10px; border-radius:6px;"></div>
</main>

<script>
/* ===============================
   ACCESS CONTROL ‚Äî ADMIN PANEL
================================ */
const mentorId  = localStorage.getItem("mentorId");
const fromAdmin = sessionStorage.getItem("accessSource");

if (!mentorId || fromAdmin !== "ad") {
  document.body.innerHTML = `
    <h2 style="text-align:center;margin-top:20vh;color:red">
      ‚ùå Access Denied <br>
      Please open this page from Administration Panel only
    </h2>
  `;
  throw new Error("Unauthorized access");
}

/* ===============================
   RICH TEXT EDITOR (ENHANCED)
================================ */
const editor = document.getElementById("description");

const btnBold = document.getElementById("btnBold");
const btnItalic = document.getElementById("btnItalic");
const btnUnderline = document.getElementById("btnUnderline");
const fontSizeSelect = document.getElementById("fontSizeSelect");
const fontFamilySelect = document.getElementById("fontFamilySelect");
const colorPicker = document.getElementById("colorPicker");

function exec(cmd, value = null) {
  editor.focus();
  document.execCommand(cmd, false, value);
  updateToolbarState();
}

btnBold.onclick = () => exec("bold");
btnItalic.onclick = () => exec("italic");
btnUnderline.onclick = () => exec("underline");

fontFamilySelect.onchange = e => exec("fontName", e.target.value);
fontSizeSelect.onchange = e => exec("fontSize", e.target.value);
colorPicker.onchange = e => exec("foreColor", e.target.value);

function updateToolbarState() {
  btnBold.classList.toggle("active", document.queryCommandState("bold"));
  btnItalic.classList.toggle("active", document.queryCommandState("italic"));
  btnUnderline.classList.toggle("active", document.queryCommandState("underline"));
}

document.addEventListener("selectionchange", () => {
  if (document.activeElement === editor) updateToolbarState();
});

/* WhatsApp / ChatGPT style */
editor.addEventListener("input", () => {
  let html = editor.innerHTML;

  html = html
    .replace(/\*(.*?)\*/g, "<b>$1</b>")
    .replace(/_(.*?)_/g, "<i>$1</i>")
    .replace(/~(.*?)~/g, "<u>$1</u>");

  editor.innerHTML = html;
  placeCaretAtEnd(editor);
  updatePreview();
});

function placeCaretAtEnd(el) {
  const range = document.createRange();
  const sel = window.getSelection();
  range.selectNodeContents(el);
  range.collapse(false);
  sel.removeAllRanges();
  sel.addRange(range);
}

/* ===============================
   IMAGE UPLOAD (UNCHANGED LOGIC)
================================ */
const imageFileInput = document.getElementById("imageFile");
const previewImage = document.getElementById("previewImage");
let uploadedImageUrl = "";

imageFileInput.addEventListener("change", async () => {
  const file = imageFileInput.files[0];
  if (!file) return;

  previewImage.style.display = "none";
  uploadedImageUrl = "";

  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", "events_photos");

  try {
    const res = await fetch("https://api.cloudinary.com/v1_1/deqqkiovg/image/upload", {
      method: "POST",
      body: formData
    });

    const data = await res.json();
    if (!data.secure_url) return alert("Image upload failed!");

    uploadedImageUrl = data.secure_url;
    previewImage.src = uploadedImageUrl;
    previewImage.style.display = "block";

    updatePreview();
  } catch (err) {
    alert("Image upload failed!");
  }
});

/* ===============================
   LIVE PREVIEW
================================ */
const titleInput = document.getElementById("title");
const dateInput = document.getElementById("date");
const livePreview = document.getElementById("livePreview");

function updatePreview() {
  livePreview.innerHTML = `
    ${uploadedImageUrl ? `<img src="${uploadedImageUrl}" style="max-width:100%;border-radius:6px;margin-bottom:10px;">` : ""}
    <h2>${titleInput.value}</h2>
    <p><strong>Date:</strong> ${dateInput.value}</p>
    <div>${editor.innerHTML}</div>
  `;
}

titleInput.addEventListener("input", updatePreview);
dateInput.addEventListener("input", updatePreview);

/* ===============================
   POST EVENT (‚ùå NO CHANGE)
================================ */
document.getElementById("postEvent").addEventListener("click", async () => {
  const title = titleInput.value.trim();
  const date = dateInput.value.trim();
  const description = editor.innerHTML.trim();

  if (!title || !description) return alert("Title and description are required!");
  if (!uploadedImageUrl) return alert("Please select and upload an image!");

  const payload = { title, date, description, image: uploadedImageUrl };

  try {
    const res = await fetch("https://college-hwbb.onrender.com/api/events", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (res.ok && data.success) {

      fetch("https://college-hwbb.onrender.com/api/notify/events", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          title: "üéâ New Event Posted!",
          body: title + " ‚Äî Tap to view details",
          url: "/events.html"
        })
      });

      alert("Event posted successfully!");

      titleInput.value = "";
      dateInput.value = "";
      editor.innerHTML = "";
      previewImage.style.display = "none";
      uploadedImageUrl = "";
      updatePreview();

    } else {
      alert(data.message || "Failed to post event");
    }

  } catch (err) {
    alert("Failed to post event due to server error.");
  }
});
</script>


</body>
</html>
