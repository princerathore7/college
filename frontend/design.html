<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Post Event - Mentor Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=Roboto:wght@400;700&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">

<style>
  body {
    font-family: 'Inter', sans-serif;
    margin: 0;
    padding: 0;
    background: #eef2f7;
    color: #333;
  }

  header {
    background: #4a90e2;
    color: white;
    padding: 1rem 2rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  header h1 {
    margin: 0;
    font-size: 1.4rem;
  }

  .manage-btn {
    background: white;
    color: #4a90e2;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: 600;
    cursor: pointer;
    transition: 0.3s;
  }

  .manage-btn:hover {
    background: #e6eef9;
    transform: translateY(-1px);
  }

  main {
    max-width: 900px;
    margin: 2rem auto;
    padding: 2rem;
    background: white;
    border-radius: 12px;
    box-shadow: 0 6px 18px rgba(0,0,0,0.12);
  }

  label {
    display: block;
    margin: 0.5rem 0 0.2rem 0;
    font-weight: 600;
  }

  input[type="text"],
  input[type="date"],
  input[type="file"] {
    width: 100%;
    padding: 0.6rem;
    margin-bottom: 1rem;
    border-radius: 6px;
    border: 1px solid #ccc;
  }

  #description {
    width: 100%;
    min-height: 180px;
    border: 1px solid #ccc;
    border-radius: 6px;
    padding: 0.5rem;
    overflow-y: auto;
  }

  .toolbar {
    margin-bottom: 0.5rem;
  }

  .toolbar button,
  .toolbar select,
  .toolbar input[type=color] {
    margin-right: 0.3rem;
    padding: 0.3rem 0.5rem;
    cursor: pointer;
  }

  button#postEvent {
    background: #4a90e2;
    color: white;
    padding: 0.8rem 1.2rem;
    border: none;
    border-radius: 6px;
    cursor: pointer;
    font-weight: 600;
    width: 100%;
    margin-top: 1rem;
    font-size: 16px;
    transition: 0.3s;
  }

  button#postEvent:hover {
    background: #357ab8;
  }

  .preview-img {
    display: block;
    max-width: 150px;
    margin: 10px 0;
    border-radius: 8px;
  }
</style>
</head>

<body>

<header>
  <h1>Post New Event</h1>
  <button class="manage-btn" onclick="goToManage()">Manage Events</button>
</header>

<main>
  <label for="title">Event Title:</label>
  <input type="text" id="title" placeholder="Enter event title" required>

  <label for="image">Event Image:</label>
  <input type="file" id="imageFile" accept="image/*">
  <img id="previewImage" class="preview-img" style="display:none;">

  <label for="date">Event Date:</label>
  <input type="date" id="date">

  <label for="description">Event Description:</label>

  <div class="toolbar">
    <button type="button" onclick="formatText('bold')"><b>B</b></button>
    <button type="button" onclick="formatText('italic')"><i>I</i></button>
    <button type="button" onclick="formatText('underline')"><u>U</u></button>

    <select onchange="changeFontSize(this.value)">
      <option value="">Font Size</option>
      <option value="1">Small</option>
      <option value="3">Normal</option>
      <option value="5">Large</option>
      <option value="7">Extra Large</option>
    </select>

    <select onchange="changeFont(this.value)">
      <option value="">Font Family</option>
      <option value="Inter">Inter</option>
      <option value="Roboto">Roboto</option>
      <option value="Montserrat">Montserrat</option>
      <option value="Arial">Arial</option>
      <option value="Times New Roman">Times New Roman</option>
    </select>

    <input type="color" onchange="changeColor(this.value)" title="Text color">
  </div>

  <div id="description" contenteditable="true"></div>

  <button id="postEvent">Post Event</button>

  <hr>
  <h3>Live Preview</h3>
  <div id="livePreview" style="border:1px solid #ccc; padding:10px; border-radius:6px;"></div>
</main>

<script>
  function goToManage() {
    window.location.href = "manage.html";
  }

  /* ------------------ RICH TEXT EDITOR ------------------ */
  function formatText(cmd) { document.execCommand(cmd, false, null); }
  function changeFontSize(size) { document.execCommand("fontSize", false, size); }
  function changeFont(font) { document.execCommand("fontName", false, font); }
  function changeColor(color) { document.execCommand("foreColor", false, color); }

  /* ------------------ IMAGE UPLOAD (CLOUDINARY) ------------------ */
  const imageFileInput = document.getElementById("imageFile");
  const previewImage = document.getElementById("previewImage");

  let uploadedImageUrl = "";

  imageFileInput.addEventListener("change", async () => {
    const file = imageFileInput.files[0];
    if (!file) return;

    previewImage.style.display = "none";
    uploadedImageUrl = "";

    const formData = new FormData();
    formData.append("file", file);
    formData.append("upload_preset", "events_photos");

    try {
      const res = await fetch("https://api.cloudinary.com/v1_1/deqqkiovg/image/upload", {
        method: "POST",
        body: formData
      });

      const data = await res.json();
      console.log("Cloudinary upload:", data);

      if (!data.secure_url) {
        alert("Image upload failed! No URL returned.");
        return;
      }

      uploadedImageUrl = data.secure_url;
      previewImage.src = uploadedImageUrl;
      previewImage.style.display = "block";

      updatePreview();

    } catch (err) {
      console.error("Cloudinary Upload Error:", err);
      alert("Image upload failed!");
    }
  });

  /* ------------------ LIVE PREVIEW ------------------ */
  const titleInput = document.getElementById("title");
  const dateInput = document.getElementById("date");
  const descInput = document.getElementById("description");
  const livePreview = document.getElementById("livePreview");

  function updatePreview() {
    livePreview.innerHTML = `
      ${uploadedImageUrl ? `<img src="${uploadedImageUrl}" style="max-width:100%; border-radius:6px; margin-bottom:10px;">` : ''}
      <h2>${titleInput.value}</h2>
      <p><strong>Date:</strong> ${dateInput.value}</p>
      <div>${descInput.innerHTML}</div>
    `;
  }

  titleInput.addEventListener("input", updatePreview);
  dateInput.addEventListener("input", updatePreview);
  descInput.addEventListener("input", updatePreview);

  /* ------------------ POST EVENT ‚Üí BACKEND ------------------ */
  document.getElementById("postEvent").addEventListener("click", async () => {
    const title = titleInput.value.trim();
    const date = dateInput.value.trim();
    const description = descInput.innerHTML.trim();

    if (!title || !description) {
      alert("Title and description are required!");
      return;
    }

    if (!uploadedImageUrl) {
      alert("Please select and upload an image!");
      return;
    }

    const payload = {
      title,
      date,
      description,
      image: uploadedImageUrl
    };

    try {
      /* 1Ô∏è‚É£ POST EVENT */
      const res = await fetch("https://college-hwbb.onrender.com/api/events", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      });

      const data = await res.json();
      console.log("Event post response:", data);

      if (res.ok && data.success) {

        /* 2Ô∏è‚É£ FIRE NOTIFICATION (EXTRA CALL) */
        fetch("https://college-hwbb.onrender.com/api/notify/events", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            title: "üéâ New Event Posted!",
            body: title + " ‚Äî Tap to view details",
            url: "/events.html"
          })
        }).catch(err => console.error("Notification error:", err));

        alert("Event posted successfully!");

        /* 3Ô∏è‚É£ RESET FORM */
        titleInput.value = "";
        dateInput.value = "";
        descInput.innerHTML = "";
        previewImage.src = "";
        previewImage.style.display = "none";
        uploadedImageUrl = "";

        updatePreview();

      } else {
        alert(data.message || "Failed to post event");
      }

    } catch (err) {
      console.error("Post Event Error:", err);
      alert("Failed to post event due to network/server error.");
    }
  });
</script>

</body>
</html>
