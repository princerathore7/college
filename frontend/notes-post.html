<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upload Notes ‚Äî Mentor Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body{font-family:Inter,sans-serif;background:#eef2f7;padding:30px}
.card{max-width:850px;background:#fff;margin:auto;padding:25px;border-radius:10px;box-shadow:0 4px 16px rgba(0,0,0,.1)}
label{font-weight:600;display:block;margin-top:12px}
input,select{width:100%;padding:10px;margin-top:5px;border:1px solid #ccc;border-radius:6px}
button{width:100%;padding:12px;margin-top:18px;background:#2563eb;color:#fff;border:none;border-radius:6px;cursor:pointer;font-size:15px;font-weight:600}
.note-item{border-bottom:1px solid #ddd;padding:12px;background:#f9f9f9;margin-top:12px;border-radius:6px}
.action-btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer}
.view{background:#16a34a;color:#fff}
.delete{background:#dc2626;color:#fff;margin-left:6px}

.top-actions{display:flex;gap:10px;margin-bottom:15px}
.top-actions button{width:auto}

#myNotesModal{
  display:none;position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.4);z-index:1000
}
.modal-box{
  background:#fff;max-width:600px;margin:10vh auto;padding:20px;
  border-radius:8px
}
</style>
</head>

<body>

<div class="card">
<h2>Upload Notes / Assignments</h2>

<div class="top-actions">
  <button onclick="openMyNotes()">üìÅ My Posted Notes</button>
  <input id="searchInput" placeholder="üîç Search by title or class">
</div>

<label>Title</label>
<input id="title">

<label>Subject</label>
<input id="subject">

<label>Deadline</label>
<input type="date" id="deadline">

<label>Year</label>
<select id="year">
<option value="">--select--</option>
<option value="1">1st</option>
<option value="2">2nd</option>
<option value="3">3rd</option>
<option value="4">4th</option>
</select>

<label>Branch</label>
<select id="branch">
<option value="CSE">CSE</option><option value="IT">IT</option>
<option value="ECE">ECE</option><option value="ME">ME</option>
<option value="CE">CE</option>
</select>

<label>Section</label>
<select id="section">
<option value="">--select--</option>
<option>1</option><option>2</option><option>3</option>
</select>

<label>PDF</label>
<input type="file" id="file" accept="application/pdf">

<button onclick="uploadNote()">Upload</button>

<hr>

<h3>Uploaded Notes</h3>
<div id="notesList"></div>
</div>

<!-- MY NOTES MODAL -->
<div id="myNotesModal">
  <div class="modal-box">
    <h3>My Posted Notes</h3>
    <div id="myNotesList"></div>
    <button onclick="closeMyNotes()">Close</button>
  </div>
</div>

<script>
const API="https://college-hwbb.onrender.com/api/notes";
const MY_KEY="my_posted_notes";
const CLASS_KEY="last_class";

/* ACCESS CONTROL */
const mentorId=localStorage.getItem("mentorId");
const source=sessionStorage.getItem("accessSource");
if(!mentorId||!["ad","admin"].includes(source)){
  document.body.innerHTML="<h2>Access Denied</h2>";throw 0;
}

function normalizeClass(y,b,s){return(y+b+s).toUpperCase()}

/* SAVE LAST CLASS */
["year","branch","section"].forEach(id=>{
  document.getElementById(id).addEventListener("change",()=>{
    localStorage.setItem(CLASS_KEY,JSON.stringify({
      year:year.value,branch:branch.value,section:section.value
    }))
  })
})

/* LOAD LAST CLASS */
const saved=JSON.parse(localStorage.getItem(CLASS_KEY)||"{}");
if(saved.year)year.value=saved.year;
if(saved.branch)branch.value=saved.branch;
if(saved.section)section.value=saved.section;

async function uploadNote(){
  const title=titleInput=title.value.trim();
  if(!title||!subject.value||!year.value||!branch.value||!section.value||!file.files[0]) return alert("Fill all");

  const form=new FormData();
  form.append("title",title);
  form.append("subject",subject.value);
  form.append("deadline",deadline.value);
  form.append("class",normalizeClass(year.value,branch.value,section.value));
  form.append("file",file.files[0]);

  const res=await fetch(API,{method:"POST",body:form});
  const data=await res.json();
  if(data.success){
    const mine=JSON.parse(localStorage.getItem(MY_KEY)||"[]");
    mine.push(data.noteId);
    localStorage.setItem(MY_KEY,JSON.stringify(mine));
    loadNotes();
  }
}

async function loadNotes(){
  const res=await fetch(API);
  const data=await res.json();
  window.ALL=data.notes||[];
  renderNotes(ALL);
}

function renderNotes(list){
  notesList.innerHTML="";
  list.forEach(n=>{
    notesList.innerHTML+=`
    <div class="note-item">
      <strong>${n.title}</strong><br>
      <small>${n.class}</small><br>
      <button class="action-btn view" onclick="openPDF('${n.file_url}')">View</button>
    </div>`
  })
}

/* SEARCH */
searchInput.oninput=()=>{
  const q=searchInput.value.toLowerCase();
  renderNotes(ALL.filter(n=>
    n.title.toLowerCase().includes(q)||n.class.toLowerCase().includes(q)
  ))
}

/* MY NOTES */
function openMyNotes(){
  const mine=JSON.parse(localStorage.getItem(MY_KEY)||"[]");
  myNotesList.innerHTML="";
  ALL.filter(n=>mine.includes(n.noteId)).forEach(n=>{
    myNotesList.innerHTML+=`
    <div class="note-item">
      <strong>${n.title}</strong>
      <button class="action-btn delete" onclick="deleteMine('${n.noteId}')">Delete</button>
    </div>`
  })
  myNotesModal.style.display="block";
}
function closeMyNotes(){myNotesModal.style.display="none"}

async function deleteMine(id){
  await fetch(API+"/"+id,{method:"DELETE"});
  let mine=JSON.parse(localStorage.getItem(MY_KEY)||"[]");
  mine=mine.filter(x=>x!==id);
  localStorage.setItem(MY_KEY,JSON.stringify(mine));
  loadNotes();openMyNotes();
}

function openPDF(u){window.open(u+"?fl_attachment=false","_blank")}

loadNotes();
</script>

</body>
</html>
