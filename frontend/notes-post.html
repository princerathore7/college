<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upload Notes â€” Mentor Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body { font-family: Inter, sans-serif; background:#eef2f7; padding:30px; }

.card {
  max-width:900px;
  background:#fff;
  margin:auto;
  padding:25px;
  border-radius:12px;
  box-shadow:0 6px 20px rgba(0,0,0,.1);
}

label { font-weight:600; display:block; margin-top:12px; }
input, select {
  width:100%; padding:10px; margin-top:5px;
  border:1px solid #ccc; border-radius:6px;
}

button {
  width:100%; padding:12px; margin-top:18px;
  background:#2563eb; color:#fff;
  border:none; border-radius:6px;
  cursor:pointer; font-size:15px; font-weight:600;
}

.note-item {
  border-bottom:1px solid #ddd;
  padding:12px; background:#f9f9f9;
  margin-top:12px; border-radius:6px;
}

.action-btn {
  padding:6px 12px;
  border:none; border-radius:6px;
  cursor:pointer; margin-top:6px;
}
.view { background:#16a34a; color:#fff; }
.delete { background:#dc2626; color:#fff; margin-left:6px; }

.top-actions { display:flex; gap:10px; margin-bottom:15px; }

.modal {
  position:fixed; inset:0;
  background:rgba(0,0,0,.5);
  display:none; align-items:center; justify-content:center;
}

.modal-content {
  background:#fff; padding:20px;
  width:90%; max-width:600px;
  border-radius:12px;
}

.close { float:right; cursor:pointer; font-weight:bold; }

/* ===== UPLOADING OVERLAY ===== */
#uploadOverlay {
  position:fixed; inset:0;
  background:rgba(255,255,255,.9);
  display:none;
  align-items:center;
  justify-content:center;
  flex-direction:column;
  z-index:1000;
}

.progress-circle {
  width:120px; height:120px;
  border-radius:50%;
  border:8px solid #e5e7eb;
  border-top-color:#2563eb;
  animation:spin 1s linear infinite;
}

@keyframes spin { to{ transform:rotate(360deg);} }

.progress-text {
  margin-top:15px;
  font-size:22px;
  font-weight:600;
  color:#2563eb;
}

.success {
  display:none;
  text-align:center;
}

.success svg {
  width:90px;
  fill:#22c55e;
}

.success h3 {
  margin-top:12px;
  color:#16a34a;
}
</style>
</head>
<body>

<div class="card">
<h2>Upload Notes / Assignments</h2>

<div class="top-actions">
  <input id="searchInput" placeholder="ðŸ” Search by title / subject / class">
  <button onclick="openMyNotes()">ðŸ“Œ My Posted Notes</button>
</div>

<label>Title</label>
<input id="title">

<label>Subject</label>
<input id="subject">

<label>Deadline (Optional)</label>
<input type="date" id="deadline">

<label>Select Year</label>
<select id="year">
  <option value="">-- select year --</option>
  <option value="1">1st Year</option>
  <option value="2">2nd Year</option>
  <option value="3">3rd Year</option>
  <option value="4">4th Year</option>
</select>

<label>Select Branch</label>
<select id="branch">
  <option value="CSE">CSE</option>
  <option value="IT">IT</option>
  <option value="ECE">ECE</option>
  <option value="ME">ME</option>
  <option value="CE">CE</option>
  <option value="CSE">CSE - Computer Science Engineering</option>
<option value="IT">IT - Information Technology</option>
<option value="AIML">AIML - Artificial Intelligence & Machine Learning</option>
<option value="AIDS">AIDS - Artificial Intelligence & Data Science</option>
<option value="CSBS">CSBS - Computer Science & Business Systems</option>
<option value="IOT">IoT - Internet of Things</option>

<option value="ECE">ECE - Electronics & Communication</option>
<option value="EEE">EEE - Electrical & Electronics</option>
<option value="EE">EE - Electrical Engineering</option>

<option value="ME">ME - Mechanical Engineering</option>
<option value="AU">AU - Automobile Engineering</option>
<option value="MT">MT - Mechatronics</option>

<option value="CE">CE - Civil Engineering</option>
<option value="CHE">CHE - Chemical Engineering</option>
<option value="MIN">MIN - Mining Engineering</option>
<option value="PET">PET - Petroleum Engineering</option>

<option value="BT">BT - Biotechnology</option>
<option value="BME">BME - Biomedical Engineering</option>

<option value="FT">FT - Food Technology</option>
<option value="AG">AG - Agriculture Engineering</option>

<option value="ENV">ENV - Environmental Engineering</option>
<option value="TX">TX - Textile Engineering</option>

<option value="PIE">PIE - Production & Industrial Engineering</option>
<option value="IM">IM - Industrial Management</option>
<option value="DPHARMA">D.Pharmacy</option>
<option value="BPHARMA">B.Pharmacy</option>
<option value="MPHARMA">M.Pharmacy</option>
<option value="PHARMA-CHEM">Pharmaceutical Chemistry</option>
<option value="PHARMA-ANALYTICAL">Pharmaceutical Analysis</option>
<option value="PHARMA-QUALITY">Quality Assurance</option>
<option value="PHARMA-PHARMACO">Pharmacology</option>
<option value="PHARMA-PHARMACEUTICS">Pharmaceutics</option>
<option value="PHARMA-BIOTECH">Pharmaceutical Biotechnology</option>
<option value="PHARMA-REGULATORY">Regulatory Affairs</option>
<option value="DCSE">Diploma - Computer Science Engineering</option>
<option value="DIT">Diploma - Information Technology</option>
<option value="DCYBER">Diploma - Cyber Security</option>

<option value="DECE">Diploma - Electronics & Communication Engineering</option>
<option value="DEEE">Diploma - Electrical & Electronics Engineering</option>
<option value="DEE">Diploma - Electrical Engineering</option>

<option value="DME">Diploma - Mechanical Engineering</option>
<option value="DCE">Diploma - Civil Engineering</option>
<option value="DMIN">Diploma - Mining Engineering</option>

<option value="DCHE">Diploma - Chemical Engineering</option>
<option value="DAG">Diploma - Agriculture Engineering</option>
<option value="DTX">Diploma - Textile Technology</option>
<option value="DPLASTIC">Diploma - Plastic Engineering</option>
<option value="DPOLY">Diploma - Polymer Engineering</option>

</select>

<label>Select Section</label>
<select id="section">
  <option value="">-- select section --</option>
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
    <option value="4">4</option>
      <option value="5">5</option>
</select>

<label>Upload PDF File</label>
<input type="file" id="file" accept="application/pdf">

<button onclick="uploadNote()">Upload</button>

<hr style="margin:25px 0;">

<h3>Uploaded Notes (All)</h3>
<div id="notesList"></div>
</div>

<!-- MY NOTES MODAL -->
<div class="modal" id="myNotesModal">
  <div class="modal-content">
    <span class="close" onclick="closeMyNotes()">âœ–</span>
    <h3>ðŸ“Œ My Posted Notes</h3>
    <div id="myNotesList"></div>
  </div>
</div>

<!-- UPLOADING OVERLAY -->
<div id="uploadOverlay">
  <div class="progress-circle"></div>
  <div class="progress-text" id="progressText">0%</div>

  <div class="success" id="successBox">
    <svg viewBox="0 0 24 24">
      <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
    </svg>
    <h3>Upload Successful</h3>
  </div>
</div>

<script>
const API="https://college-hwbb.onrender.com/api/notes";
const LS_NOTES="my_posted_notes";
const LS_CLASS="last_selected_class";

/* ACCESS */
const mentorId=localStorage.getItem("mentorId");
const source=sessionStorage.getItem("accessSource");
if(!mentorId||!["ad","admin"].includes(source)){
  document.body.innerHTML="<h2 style='color:red;text-align:center'>Access Denied</h2>";
  throw "";
}

function normalizeClass(y,b,s){ return (y+b+s).toUpperCase(); }

/* AUTO CLASS */
window.onload=()=>{
  const c=JSON.parse(localStorage.getItem(LS_CLASS)||"{}");
  if(c.year){year.value=c.year;branch.value=c.branch;section.value=c.section;}
  loadNotes();
};

const overlay=document.getElementById("uploadOverlay");
const progressText=document.getElementById("progressText");
const successBox=document.getElementById("successBox");

/* ================= UPLOAD NOTE ================= */
async function uploadNote(){

  const titleVal   = document.getElementById("title").value.trim();
  const subjectVal = document.getElementById("subject").value.trim();
  const y = year.value;
  const b = branch.value;
  const s = section.value;
  const fileObj = document.getElementById("file").files[0];

  if(!titleVal || !subjectVal || !y || !b || !s || !fileObj){
    alert("Fill all fields");
    return;
  }

  const cls = normalizeClass(y, b, s);
  localStorage.setItem(LS_CLASS, JSON.stringify({year:y, branch:b, section:s}));

  const form = new FormData();
  form.append("title", titleVal);
  form.append("subject", subjectVal);
  form.append("deadline", deadline.value);
  form.append("class", cls);
  form.append("file", fileObj);

  overlay.style.display = "flex";
  successBox.style.display = "none";

  let percent = 0;
  const fakeProgress = setInterval(()=>{
    percent += Math.floor(Math.random()*8);
    if(percent > 95) percent = 95;
    progressText.innerText = percent + "%";
  }, 200);

  try{
    const res  = await fetch(API, { method:"POST", body: form });
    const data = await res.json();
    clearInterval(fakeProgress);

    progressText.innerText = "100%";

    if(data.success){

      setTimeout(()=>{
        document.querySelector(".progress-circle").style.display = "none";
        progressText.style.display = "none";
        successBox.style.display = "block";
      }, 400);

      setTimeout(()=>{
        overlay.style.display = "none";
        document.querySelector(".progress-circle").style.display = "block";
        progressText.style.display = "block";
        progressText.innerText = "0%";

        saveMyNote(data.noteId, titleVal, subjectVal, cls);
        loadNotes();
      }, 1400);

    }else{
      overlay.style.display = "none";
      alert(data.message);
    }

  }catch(err){
    clearInterval(fakeProgress);
    overlay.style.display = "none";
    alert("Upload failed");
  }
}

/* STORAGE */
function saveMyNote(id,title,subject,cls){
  const arr=JSON.parse(localStorage.getItem(LS_NOTES)||"[]");
  arr.push({id,title,subject,class:cls});
  localStorage.setItem(LS_NOTES,JSON.stringify(arr));
}

/* LOAD NOTES */
let ALL_NOTES=[];
async function loadNotes(){
  const res=await fetch(API);
  const data=await res.json();
  ALL_NOTES=data.notes||[];
  renderNotes(ALL_NOTES);
}

function renderNotes(list){
  notesList.innerHTML="";
  if(!list.length){notesList.innerHTML="<p>No notes uploaded.</p>";return;}
  list.forEach(n=>{
    notesList.innerHTML+=`
      <div class="note-item">
        <strong>${n.title}</strong><br>
        <small>${n.subject} â€¢ Class: ${n.class}</small><br>
        <button class="action-btn view" onclick="openPDF('${n.file_url}')">View</button>
        <button class="action-btn delete" onclick="deleteNote('${n.noteId}')">Delete</button>
      </div>`;
  });
}

/* SEARCH */
searchInput.oninput=function(){
  const q=this.value.toLowerCase();
  renderNotes(ALL_NOTES.filter(n=>
    n.title.toLowerCase().includes(q)||
    n.subject.toLowerCase().includes(q)||
    n.class.toLowerCase().includes(q)
  ));
};

/* MODAL */
function openMyNotes(){
  myNotesModal.style.display="flex";
  const arr=JSON.parse(localStorage.getItem(LS_NOTES)||"[]");
  myNotesList.innerHTML="";
  arr.forEach(n=>{
    myNotesList.innerHTML+=`
      <div class="note-item">
        <strong>${n.title}</strong><br>
        <small>${n.subject} â€¢ ${n.class}</small><br>
        <button class="action-btn delete" onclick="deleteNote('${n.id}',true)">Delete</button>
      </div>`;
  });
}
function closeMyNotes(){ myNotesModal.style.display="none"; }

/* DELETE */
/* ================= DELETE NOTE ================= */
async function deleteNote(id, fromMine = false){

  if(!confirm("Delete this note?")) return;

  try{
    const res  = await fetch(`${API}/${id}`, { method:"DELETE" });
    const data = await res.json();

    if(data.success){

      if(fromMine){
        let arr = JSON.parse(localStorage.getItem(LS_NOTES) || "[]");
        arr = arr.filter(n => n.id !== id);
        localStorage.setItem(LS_NOTES, JSON.stringify(arr));
        openMyNotes();
      }

      loadNotes();

    }else{
      alert(data.message || "Delete failed");
    }

  }catch(err){
    alert("Server error while deleting note");
  }
}


function openPDF(url){
  window.open(url+"?fl_attachment=false","_blank");
}
</script>

</body>
</html>
