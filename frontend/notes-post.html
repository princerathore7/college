<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upload Notes â€” Mentor Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
body { font-family: Inter, sans-serif; background:#eef2f7; padding:30px; }
.card { max-width:900px; background:#fff; margin:auto; padding:25px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,0.1); }
label { font-weight:600; display:block; margin-top:12px; }
input, select { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:6px; }
button { width:100%; padding:12px; margin-top:18px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:15px; font-weight:600; }
.note-item { border-bottom:1px solid #ddd; padding:12px; background:#f9f9f9; margin-top:12px; border-radius:6px; }
.action-btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; margin-top:6px; }
.view { background:#16a34a; color:#fff; }
.delete { background:#dc2626; color:#fff; margin-left:6px; }
.top-actions{ display:flex; gap:10px; margin-bottom:15px; }
.modal{ position:fixed; inset:0; background:rgba(0,0,0,0.5); display:none; align-items:center; justify-content:center; }
.modal-content{ background:#fff; padding:20px; width:90%; max-width:600px; border-radius:10px; }
.close{ float:right; cursor:pointer; font-weight:bold; }
#uploadingOverlay { position:fixed; inset:0; background:rgba(0,0,0,0.3); display:none; align-items:center; justify-content:center; font-size:20px; font-weight:bold; color:#fff; }
</style>
</head>
<body>

<div class="card">
<h2>Upload Notes / Assignments</h2>

<div class="top-actions">
  <input id="searchInput" placeholder="ðŸ” Search by title / subject / class">
  <button onclick="openMyNotes()">ðŸ“Œ My Posted Notes</button>
</div>

<label>Title</label>
<input type="text" id="title">

<label>Subject</label>
<input type="text" id="subject">

<label>Deadline (Optional)</label>
<input type="date" id="deadline">

<label>Select Year</label>
<select id="year">
  <option value="">-- select year --</option>
  <option value="1">1st Year</option>
  <option value="2">2nd Year</option>
  <option value="3">3rd Year</option>
  <option value="4">4th Year</option>
</select>

<label>Select Branch</label>
<select id="branch">
 <option value="CSE">CSE - Computer Science Engineering</option>
<option value="IT">IT - Information Technology</option>
<option value="ECE">ECE - Electronics & Communication</option>
<option value="ME">ME - Mechanical Engineering</option>
<option value="CE">CE - Civil Engineering</option>
<option value="CSE">CSE - Computer Science Engineering</option>
<option value="IT">IT - Information Technology</option>
<option value="AIML">AIML - Artificial Intelligence & Machine Learning</option>
<option value="AIDS">AIDS - Artificial Intelligence & Data Science</option>
<option value="CSBS">CSBS - Computer Science & Business Systems</option>
<option value="IOT">IoT - Internet of Things</option>

<option value="ECE">ECE - Electronics & Communication</option>
<option value="EEE">EEE - Electrical & Electronics</option>
<option value="EE">EE - Electrical Engineering</option>

<option value="ME">ME - Mechanical Engineering</option>
<option value="AU">AU - Automobile Engineering</option>
<option value="MT">MT - Mechatronics</option>

<option value="CE">CE - Civil Engineering</option>
<option value="CHE">CHE - Chemical Engineering</option>
<option value="MIN">MIN - Mining Engineering</option>
<option value="PET">PET - Petroleum Engineering</option>

<option value="BT">BT - Biotechnology</option>
<option value="BME">BME - Biomedical Engineering</option>

<option value="FT">FT - Food Technology</option>
<option value="AG">AG - Agriculture Engineering</option>

<option value="ENV">ENV - Environmental Engineering</option>
<option value="TX">TX - Textile Engineering</option>

<option value="PIE">PIE - Production & Industrial Engineering</option>
<option value="IM">IM - Industrial Management</option>
<option value="DPHARMA">D.Pharmacy</option>
<option value="BPHARMA">B.Pharmacy</option>
<option value="MPHARMA">M.Pharmacy</option>
<option value="PHARMA-CHEM">Pharmaceutical Chemistry</option>
<option value="PHARMA-ANALYTICAL">Pharmaceutical Analysis</option>
<option value="PHARMA-QUALITY">Quality Assurance</option>
<option value="PHARMA-PHARMACO">Pharmacology</option>
<option value="PHARMA-PHARMACEUTICS">Pharmaceutics</option>
<option value="PHARMA-BIOTECH">Pharmaceutical Biotechnology</option>
<option value="PHARMA-REGULATORY">Regulatory Affairs</option>
<option value="DCSE">Diploma - Computer Science Engineering</option>
<option value="DIT">Diploma - Information Technology</option>
<option value="DCYBER">Diploma - Cyber Security</option>

<option value="DECE">Diploma - Electronics & Communication Engineering</option>
<option value="DEEE">Diploma - Electrical & Electronics Engineering</option>
<option value="DEE">Diploma - Electrical Engineering</option>

<option value="DME">Diploma - Mechanical Engineering</option>
<option value="DCE">Diploma - Civil Engineering</option>
<option value="DMIN">Diploma - Mining Engineering</option>

<option value="DCHE">Diploma - Chemical Engineering</option>
<option value="DAG">Diploma - Agriculture Engineering</option>
<option value="DTX">Diploma - Textile Technology</option>
<option value="DPLASTIC">Diploma - Plastic Engineering</option>
<option value="DPOLY">Diploma - Polymer Engineering</option>


</select>

<label>Select Section</label>
<select id="section">
  <option value="">-- select section --</option>
  <option value="1">1</option>
  <option value="2">2</option>
  <option value="3">3</option>
  <option value="4">4</option>
  <option value="5">5</option>
</select>

<label>Upload PDF File</label>
<input type="file" id="file" accept="application/pdf">

<button onclick="uploadNote()">Upload</button>

<hr style="margin:25px 0;">

<h3>Uploaded Notes (All)</h3>
<div id="notesList"></div>
</div>

<!-- MY NOTES MODAL -->
<div class="modal" id="myNotesModal">
  <div class="modal-content">
    <span class="close" onclick="closeMyNotes()">âœ–</span>
    <h3>ðŸ“Œ My Posted Notes</h3>
    <div id="myNotesList"></div>
  </div>
</div>

<div id="uploadingOverlay">Uploading...</div>

<script>
const API = "https://college-hwbb.onrender.com/api/notes";
const LS_NOTES = "my_posted_notes";
const LS_CLASS = "last_selected_class";

/* ACCESS CONTROL */
const mentorId = localStorage.getItem("mentorId");
const source = sessionStorage.getItem("accessSource");
if(!mentorId || !["ad","admin"].includes(source)){
  document.body.innerHTML="<h2 style='color:red;text-align:center'>Access Denied</h2>";
  throw "";
}

function normalizeClass(y,b,s){ return (y+b+s).toUpperCase(); }

/* AUTO FILL LAST CLASS */
window.onload = ()=>{
  const c = JSON.parse(localStorage.getItem(LS_CLASS) || "{}");
  if(c.year) year.value=c.year, branch.value=c.branch, section.value=c.section;
  loadNotes();
};

const uploadingOverlay = document.getElementById("uploadingOverlay");

/* UPLOAD */
async function uploadNote(){
  const title=document.getElementById("title").value.trim();
  const subject=document.getElementById("subject").value.trim();
  const deadline=document.getElementById("deadline").value;
  const yearVal=document.getElementById("year").value;
  const branchVal=document.getElementById("branch").value;
  const sectionVal=document.getElementById("section").value;
  const file=document.getElementById("file").files[0];

  if(!title || !subject || !yearVal || !branchVal || !sectionVal || !file){
    alert("Fill all fields");
    return;
  }

  const className = normalizeClass(yearVal,branchVal,sectionVal);
  localStorage.setItem(LS_CLASS, JSON.stringify({year:yearVal, branch:branchVal, section:sectionVal}));

  const form = new FormData();
  form.append("title", title);
  form.append("subject", subject);
  form.append("deadline", deadline);
  form.append("class", className);
  form.append("file", file);

  try{
    uploadingOverlay.style.display="flex";
    const res = await fetch(API, { method:"POST", body:form });
    const data = await res.json();
    uploadingOverlay.style.display="none";

    if(data.success){
      saveMyNote(data.noteId,title,subject,className);
      loadNotes();
    } else alert(data.message);
  }catch(e){
    uploadingOverlay.style.display="none";
    alert("Upload failed!");
  }
}

/* LOCAL STORAGE MY NOTES */
function saveMyNote(id,title,subject,cls){
  const arr = JSON.parse(localStorage.getItem(LS_NOTES)||"[]");
  arr.push({id,title,subject,class:cls});
  localStorage.setItem(LS_NOTES,JSON.stringify(arr));
}

/* LOAD ALL NOTES */
let ALL_NOTES = [];
async function loadNotes(){
  const res = await fetch(API);
  const data = await res.json();
  ALL_NOTES = data.notes || [];
  renderNotes(ALL_NOTES);
}

function renderNotes(list){
  const container = document.getElementById("notesList");
  container.innerHTML="";
  if(list.length===0){ container.innerHTML="<p>No notes uploaded.</p>"; return; }
  list.forEach(n=>{
    container.innerHTML += `
      <div class="note-item">
        <strong>${n.title}</strong><br>
        <small>${n.subject} â€¢ Class: ${n.class}</small><br>
        <button class="action-btn view" onclick="openPDF('${n.file_url}')">View</button>
        <button class="action-btn delete" onclick="deleteNote('${n.noteId}')">Delete</button>
      </div>
    `;
  });
}

/* SEARCH */
document.getElementById("searchInput").oninput = function(){
  const q = this.value.toLowerCase();
  renderNotes(ALL_NOTES.filter(n=>
    n.title.toLowerCase().includes(q) ||
    n.subject.toLowerCase().includes(q) ||
    n.class.toLowerCase().includes(q)
  ));
};

/* MY NOTES MODAL */
function openMyNotes(){
  const modal = document.getElementById("myNotesModal");
  const listEl = document.getElementById("myNotesList");
  modal.style.display="flex";
  const arr = JSON.parse(localStorage.getItem(LS_NOTES)||"[]");
  listEl.innerHTML="";
  arr.forEach(n=>{
    listEl.innerHTML+=`
      <div class="note-item">
        <strong>${n.title}</strong><br>
        <small>${n.subject} â€¢ ${n.class}</small><br>
        <button class="action-btn delete" onclick="deleteNote('${n.id}',true)">Delete</button>
      </div>
    `;
  });
}
function closeMyNotes(){ document.getElementById("myNotesModal").style.display="none"; }

/* DELETE */
async function deleteNote(id,fromMine=false){
  if(!confirm("Delete?")) return;
  try{
    const res = await fetch(`${API}/${id}`,{method:"DELETE"});
    const data = await res.json();
    if(data.success){
      if(fromMine){
        let arr = JSON.parse(localStorage.getItem(LS_NOTES)||"[]");
        arr = arr.filter(n=>n.id!==id);
        localStorage.setItem(LS_NOTES,JSON.stringify(arr));
        openMyNotes();
      }
      loadNotes();
    }
  }catch(e){ alert("Delete failed!"); }
}

function openPDF(url){
  const previewUrl = url.includes("?") ? url+"&fl_attachment=false" : url+"?fl_attachment=false";
  window.open(previewUrl,"_blank");
}
</script>
</body>
</html>
