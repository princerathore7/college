<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Upload Notes â€” Mentor Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
body { font-family: Inter, sans-serif; background:#eef2f7; padding:30px; }
.card { max-width:900px; background:#fff; margin:auto; padding:25px; border-radius:10px; box-shadow:0 4px 16px rgba(0,0,0,0.1); }
label { font-weight:600; display:block; margin-top:12px; }
input, select { width:100%; padding:10px; margin-top:5px; border:1px solid #ccc; border-radius:6px; }
button { width:100%; padding:12px; margin-top:18px; background:#2563eb; color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:15px; font-weight:600; }

.note-item { border-bottom:1px solid #ddd; padding:12px; background:#f9f9f9; margin-top:12px; border-radius:6px; }
.action-btn { padding:6px 12px; border:none; border-radius:6px; cursor:pointer; margin-top:6px; }
.view { background:#16a34a; color:#fff; }
.delete { background:#dc2626; color:#fff; margin-left:6px; }

.top-actions{
  display:flex;
  gap:10px;
  margin-bottom:15px;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.5);
  display:none;
  align-items:center;
  justify-content:center;
}
.modal-content{
  background:#fff;
  padding:20px;
  width:90%;
  max-width:600px;
  border-radius:10px;
}
.close{
  float:right;
  cursor:pointer;
  font-weight:bold;
}
</style>
</head>

<body>

<div class="card">
<h2>Upload Notes / Assignments</h2>

<div class="top-actions">
  <input id="searchInput" placeholder="ðŸ” Search by title / subject / class">
  <button onclick="openMyNotes()">ðŸ“Œ My Posted Notes</button>
</div>

<label>Title</label>
<input type="text" id="title">

<label>Subject</label>
<input type="text" id="subject">

<label>Deadline (Optional)</label>
<input type="date" id="deadline">

<label>Select Year</label>
<select id="year">
  <option value="">-- select year --</option>
  <option value="1">1st Year</option>
  <option value="2">2nd Year</option>
  <option value="3">3rd Year</option>
  <option value="4">4th Year</option>
</select>

<label>Select Branch</label>
<select id="branch"> <!-- unchanged options -->
<option value="CSE">CSE</option><option value="IT">IT</option>
<option value="ECE">ECE</option><option value="ME">ME</option>
<option value="CE">CE</option>
</select>

<label>Select Section</label>
<select id="section">
  <option value="">-- select section --</option>
  <option value="1">1</option><option value="2">2</option>
  <option value="3">3</option><option value="4">4</option>
</select>

<label>Upload PDF File</label>
<input type="file" id="file" accept="application/pdf">

<button onclick="uploadNote()">Upload</button>

<hr style="margin:25px 0;">

<h3>Uploaded Notes (All)</h3>
<div id="notesList"></div>
</div>

<!-- MY NOTES MODAL -->
<div class="modal" id="myNotesModal">
  <div class="modal-content">
    <span class="close" onclick="closeMyNotes()">âœ–</span>
    <h3>ðŸ“Œ My Posted Notes</h3>
    <div id="myNotesList"></div>
  </div>
</div>

<script>
const API = "https://college-hwbb.onrender.com/api/notes";
const LS_NOTES = "my_posted_notes";
const LS_CLASS = "last_selected_class";

/* ACCESS CONTROL */
const mentorId = localStorage.getItem("mentorId");
const source = sessionStorage.getItem("accessSource");
if(!mentorId || !["ad","admin"].includes(source)){
  document.body.innerHTML="<h2 style='color:red;text-align:center'>Access Denied</h2>";
  throw "";
}

function normalizeClass(y,b,s){ return (y+b+s).toUpperCase(); }

/* AUTO FILL LAST CLASS */
window.onload = ()=>{
  const c = JSON.parse(localStorage.getItem(LS_CLASS) || "{}");
  if(c.year) year.value=c.year, branch.value=c.branch, section.value=c.section;
  loadNotes();
};

/* UPLOAD */
async function uploadNote(){
  const title=titleInput.value.trim();
  const subject=subjectInput.value.trim();
  const yearVal=year.value, branchVal=branch.value, sectionVal=section.value;
  const file=fileInput.files[0];
  if(!title||!subject||!yearVal||!branchVal||!sectionVal||!file) return alert("Fill all");

  const cls = normalizeClass(yearVal,branchVal,sectionVal);
  localStorage.setItem(LS_CLASS,JSON.stringify({year:yearVal,branch:branchVal,section:sectionVal}));

  const fd=new FormData();
  fd.append("title",title);
  fd.append("subject",subject);
  fd.append("class",cls);
  fd.append("file",file);

  const res=await fetch(API,{method:"POST",body:fd});
  const data=await res.json();
  if(data.success){
    saveMyNote(data.noteId,title,subject,cls);
    loadNotes();
  }
}

/* LOCAL STORAGE MY NOTES */
function saveMyNote(id,t,s,c){
  const arr=JSON.parse(localStorage.getItem(LS_NOTES)||"[]");
  arr.push({id,title:t,subject:s,class:c});
  localStorage.setItem(LS_NOTES,JSON.stringify(arr));
}

/* LOAD ALL NOTES */
let ALL_NOTES=[];
async function loadNotes(){
  const res=await fetch(API);
  const data=await res.json();
  ALL_NOTES=data.notes||[];
  renderNotes(ALL_NOTES);
}

function renderNotes(list){
  notesList.innerHTML="";
  list.forEach(n=>{
    notesList.innerHTML+=`
    <div class="note-item">
      <strong>${n.title}</strong><br>
      <small>${n.subject} â€¢ ${n.class}</small><br>
      <button class="action-btn view" onclick="openPDF('${n.file_url}')">View</button>
      <button class="action-btn delete" onclick="deleteNote('${n.noteId}')">Delete</button>
    </div>`;
  });
}

/* SEARCH */
searchInput.oninput=()=>{
  const q=searchInput.value.toLowerCase();
  renderNotes(ALL_NOTES.filter(n=>
    n.title.toLowerCase().includes(q) ||
    n.subject.toLowerCase().includes(q) ||
    n.class.toLowerCase().includes(q)
  ));
};

/* MY NOTES MODAL */
function openMyNotes(){
  myNotesModal.style.display="flex";
  const arr=JSON.parse(localStorage.getItem(LS_NOTES)||"[]");
  myNotesList.innerHTML="";
  arr.forEach(n=>{
    myNotesList.innerHTML+=`
    <div class="note-item">
      <strong>${n.title}</strong><br>
      <small>${n.subject} â€¢ ${n.class}</small><br>
      <button class="action-btn delete" onclick="deleteNote('${n.id}',true)">Delete</button>
    </div>`;
  });
}
function closeMyNotes(){ myNotesModal.style.display="none"; }

/* DELETE */
async function deleteNote(id,fromMine=false){
  if(!confirm("Delete?"))return;
  const res=await fetch(`${API}/${id}`,{method:"DELETE"});
  const data=await res.json();
  if(data.success){
    if(fromMine){
      let arr=JSON.parse(localStorage.getItem(LS_NOTES)||"[]");
      arr=arr.filter(n=>n.id!==id);
      localStorage.setItem(LS_NOTES,JSON.stringify(arr));
      openMyNotes();
    }
    loadNotes();
  }
}

function openPDF(url){ window.open(url,"_blank"); }
</script>
</body>
</html>
