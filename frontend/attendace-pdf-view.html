<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Attendance PDFs</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:Inter,system-ui,sans-serif;
  background:#f4f6fb;
  margin:0;
  padding:20px;
}
.container{max-width:1100px;margin:auto;}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}
select,button{
  padding:9px 14px;
  border-radius:8px;
  border:1px solid #cbd5e1;
  font-size:14px;
}
button{background:#1e40af;color:#fff;cursor:pointer}
.filters{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:12px;
  overflow:hidden;
}
th{background:#eef3ff;padding:12px;font-size:14px}
td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:center}

.badge{
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:700;
}
.updated{background:#dcfce7;color:#166534}
.pending{background:#fee2e2;color:#991b1b}

.action-btn{
  padding:6px 12px;
  border-radius:6px;
  border:none;
  font-size:13px;
  cursor:pointer;
  margin:2px;
}
.view-btn{background:#2563eb}
.update-btn{background:#16a34a}
.update-btn[disabled]{background:#9ca3af;cursor:not-allowed}
.no-data{color:#666;padding:20px}
</style>
</head>

<body>

<div class="container">

<header>
  <h2>üìÑ Attendance PDFs</h2>
  <div>
    <button onclick="openAdmin()">üè† Admin Panel</button>
    <button onclick="history.back()">‚¨Ö Back</button>
  </div>
</header>

<div class="filters">
  <select id="year">
    <option value="">Select Year</option>
    <option value="1">1st Year</option>
    <option value="2">2nd Year</option>
    <option value="3">3rd Year</option>
    <option value="4">4th Year</option>
  </select>

  <select id="branch">
     <option value="">Select</option>
                <option value="CSE1">CSE1</option>
                <option value="CSE2">CSE2</option>
                <option value="CSE3">CSE3</option>
                <option value="CSE4">CSE4</option>
                <option value="IT1">IT1</option>
                <option value="IT2">IT2</option>
                <option value="IT3">IT3</option>
                <option value="IT4">IT4</option>
                  <option value="AIML1">AIML1</option>
    <option value="AIML2">AIML2</option>
    <option value="AIML3">AIML3</option>
    <option value="AIML4">AIML4</option>
    <option value="AIML5">AIML5</option>
    
    <option value="AIDS1">AIDS1</option>
    <option value="AIDS2">AIDS2</option>
    <option value="AIDS3">AIDS3</option>
    <option value="AIDS4">AIDS4</option>
    <option value="AIDS5">AIDS5</option>
    
    <option value="CSBS1">CSBS1</option>
    <option value="CSBS2">CSBS2</option>
    <option value="CSBS3">CSBS3</option>
    <option value="CSBS4">CSBS4</option>
    <option value="CSBS5">CSBS5</option>

    <option value="IOT1">IOT1</option>
    <option value="IOT2">IOT2</option>
    <option value="IOT3">IOT3</option>
    <option value="IOT4">IOT4</option>
    <option value="IOT5">IOT5</option>
    
    <option value="ECE1">ECE1</option>
    <option value="ECE2">ECE2</option>
    <option value="ECE3">ECE3</option>
    <option value="ECE4">ECE4</option>
    <option value="ECE5">ECE5</option>

    <option value="EEE1">EEE1</option>
    <option value="EEE2">EEE2</option>
    <option value="EEE3">EEE3</option>
    <option value="EEE4">EEE4</option>
    <option value="EEE5">EEE5</option>

    <option value="EE1">EE1</option>
    <option value="EE2">EE2</option>
    <option value="EE3">EE3</option>
    <option value="EE4">EE4</option>
    <option value="EE5">EE5</option>

    <option value="ME1">ME1</option>
    <option value="ME2">ME2</option>
    <option value="ME3">ME3</option>
    <option value="ME4">ME4</option>
    <option value="ME5">ME5</option>

    <option value="AU1">AU1</option>
    <option value="AU2">AU2</option>
    <option value="AU3">AU3</option>
    <option value="AU4">AU4</option>
    <option value="AU5">AU5</option>

    <option value="MT1">MT1</option>
    <option value="MT2">MT2</option>
    <option value="MT3">MT3</option>
    <option value="MT4">MT4</option>
    <option value="MT5">MT5</option>

    <option value="CE1">CE1</option>
    <option value="CE2">CE2</option>
    <option value="CE3">CE3</option>
    <option value="CE4">CE4</option>
    <option value="CE5">CE5</option>

    <option value="CHE1">CHE1</option>
    <option value="CHE2">CHE2</option>
    <option value="CHE3">CHE3</option>
    <option value="CHE4">CHE4</option>
    <option value="CHE5">CHE5</option>

    <option value="MIN1">MIN1</option>
    <option value="MIN2">MIN2</option>
    <option value="MIN3">MIN3</option>
    <option value="MIN4">MIN4</option>
    <option value="MIN5">MIN5</option>

    <option value="PET1">PET1</option>
    <option value="PET2">PET2</option>
    <option value="PET3">PET3</option>
    <option value="PET4">PET4</option>
    <option value="PET5">PET5</option>

    <option value="BT1">BT1</option>
    <option value="BT2">BT2</option>
    <option value="BT3">BT3</option>
    <option value="BT4">BT4</option>
    <option value="BT5">BT5</option>

    <option value="BME1">BME1</option>
    <option value="BME2">BME2</option>
    <option value="BME3">BME3</option>
    <option value="BME4">BME4</option>
    <option value="BME5">BME5</option>

    <option value="FT1">FT1</option>
    <option value="FT2">FT2</option>
    <option value="FT3">FT3</option>
    <option value="FT4">FT4</option>
    <option value="FT5">FT5</option>

    <option value="AG1">AG1</option>
    <option value="AG2">AG2</option>
    <option value="AG3">AG3</option>
    <option value="AG4">AG4</option>
    <option value="AG5">AG5</option>

    <option value="ENV1">ENV1</option>
    <option value="ENV2">ENV2</option>
    <option value="ENV3">ENV3</option>
    <option value="ENV4">ENV4</option>
    <option value="ENV5">ENV5</option>

    <option value="TX1">TX1</option>
    <option value="TX2">TX2</option>
    <option value="TX3">TX3</option>
    <option value="TX4">TX4</option>
    <option value="TX5">TX5</option>

    <option value="PIE1">PIE1</option>
    <option value="PIE2">PIE2</option>
    <option value="PIE3">PIE3</option>
    <option value="PIE4">PIE4</option>
    <option value="PIE5">PIE5</option>

    <option value="IM1">IM1</option>
    <option value="IM2">IM2</option>
    <option value="IM3">IM3</option>
    <option value="IM4">IM4</option>
    <option value="IM5">IM5</option>
  
  </select>

  <button onclick="loadPDFs()">Search</button>
</div>

<table>
<thead>
<tr>
  <th>Subject</th>
  <th>Week</th>
  <th>Status</th>
  <th>Actions</th>
</tr>
</thead>
<tbody id="pdfBody">
<tr><td colspan="4" class="no-data">Select Year & Branch</td></tr>
</tbody>
</table>

</div>

<script>
const API = "https://college-hwbb.onrender.com";
const mentorId = localStorage.getItem("mentorId");
const source = sessionStorage.getItem("accessSource");

if (!mentorId || source !== "ad") {
    document.body.innerHTML = `
        <h2 style="text-align:center;margin-top:20vh;color:red">
          ‚ùå Access Denied <br>
          Please open this page from Administration Panel only
        </h2>
    `;
    throw new Error("Unauthorized access");
}

/* ================= LOAD PDFs ================= */
async function loadPDFs(){
  const year = document.getElementById("year").value;
  const branch = document.getElementById("branch").value;
  const body = document.getElementById("pdfBody");

  if(!year || !branch){
    alert("Select Year & Branch");
    return;
  }

  body.innerHTML = `<tr><td colspan="4">Loading...</td></tr>`;

  try{
    const res = await fetch(`${API}/api/attendance-pdfs?year=${year}&branch=${branch}`);
    const data = await res.json();
    if(!data.success) throw new Error();
    renderPDFs(data.pdfs);
  }catch{
    body.innerHTML = `<tr><td colspan="4" class="no-data">Failed to load PDFs</td></tr>`;
  }
}

/* ================= RENDER ================= */
function renderPDFs(list){
  const body = document.getElementById("pdfBody");
  body.innerHTML = "";

  if(!list.length){
    body.innerHTML = `<tr><td colspan="4" class="no-data">No PDFs uploaded</td></tr>`;
    return;
  }

  list.forEach(pdf=>{
    const statusClass = pdf.updated ? "updated" : "pending";
    const statusText  = pdf.updated ? "Updated" : "Pending";

    const key = `${pdf.year}_${pdf.branch}_${pdf.subject}_${pdf.week}`;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${pdf.subject}</td>
      <td>${pdf.week}</td>
      <td><span class="badge ${statusClass}">${statusText}</span></td>
      <td>
        <button class="action-btn view-btn"
          onclick="window.open('${pdf.pdfUrl}','_blank')">View</button>

        <button class="action-btn update-btn"
          ${pdf.updated ? "disabled" : ""}
          onclick="markUpdated('${key}')">
          Mark Updated
        </button>
      </td>
    `;
    body.appendChild(tr);
  });
}

/* ================= MARK UPDATED ================= */
async function markUpdated(key){
  try{
    const res = await fetch(
      `${API}/api/admin/attendance-pdf/mark-updated`,
      {
        method: "POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify({ key })
      }
    );

    const data = await res.json();

    if(data.success){
      alert("‚úÖ Marked as updated");
      loadPDFs();
    }else{
      alert("‚ùå " + data.message);
    }

  }catch{
    alert("‚ùå Failed to mark updated");
  }
}


/* ================= ADMIN REDIRECT ================= */
function openAdmin(){
  // same token/session will be reused
  window.location.href = "admin.html";
}
</script>

</body>
</html>
