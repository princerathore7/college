<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Events - Mentor Dashboard</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:'Inter',sans-serif;
  margin:0;
  background:#f3f4f6;
}
header{
  background:#4a90e2;
  color:white;
  padding:1rem 2rem;
  text-align:center;
}
main{
  max-width:1000px;
  margin:2rem auto;
  padding:1rem;
  background:white;
  border-radius:10px;
  box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
.search-box{
  margin-bottom:1rem;
}
.search-box input{
  width:100%;
  padding:10px;
  border-radius:6px;
  border:1px solid #ccc;
  font-size:15px;
}
.event-card{
  border:1px solid #ddd;
  border-radius:8px;
  padding:1rem;
  margin-bottom:1rem;
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  background:#fafafa;
}
.event-info{
  max-width:80%;
}
.event-info img{
  max-width:160px;
  display:block;
  margin-bottom:8px;
  border-radius:6px;
}
button{
  background:#e74c3c;
  color:white;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}
button:hover{
  background:#c0392b;
}
.empty{
  text-align:center;
  color:gray;
  margin-top:2rem;
}
</style>
</head>

<body>

<header>
  <h1>Manage Events</h1>
</header>

<main>
  <div class="search-box">
    <input type="text" id="searchInput" placeholder="Search events (title, description, date...)">
  </div>

  <div id="eventsContainer"></div>
</main>

<script>
/* ===============================
   ACCESS CONTROL
================================ */
const mentorId = localStorage.getItem("mentorId");
const source   = sessionStorage.getItem("accessSource");

if(!mentorId || !["ad","admin"].includes(source)){
  document.body.innerHTML = `
    <h2 style="text-align:center;margin-top:20vh;color:red">
      ‚ùå Access Denied<br>Please open via Admin Panel
    </h2>`;
  throw new Error("Unauthorized");
}

/* ===============================
   DEVICE ID (for ownership)
================================ */
if(!localStorage.getItem("device_id")){
  localStorage.setItem(
    "device_id",
    "dev-" + Date.now() + "-" + Math.random().toString(36).slice(2)
  );
}

const DEVICE = localStorage.getItem("device_id");
let ALL_EVENTS = [];

/* ===============================
   LOAD EVENTS
================================ */
async function loadEvents(){
  try{
    const res = await fetch("https://college-hwbb.onrender.com/api/events");
    const data = await res.json();

    if(!data.success || !Array.isArray(data.events)){
      render([]);
      return;
    }

    // üî• only my posted events
    const myEvents = JSON.parse(localStorage.getItem("my_posted_events")||"[]");

    ALL_EVENTS = data.events.filter(ev =>
      myEvents.some(m => m.eventId === ev.eventId && m.device === DEVICE)
    );

    render(ALL_EVENTS);

  }catch(err){
    console.error(err);
    render([]);
  }
}

/* ===============================
   RENDER
================================ */
function render(list){
  const box = document.getElementById("eventsContainer");
  box.innerHTML = "";

  if(list.length === 0){
    box.innerHTML = `<div class="empty">No events found</div>`;
    return;
  }

  list.forEach(ev=>{
    const div = document.createElement("div");
    div.className = "event-card";

    div.innerHTML = `
      <div class="event-info">
        ${ev.image ? `<img src="${ev.image}">` : ""}
        <strong>${ev.title}</strong><br>
        Date: ${ev.date || "N/A"}<br>
        <div>${ev.description || ""}</div>
      </div>
      <button onclick="deleteEvent('${ev.eventId}')">Delete</button>
    `;
    box.appendChild(div);
  });
}

/* ===============================
   DELETE EVENT
================================ */
async function deleteEvent(eventId){
  if(!confirm("Delete this event?")) return;

  try{
    const res = await fetch(
      `https://college-hwbb.onrender.com/api/events/${eventId}`,
      { method:"DELETE" }
    );
    const data = await res.json();

    if(data.success){
      let my = JSON.parse(localStorage.getItem("my_posted_events")||"[]");
      my = my.filter(e => e.eventId !== eventId);
      localStorage.setItem("my_posted_events", JSON.stringify(my));
      loadEvents();
    }else{
      alert(data.message || "Delete failed");
    }
  }catch(err){
    alert("Server error");
  }
}

/* ===============================
   SEARCH (title + desc + date)
================================ */
document.getElementById("searchInput").addEventListener("input", e=>{
  const q = e.target.value.toLowerCase();
  const filtered = ALL_EVENTS.filter(ev =>
    JSON.stringify(ev).toLowerCase().includes(q)
  );
  render(filtered);
});

/* ===============================
   INIT
================================ */
loadEvents();
</script>

</body>
</html>
