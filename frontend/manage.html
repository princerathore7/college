<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Manage Events</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:Inter,sans-serif;
  background:#f3f4f6;
  margin:0;
}
header{
  background:#4a90e2;
  color:#fff;
  padding:1rem;
  text-align:center;
}
main{
  max-width:1000px;
  margin:1.5rem auto;
  background:#fff;
  padding:1rem;
  border-radius:10px;
}
h2{
  margin-top:2rem;
  border-bottom:2px solid #eee;
  padding-bottom:6px;
}
.search-box{
  width:100%;
  padding:10px;
  border-radius:6px;
  border:1px solid #ccc;
  margin-bottom:1rem;
  font-size:15px;
}
.event{
  border:1px solid #ddd;
  border-radius:8px;
  padding:1rem;
  margin-bottom:1rem;
  display:flex;
  justify-content:space-between;
  gap:1rem;
  background:#fafafa;
}
.event img{
  max-width:140px;
  border-radius:6px;
}
.meta{
  font-size:13px;
  color:#666;
}
button{
  background:#e74c3c;
  color:#fff;
  border:none;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
}
button:hover{background:#c0392b}
.empty{
  text-align:center;
  color:#777;
  margin:1rem 0;
}
</style>
</head>

<body>

<header>
  <h1>Manage Events</h1>
</header>

<main>

<input class="search-box" id="search" placeholder="Search events (title, description, date...)">

<h2>ðŸ“Œ My Posted Events</h2>
<div id="myEvents"></div>

<h2>ðŸ“¢ All Events</h2>
<div id="allEvents"></div>

</main>

<script>
/* ===============================
   ACCESS CONTROL
================================ */
const mentorId = localStorage.getItem("mentorId");
const source = sessionStorage.getItem("accessSource");

if(!mentorId || !["admin","ad"].includes(source)){
  document.body.innerHTML = "<h2 style='text-align:center;color:red;margin-top:20vh'>Access Denied</h2>";
  throw new Error("Unauthorized");
}

/* ===============================
   DEVICE ID
================================ */
if(!localStorage.getItem("device_id")){
  localStorage.setItem("device_id","dev-"+Date.now()+"-"+Math.random().toString(36).slice(2));
}
const deviceId = localStorage.getItem("device_id");

/* ===============================
   GLOBAL DATA
================================ */
let allEventsData = [];

/* ===============================
   FETCH EVENTS
================================ */
async function loadEvents(){
  try{
    const res = await fetch("https://college-hwbb.onrender.com/api/events");
    const data = await res.json();
    if(!data.success) return;

    allEventsData = data.events || [];
    renderEvents();
  }catch(e){
    console.error(e);
  }
}

/* ===============================
   RENDER EVENTS
================================ */
function renderEvents(){
  const q = document.getElementById("search").value.toLowerCase();

  const myBox = document.getElementById("myEvents");
  const allBox = document.getElementById("allEvents");

  myBox.innerHTML = "";
  allBox.innerHTML = "";

  const myList = JSON.parse(localStorage.getItem("my_posted_events") || "[]");

  let myCount = 0, allCount = 0;

  allEventsData.forEach(ev=>{
    const text = `${ev.title} ${ev.description} ${ev.date}`.toLowerCase();
    if(!text.includes(q)) return;

    const isMine = myList.some(e => e.eventId === ev.eventId && e.device === deviceId);

    const html = `
      <div class="event">
        <div>
          ${ev.image ? `<img src="${ev.image}">` : ""}
          <strong>${ev.title}</strong>
          <div>${ev.description || ""}</div>
          <div class="meta">ðŸ“… ${ev.date || "N/A"}</div>
        </div>
        ${isMine ? `<button onclick="deleteEvent('${ev.eventId}')">Delete</button>` : ""}
      </div>
    `;

    if(isMine){
      myBox.innerHTML += html;
      myCount++;
    }else{
      allBox.innerHTML += html;
      allCount++;
    }
  });

  if(myCount === 0) myBox.innerHTML = "<div class='empty'>No events posted by you</div>";
  if(allCount === 0) allBox.innerHTML = "<div class='empty'>No events found</div>";
}

/* ===============================
   DELETE EVENT
================================ */
async function deleteEvent(id){
  if(!confirm("Delete this event?")) return;

  const res = await fetch(`https://college-hwbb.onrender.com/api/events/${id}`,{
    method:"DELETE"
  });
  const data = await res.json();

  if(data.success){
    let list = JSON.parse(localStorage.getItem("my_posted_events")||"[]");
    list = list.filter(e => e.eventId !== id);
    localStorage.setItem("my_posted_events",JSON.stringify(list));
    loadEvents();
  }else{
    alert(data.message || "Delete failed");
  }
}

/* ===============================
   SEARCH
================================ */
document.getElementById("search").addEventListener("input",renderEvents);

/* ===============================
   INIT
================================ */
loadEvents();
</script>

</body>
</html>
