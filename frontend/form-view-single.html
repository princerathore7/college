<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>View Form Submission</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>

<style>
/* ---- SAME CSS (unchanged) ---- */
:root{
  --navy:#0b1c2d;
  --bg:#f4f6f9;
  --card:#fff;
  --border:#e1e5ec;
  --accent:#1e90ff;
  --green:#28a745;
  --red:#ff4d4f;
}
*{box-sizing:border-box;font-family:'Inter',sans-serif}
body{margin:0;background:var(--bg);padding:26px}
.container{max-width:900px;margin:auto}
.card{background:var(--card);border:1px solid var(--border);padding:20px;margin-bottom:18px}
.field{padding:12px 0;border-bottom:1px solid var(--border)}
.field:last-child{border-bottom:none}
.field label{font-size:13px;font-weight:600}
.field .value{margin-top:6px;font-size:13px}
.field a{color:var(--accent);font-weight:600;text-decoration:none;margin-right:10px}
.actions{display:flex;gap:10px;flex-wrap:wrap}
.btn{padding:9px 16px;border:none;font-size:12px;font-weight:600;cursor:pointer}
.btn.primary{background:var(--accent);color:#fff}
.btn.secondary{background:#e9edf3}
.btn.green{background:var(--green);color:#fff}
.btn.red{background:var(--red);color:#fff}
</style>
</head>

<body>
<div class="container">

  <div class="card">
    <h2 id="formName">Form</h2>
    <div><strong>Enrollment:</strong> <span id="enrollment"></span></div>
    <div><strong>Name:</strong> <span id="studentName"></span></div>
    <div><strong>Submitted:</strong> <span id="submittedAt"></span></div>
  </div>

  <div class="card">
    <h3>Submitted Data</h3>
    <div id="formFields">Loading‚Ä¶</div>
  </div>

  <div class="actions">
    <button class="btn secondary" onclick="history.back()">‚Üê Back</button>
    <button class="btn primary" onclick="window.print()">Print Page</button>
    <button class="btn green" onclick="printCompleteDocument()">üßæ Print Complete Document</button>
  </div>

</div>

<script>
const params = new URLSearchParams(window.location.search);
const submissionId = params.get("submissionId");
let submissionData = null;
let attachedPdfs = [];

/* LOAD SUBMISSION */
async function loadSubmission(){
  const res = await fetch(
    `https://college-hwbb.onrender.com/api/admin/submissions/${submissionId}`,
    { credentials:"include" }
  );
  submissionData = await res.json();

  formName.innerText = submissionData.form_name;
  enrollment.innerText = submissionData.enrollment;
  studentName.innerText = submissionData.student_name;
  submittedAt.innerText = new Date(submissionData.submitted_at).toLocaleString();

  renderFields(submissionData.responses);
}

/* RENDER FIELDS */
function renderFields(responses){
  const box = document.getElementById("formFields");
  box.innerHTML = "";
  attachedPdfs = [];

  Object.entries(responses).forEach(([label,value])=>{
    const div=document.createElement("div");
    div.className="field";

    if(typeof value==="string" && value.startsWith("http")){
      attachedPdfs.push(value);
      div.innerHTML=`
        <label>${label}</label>
        <div class="value">
          <a href="${value}" target="_blank">View</a>
          <a href="${value}" onclick="event.preventDefault();printPdf('${value}')">Print PDF</a>
        </div>`;
    }else{
      div.innerHTML=`
        <label>${label}</label>
        <div class="value">${value ?? "‚Äî"}</div>`;
    }
    box.appendChild(div);
  });
}

/* PRINT SINGLE PDF */
function printPdf(url){
  const w = window.open(url,"_blank");
  w.onload = ()=>w.print();
}

/* üî• PRINT COMPLETE DOCUMENT (PAGE + ALL PDFs) */
async function printCompleteDocument(){
  const { PDFDocument } = PDFLib;
  const finalPdf = await PDFDocument.create();

  // 1Ô∏è‚É£ Page text as PDF
  const page = finalPdf.addPage([595,842]);
  const text = document.body.innerText;
  page.drawText(text.substring(0, 3500), { x:40, y:800, size:10 });

  // 2Ô∏è‚É£ Merge all attached PDFs
  for(const url of attachedPdfs){
    const bytes = await fetch(url).then(r=>r.arrayBuffer());
    const pdf = await PDFDocument.load(bytes);
    const pages = await finalPdf.copyPages(pdf, pdf.getPageIndices());
    pages.forEach(p=>finalPdf.addPage(p));
  }

  // 3Ô∏è‚É£ Download + Print
  const blob = new Blob([await finalPdf.save()],{type:"application/pdf"});
  const fileUrl = URL.createObjectURL(blob);
  const w = window.open(fileUrl);
  w.onload=()=>w.print();
}

loadSubmission();
</script>
</body>
</html>
