<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Mark Attendance</title>

<style>
    body{
        font-family: Poppins, sans-serif;
        background:#f5f5f5;
        padding:20px;
        max-width:700px;
        margin:auto;
    }

    h2{
        text-align:center;
        margin-bottom:20px;
        font-size:26px;
        color:#333;
    }

    .box{
        background:white;
        padding:15px;
        border-radius:8px;
        box-shadow:0 2px 8px rgba(0,0,0,0.1);
        margin-bottom:20px;
    }

    input{
        padding:10px;
        width:100%;
        margin:5px 0;
        border-radius:6px;
        border:1px solid #ccc;
        font-size:15px;
    }

    button{
        padding:10px 18px;
        background:#007bff;
        color:white;
        border:none;
        border-radius:6px;
        cursor:pointer;
        margin-top:8px;
        font-size:16px;
    }
    button:hover{ background:#005ec4; }

    .student-row{
        display:flex;
        justify-content:space-between;
        align-items:center;
        padding:10px;
        border-bottom:1px solid #eee;
        background:white;
        border-radius:5px;
        margin-bottom:7px;
    }
</style>
</head>

<body>

<h2 id="classTitle">Attendance</h2>

<!-- Add Single -->
<div class="box">
    <h3>âž• Add Single Student</h3>
    <input id="singleEnroll" placeholder="Enrollment Number (0827IT241105)">
    <button onclick="addSingle()">Add</button>
</div>

<!-- Add Bulk -->
<div class="box">
    <h3>ðŸ“¦ Add Bulk Students</h3>
    <input id="bulkStart" placeholder="Start Enrollment (0827IT241105)">
    <input id="bulkEnd" placeholder="End Enrollment (0827IT241160)">
    <button onclick="addBulk()">Add Bulk</button>
</div>

<!-- Students List -->
<div class="box">
    <h3>ðŸ§¾ Students List</h3>
    <div id="studentList"></div>
</div>

<button style="width:100%;padding:15px;font-size:17px" onclick="submitAttendance()">
    Submit Attendance
</button>

<script>
const urlParams = new URLSearchParams(window.location.search);
const branch = urlParams.get("class"); 

if(!branch) alert("Class not specified in URL!");

document.getElementById("classTitle").innerText = "Attendance â€” " + branch;

let studentData = [];

// Load Students
async function loadStudents() {
    try{
        let res = await fetch(`/api/students/${branch}`);

        if (!res.ok) {
            console.error("HTTP 404 Error loading students");
            return;
        }

        let data = await res.json();
        let container = document.getElementById("studentList");
        container.innerHTML = "";

        // Prepare attendance array
        studentData = data.students.map(s => ({
            enrollment: s.enrollment,
            name: s.name ?? "",
            status: "absent"
        }));

        data.students.forEach(std => {
            container.innerHTML += `
                <div class="student-row">
                    <span>${std.name || "No Name"}</span>
                    <span>${std.enrollment}</span>
                    <input type="checkbox" onchange="updateStatus('${std.enrollment}', this.checked)">
                </div>
            `;
        });

    }catch(e){
        console.error("Fetch error:", e);
    }
}

// Mark attendance
function updateStatus(enr, checked){
    let st = studentData.find(s=>s.enrollment===enr);
    if(st) st.status = checked ? "present" : "absent";
}

// Add Single
async function addSingle(){
    let enr = document.getElementById("singleEnroll").value.trim();
    if(!enr) return alert("Enter enrollment");

    let res = await fetch("/api/students/add", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ branch, enrollment: enr })
    });

    let data = await res.json();
    alert(data.message);
    loadStudents();
}

// Add Bulk
async function addBulk(){
    let start = document.getElementById("bulkStart").value.trim();
    let end = document.getElementById("bulkEnd").value.trim();
    if(!start || !end) return alert("Fill both fields");

    let res = await fetch("/api/students/bulk", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({ branch, start, end })
    });

    let data = await res.json();
    alert(data.message);
    loadStudents();
}

// Submit Attendance
async function submitAttendance(){
    let payload = {
        branch,
        date: new Date().toISOString().split("T")[0],
        attendance: studentData
    };

    let res = await fetch("/api/attendance/submit", {
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
    });

    let data = await res.json();
    alert(data.message);
}

loadStudents();
</script>

</body>
</html>
