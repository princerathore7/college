<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Upload Timetable — Mentor</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
  body { font-family: Inter, sans-serif; background:#f3f4f6; margin:0; padding:30px; color:#222; }
  .card { max-width:800px; margin:0 auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.08); }
  label { display:block; margin:10px 0 6px; font-weight:600; }
  select, input[type="file"], button { width:100%; padding:10px; border-radius:6px; border:1px solid #ccc; box-sizing:border-box; }
  button { background:#4a90e2; color:#fff; border:none; cursor:pointer; margin-top:10px; font-weight:600; }
  .list { margin-top:20px; }
  .item { display:flex; align-items:center; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; }
  .meta { display:flex; gap:12px; align-items:center; }
  .meta strong { display:block; }
  .actions button { margin-left:8px; padding:6px 10px; border-radius:6px; border:none; cursor:pointer; }
  .viewBtn { background:#2e7d32; color:#fff; }
  .delBtn { background:#e53935; color:#fff; }
  .note { color:#666; font-size:13px; margin-top:6px; }
</style>
</head>
<body>
<div class="card">
  <h2>Upload Timetable PDF</h2>

  <label for="yearSelect">Select Year:</label>
  <select id="yearSelect">
    <option value="">-- Select Year --</option>
    <option value="1">1st Year</option>
    <option value="2">2nd Year</option>
    <option value="3">3rd Year</option>
    <option value="4">4th Year</option>
    <option value="5">5th Year</option>
  </select>

  <label for="branchSelect">Select Branch:</label>
  <select id="branchSelect">
    <option value="">-- Select Branch --</option>
    <option value="CSE">CSE</option>
    <option value="IT">IT</option>
    <option value="ECE">ECE</option>
    <option value="ME">ME</option>
    <option value="CIVIL">CIVIL</option>
  </select>

  <label for="sectionSelect">Select Section:</label>
  <select id="sectionSelect">
    <option value="">-- Select Section --</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
    <option value="4">4</option>
    <option value="5">5</option>
  </select>

  <label for="fileInput">PDF File</label>
  <input type="file" id="fileInput" accept="application/pdf" />

  <button id="uploadBtn">Upload Timetable</button>
  <p class="note">Only PDF allowed. File will be stored on server under uploads/timetables/</p>

  <div style="margin-top:20px;">
    <label for="filterClass">Select Class to View Timetable:</label>
    <select id="filterClass">
      <option value="">-- All --</option>
    </select>
    <button id="filterBtn" style="margin-top:8px;">Refresh List</button>
  </div>

  <div class="list" id="listContainer">
    <!-- populated by JS -->
  </div>
</div>

<script>
const API_BASE = "https://college-hwbb.onrender.com/api/timetables";

// normalize class like backend expects
function normalizeClass(year, branch, section){
  if(!year || !branch || !section) return "";
  return (year + branch + section).toUpperCase(); // e.g., 1IT3
}

// Populate filter dropdown with all class options
function populateFilterDropdown() {
  const years = ['1','2','3','4','5'];
  const branches = ['CSE','IT','ECE','ME','CIVIL'];
  const sections = ['1','2','3','4','5'];
  const filter = document.getElementById("filterClass");

  filter.innerHTML = `<option value="">-- All --</option>`;
  years.forEach(y=>{
    branches.forEach(b=>{
      sections.forEach(s=>{
        const text = `${y} ${b} ${s}`;
        const opt = document.createElement("option");
        opt.value = text;
        opt.textContent = text;
        filter.appendChild(opt);
      });
    });
  });
}

// Upload timetable
async function uploadTimetable() {
  const year = document.getElementById("yearSelect").value;
  const branch = document.getElementById("branchSelect").value;
  const section = document.getElementById("sectionSelect").value;
  const fileInput = document.getElementById("fileInput");

  if(!year || !branch || !section) return alert("Please select Year, Branch and Section");
  if(!fileInput.files.length) return alert("Select a PDF file");

  const className = normalizeClass(year, branch, section);
  const file = fileInput.files[0];
  if(file.type !== "application/pdf") return alert("Only PDF allowed");

  const form = new FormData();
  form.append("class", className);
  form.append("file", file);

  try{
    const res = await fetch(API_BASE, {method:"POST", body:form});
    const data = await res.json();
    if(res.ok && data.success){
      alert("Uploaded successfully");
      fileInput.value="";
      fetchList();
    } else alert(data.message || "Upload failed");
  }catch(err){
    console.error(err);
    alert("Error connecting to server");
  }
}

// Fetch list of timetables
async function fetchList(){
  const filterSelect = document.getElementById("filterClass");
  const className = filterSelect.value ? normalizeClass(
    ...filterSelect.value.split(" ")
  ) : "";

  const url = className ? `${API_BASE}?class=${encodeURIComponent(className)}` : API_BASE;

  try{
    const res = await fetch(url);
    const data = await res.json();
    const container = document.getElementById("listContainer");
    container.innerHTML = "";

    if(data.success && Array.isArray(data.timetables) && data.timetables.length>0){
      data.timetables.forEach(t=>{
        const div = document.createElement("div");
        div.className="item";
        div.innerHTML = `
          <div class="meta">
            <div>
              <strong>${t.originalFilename}</strong>
             <div style="font-size:13px;color:#666">Class: ${t.class.replace(/([0-9]+)([A-Z]+)([0-9]+)/, '$1 $2 $3')} • Uploaded: ${new Date(t.uploadedAt).toLocaleString()}</div>

            </div>
          </div>
          <div class="actions">
            <button class="viewBtn" onclick="viewPDF('${t.timetableId}')">View</button>
            <button class="delBtn" onclick="deleteTimetable('${t.timetableId}')">Delete</button>
          </div>
        `;
        container.appendChild(div);
      });
    } else container.innerHTML=`<p style="color:#666">No timetables found.</p>`;
  } catch(err){
    console.error(err);
    alert("Error fetching list (check console)");
  }
}

function viewPDF(id){
  window.open(`${API_BASE}/${encodeURIComponent(id)}/file`,"_blank");
}

async function deleteTimetable(id){
  if(!confirm("Delete this timetable?")) return;
  try{
    const res = await fetch(`${API_BASE}/${encodeURIComponent(id)}`, {method:"DELETE"});
    const data = await res.json();
    if(res.ok && data.success){
      alert("Deleted");
      fetchList();
    } else alert(data.message || "Delete failed");
  } catch(err){
    console.error(err);
    alert("Error deleting (check console)");
  }
}

document.getElementById("uploadBtn").addEventListener("click", uploadTimetable);
document.getElementById("filterBtn").addEventListener("click", fetchList);

// initial load
populateFilterDropdown();
fetchList();
</script>
</body>
</html>
