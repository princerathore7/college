<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="https://i.ibb.co/8tZSKKT/logo-with-bg.webp">

<meta charset="UTF-8">
<title>Attendance</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
<style>
body{font-family:Inter,system-ui,sans-serif;background:#f5f6fc;margin:0;padding:20px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
select,button{padding:8px 12px;border-radius:6px;border:1px solid #ccc}
button{background:#003366;color:#fff;cursor:pointer}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:center}
th{background:#eef3ff}
.mark-btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer}
.present{background:#16a34a;color:#fff}
.absent{background:#dc2626;color:#fff}
.selected{outline:3px solid #00000022}
.no-data{color:#666}
.controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
</style>
</head>

<body>

<header>
  <h2>Attendance Marking</h2>
  <button onclick="logout()">Logout</button>
</header>

<div class="controls">
  <select id="year">
    <option value="">Year</option>
    <option value="1">1st</option>
    <option value="2">2nd</option>
    <option value="3">3rd</option>
    <option value="4">4th</option>
  </select>

  <select id="branch">
    <option value="">Branch</option>
    <option value="CSE">CSE</option>
    <option value="IT">IT</option>
    <option value="ECE">ECE</option>
  </select>

  <select id="section">
    <option value="">Section</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
  </select>

  <button id="loadBtn">Load Students</button>
  <button id="refreshBtn">Refresh Data</button>
</div>

<table>
<thead>
<tr>
  <th>Enrollment</th>
  <th>Name</th>
  <th>Attendance</th>
</tr>
</thead>
<tbody id="studentsBody">
<tr><td colspan="3" class="no-data">Select filters & load students</td></tr>
</tbody>
</table>

<br>
<button onclick="submitAttendance()">Submit Attendance</button>

<script>
/* ===============================
   ACCESS CONTROL
================================ */
const mentorId = localStorage.getItem("mentorId");
const source = sessionStorage.getItem("accessSource");

if(!mentorId || !["ad","admin"].includes(source)){
  document.body.innerHTML =
    "<h2 style='text-align:center;margin-top:20vh;color:red'>Access Denied</h2>";
  throw new Error("Unauthorized");
}

/* ===============================
   API CONFIG
================================ */
const API_ALL_STUDENTS = "https://college-hwbb.onrender.com/api/students"; // fetch all
const API_SUBMIT       = "https://college-hwbb.onrender.com/api/attendance/mark";

let allStudents = []; // all students cached
let marked = {};

/* ===============================
   FETCH ALL STUDENTS (CACHE)
================================ */
async function fetchAllStudents(force=false){
  if(!force){
    const cached = localStorage.getItem("attendance_students");
    if(cached){
      allStudents = JSON.parse(cached);
      return allStudents;
    }
  }

  try{
    const res = await fetch(API_ALL_STUDENTS);
    const data = await res.json();
    if(data.success){
      allStudents = data.students;
      localStorage.setItem("attendance_students", JSON.stringify(allStudents));
      return allStudents;
    }
    return [];
  }catch(err){
    console.error(err);
    return [];
  }
}

/* ===============================
   RENDER STUDENTS WITH FILTER
================================ */
function renderTable(){
  const body = document.getElementById("studentsBody");
  const year = document.getElementById("year").value;
  const branch = document.getElementById("branch").value.toLowerCase();
  const section = document.getElementById("section").value;

  let filtered = allStudents.filter(s=>{
    let ok = true;
    if(year) ok = ok && String(s.year) === year;
    if(branch) ok = ok && s.branch.toLowerCase() === branch;
    if(section) ok = ok && s.section == section;
    return ok;
  });

  body.innerHTML = "";
  if(!filtered.length){
    body.innerHTML = `<tr><td colspan="3" class="no-data">No students found</td></tr>`;
    return;
  }

  for(const s of filtered){
    body.innerHTML += `
      <tr>
        <td>${s.enrollment}</td>
        <td>${s.name}</td>
        <td>
          <button class="mark-btn present" onclick="mark('${s.enrollment}','P',this)">P</button>
          <button class="mark-btn absent" onclick="mark('${s.enrollment}','A',this)">A</button>
        </td>
      </tr>
    `;
  }
}

/* ===============================
   MARK ATTENDANCE
================================ */
function mark(enr,status,btn){
  marked[enr] = status;
  btn.parentElement.querySelectorAll("button")
     .forEach(b=>b.classList.remove("selected"));
  btn.classList.add("selected");
}

/* ===============================
   SUBMIT ATTENDANCE
================================ */
async function submitAttendance(){
  if(!Object.keys(marked).length){
    alert("No attendance marked");
    return;
  }

  try{
    const res = await fetch(API_SUBMIT,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({records:marked})
    });
    const d = await res.json();
    alert(d.success ? "Attendance Saved" : "Error saving attendance");
  }catch(err){
    console.error(err);
    alert("Server error");
  }
}

/* ===============================
   LOAD & REFRESH BUTTONS
================================ */
document.getElementById("loadBtn").addEventListener("click",()=>{
  renderTable();
});

document.getElementById("refreshBtn").addEventListener("click",async()=>{
  await fetchAllStudents(true); // force fetch from API
  renderTable();
});

/* ===============================
   INITIAL LOAD (CACHE)
================================ */
document.addEventListener("DOMContentLoaded",async()=>{
  await fetchAllStudents();
});
  
function logout(){
  localStorage.clear();
  sessionStorage.clear();
  location.href="login.html";
}
</script>

</body>
</html>
