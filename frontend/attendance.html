<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Admin ‚Äî Attendance</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body{
  margin:0;
  font-family:Inter,system-ui,sans-serif;
  background:#f4f6fb;
}
header{
  background:#003366;
  color:#fff;
  padding:14px 20px;
  display:flex;
  justify-content:space-between;
  align-items:center;
}
main{padding:20px;max-width:1200px;margin:auto}

.controls{
  display:flex;
  gap:10px;
  flex-wrap:wrap;
  margin-bottom:15px;
}
select,button{
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #ccc;
}
button{
  background:#003366;
  color:#fff;
  cursor:pointer;
}
button:hover{background:#0057ad}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:10px;
  overflow:hidden;
}
th,td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
  text-align:center;
}
th{background:#eef3ff}

.mark-btn{
  padding:6px 12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}
.present{background:#16a34a;color:#fff}
.absent{background:#dc2626;color:#fff}
.selected{outline:3px solid #00000022}

.no-data{text-align:center;color:#666}
</style>
</head>

<body>

<header>
  <h2>Attendance Marking</h2>
  <button onclick="logout()">Logout</button>
</header>

<main>

<!-- ================= FILTERS ================= -->
<div class="controls">
  <select id="year">
    <option value="">All Years</option>
    <option value="1">1st Year</option>
    <option value="2">2nd Year</option>
    <option value="3">3rd Year</option>
    <option value="4">4th Year</option>
  </select>

  <select id="branch">
    <option value="">All Branches</option>
    <option value="CSE">CSE</option>
    <option value="IT">IT</option>
    <option value="ECE">ECE</option>
    <option value="ME">ME</option>
    <option value="CE">CE</option>
  </select>

  <select id="section">
    <option value="">All Sections</option>
    <option value="1">Section 1</option>
    <option value="2">Section 2</option>
    <option value="3">Section 3</option>
    <option value="4">Section 4</option>
  </select>

  <button onclick="render()">Load Students</button>
</div>

<!-- ================= TABLE ================= -->
<table>
<thead>
<tr>
  <th>Enrollment</th>
  <th>Name</th>
  <th>Attendance</th>
</tr>
</thead>
<tbody id="studentsBody">
<tr><td colspan="3" class="no-data">Select filters & load students</td></tr>
</tbody>
</table>

<br>
<button onclick="submitAttendance()">Submit Attendance</button>

</main>

<script>
/* ===============================
   ACCESS CONTROL ‚Äî ADMIN PAGES
================================ */
const mentorId = localStorage.getItem("mentorId");
const source   = sessionStorage.getItem("accessSource");
const ALLOWED_SOURCES = ["ad","admin"];

if(!mentorId || !ALLOWED_SOURCES.includes(source)){
  document.body.innerHTML = `
    <h2 style="text-align:center;margin-top:20vh;color:red">
      ‚ùå Access Denied <br>
      Please open this page via Administration Panel
    </h2>
  `;
  throw new Error("Unauthorized access");
}

/* ===============================
   API CONFIG
================================ */
const API_STUDENTS = "https://college-hwbb.onrender.com/api/attendance/students";
const API_SUBMIT   = "https://college-hwbb.onrender.com/api/attendance/mark";

let marked = {}; // enrollment ‚Üí P / A

function logout(){
  localStorage.clear();
  sessionStorage.clear();
  location.href = "login.html";
}

/* ===============================
   FETCH ALL STUDENTS (CACHE)
================================ */
async function fetchStudents(){
  const cached = sessionStorage.getItem("att_students");
  if(cached) return JSON.parse(cached);

  try{
    const res = await fetch(API_STUDENTS);
    const data = await res.json();

    if(data.success){
      sessionStorage.setItem("att_students", JSON.stringify(data.students));
      return data.students;
    }
  }catch(err){
    console.error("Student fetch error:", err);
  }

  return [];
}

/* ===============================
   RENDER STUDENTS (FILTERED)
================================ */
async function render(){
  const body = document.getElementById("studentsBody");

  const year    = document.getElementById("year").value;
  const branch  = document.getElementById("branch").value.toLowerCase();
  const section = document.getElementById("section").value;

  if(!year || !branch || !section){
    alert("Please select Year, Branch and Section");
    return;
  }

  body.innerHTML = `<tr><td colspan="3">Loading...</td></tr>`;
  marked = {};

  const students = await fetchStudents();

  // üî• SAME LOGIC AS ADMIN STUDENTS PAGE
  const filtered = students.filter(s=>{
    let ok = true;

    if(year)    ok = ok && String(s.year) === year;
    if(branch)  ok = ok && s.branch.toLowerCase().includes(branch);
    if(section) ok = ok && String(s.section) === section;

    return ok;
  });

  body.innerHTML = "";

  if(!filtered.length){
    body.innerHTML = `
      <tr>
        <td colspan="3" class="no-data">No students found</td>
      </tr>`;
    return;
  }

  filtered.forEach(s=>{
    body.innerHTML += `
      <tr>
        <td>${s.enrollment}</td>
        <td>${s.name}</td>
        <td>
          <button class="mark-btn present"
            onclick="mark('${s.enrollment}','P',this)">Present</button>
          <button class="mark-btn absent"
            onclick="mark('${s.enrollment}','A',this)">Absent</button>
        </td>
      </tr>
    `;
  });
}

/* ===============================
   MARK ATTENDANCE
================================ */
function mark(enr,status,btn){
  marked[enr] = status;

  btn.parentElement.querySelectorAll("button")
    .forEach(b=>b.classList.remove("selected"));

  btn.classList.add("selected");
}

/* ===============================
   SUBMIT ATTENDANCE
================================ */
async function submitAttendance(){
  if(!Object.keys(marked).length){
    alert("No attendance marked");
    return;
  }

  try{
    const res = await fetch(API_SUBMIT,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ records: marked })
    });

    const d = await res.json();
    alert(d.success ? "‚úÖ Attendance saved successfully" : "‚ùå Error saving attendance");
  }catch(err){
    console.error(err);
    alert("‚ùå Server error");
  }
}
</script>


</body>
</html>
