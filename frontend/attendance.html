<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
body{font-family:Inter,system-ui,sans-serif;background:#f5f6fc;margin:0;padding:20px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
select,button{padding:8px 12px;border-radius:6px;border:1px solid #ccc}
button{background:#003366;color:#fff;cursor:pointer}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:10px;overflow:hidden}
th,td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:center}
th{background:#eef3ff}
.mark-btn{padding:6px 12px;border:none;border-radius:6px;cursor:pointer}
.present{background:#16a34a;color:#fff}
.absent{background:#dc2626;color:#fff}
.selected{outline:3px solid #00000022}
.no-data{color:#666}
</style>
</head>

<body>

<header>
  <h2>Attendance Marking</h2>
  <button onclick="logout()">Logout</button>
</header>

<div style="display:flex;gap:10px;margin-bottom:15px">
  <select id="year">
    <option value="">Year</option>
    <option value="1">1st</option>
    <option value="2">2nd</option>
    <option value="3">3rd</option>
    <option value="4">4th</option>
  </select>

  <select id="branch">
    <option value="">Branch</option>
    <option value="CSE">CSE</option>
    <option value="IT">IT</option>
    <option value="ECE">ECE</option>
  </select>

  <select id="section">
    <option value="">Section</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
  </select>

  <button onclick="render()">Load Students</button>
</div>

<table>
<thead>
<tr>
  <th>Enrollment</th>
  <th>Name</th>
  <th>Attendance</th>
</tr>
</thead>
<tbody id="studentsBody">
<tr><td colspan="3" class="no-data">Select filters & load students</td></tr>
</tbody>
</table>

<br>
<button onclick="submitAttendance()">Submit Attendance</button>

<script>
/* ===============================
   ACCESS CONTROL
================================ */
const mentorId = localStorage.getItem("mentorId");
const source = sessionStorage.getItem("accessSource");

if(!mentorId || !["ad","admin"].includes(source)){
  document.body.innerHTML =
    "<h2 style='text-align:center;margin-top:20vh;color:red'>Access Denied</h2>";
  throw new Error("Unauthorized");
}

/* ===============================
   API CONFIG
================================ */
const API_STUDENTS = "https://college-hwbb.onrender.com/api/students";
const API_SUBMIT   = "https://college-hwbb.onrender.com/api/attendance/mark";

let marked = {};

/* ===============================
   RENDER (STUDENT STYLE)
================================ */
async function render(){
  const body = document.getElementById("studentsBody");

  const year = document.getElementById("year").value;
  const branch = document.getElementById("branch").value;
  const section = document.getElementById("section").value;

  if(!year || !branch || !section){
    alert("Select Year, Branch & Section");
    return;
  }

  body.innerHTML = `<tr><td colspan="3">Loading...</td></tr>`;
  marked = {};

  try{
    const cls = `${branch}-${section}`;
    const res = await fetch(`${API_STUDENTS}/${cls}`);
    const data = await res.json();

    let students = data.students || [];

    // ðŸ”¹ SAME FILTER STYLE AS students.html
    let filtered = students.filter(s=>{
      let ok = true;
      ok = ok && String(s.year) === year;
      ok = ok && s.branch.toLowerCase().includes(branch.toLowerCase());
      return ok;
    });

    body.innerHTML = "";

    if(!filtered.length){
      body.innerHTML =
        `<tr><td colspan="3" class="no-data">No students found</td></tr>`;
      return;
    }

    for(const s of filtered){
      body.innerHTML += `
        <tr>
          <td>${s.enrollment}</td>
          <td>${s.name}</td>
          <td>
            <button class="mark-btn present"
              onclick="mark('${s.enrollment}','P',this)">P</button>
            <button class="mark-btn absent"
              onclick="mark('${s.enrollment}','A',this)">A</button>
          </td>
        </tr>
      `;
    }

  }catch(err){
    console.error(err);
    body.innerHTML =
      `<tr><td colspan="3" class="no-data">Server error</td></tr>`;
  }
}

/* ===============================
   MARK ATTENDANCE
================================ */
function mark(enr,status,btn){
  marked[enr] = status;
  btn.parentElement.querySelectorAll("button")
    .forEach(b=>b.classList.remove("selected"));
  btn.classList.add("selected");
}

/* ===============================
   SUBMIT
================================ */
async function submitAttendance(){
  if(!Object.keys(marked).length){
    alert("No attendance marked");
    return;
  }

  const res = await fetch(API_SUBMIT,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ records: marked })
  });

  const d = await res.json();
  alert(d.success ? "Attendance Saved" : "Error saving attendance");
}

function logout(){
  localStorage.clear();
  sessionStorage.clear();
  location.href="login.html";
}
</script>

</body>
</html>
