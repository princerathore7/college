<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin ‚Äî Students Management</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:Inter,system-ui,sans-serif;
  background:#f5f6fc;
  margin:0;
  padding:20px
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px
}
select,button{
  padding:9px 14px;
  border-radius:8px;
  border:1px solid #cbd5e1;
  font-size:14px
}
button{
  background:#003366;
  color:#fff;
  cursor:pointer
}
button:disabled{
  opacity:.5;
  cursor:not-allowed
}

.controls{
  display:flex;
  gap:10px;
  margin-bottom:15px;
  flex-wrap:wrap
}

/* SUMMARY */
.summary{
  display:flex;
  gap:15px;
  margin-bottom:10px;
  font-weight:600
}
.summary span{
  padding:6px 12px;
  border-radius:8px;
  background:#fff;
  box-shadow:0 2px 6px rgba(0,0,0,.06)
}
.present-box{color:#15803d}
.absent-box{color:#b91c1c}

/* TABLE */
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:12px;
  overflow:hidden
}
thead{
  position:sticky;
  top:0;
  z-index:2
}
th{
  background:#eef3ff;
  padding:12px;
  font-size:14px
}
td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
  text-align:center
}

/* ROW STATES */
tr.present-row{background:#ecfdf5}
tr.absent-row{background:#fef2f2}

/* BUTTONS */
.mark-btn{
  padding:6px 14px;
  border:none;
  border-radius:20px;
  cursor:pointer;
  font-weight:600
}
.present{
  background:#16a34a;
  color:#fff
}
.absent{
  background:#dc2626;
  color:#fff
}
.selected{
  outline:3px solid #00000022
}
.no-data{color:#666}
</style>

</head>

<body>

<header>
  <h2>Admin ‚Äî Students</h2>
  <button class="actionBtn" onclick="logout()">Logout</button>
</header>

<main style="padding:20px;max-width:1400px;margin:auto">

<div class="controls">
  <select id="year">
    <option value="">All Years</option>
    <option value="1">1st Year</option>
    <option value="2">2nd Year</option>
    <option value="3">3rd Year</option>
    <option value="4">4th Year</option>
  </select>

  <select id="branch">
    <option value="">All Branches</option>

    <!-- Computer / IT -->
    <option value="CSE">CSE - Computer Science Engineering</option>
    <option value="IT">IT - Information Technology</option>
    <option value="AIML">AIML - Artificial Intelligence & Machine Learning</option>
    <option value="AIDS">AIDS - Artificial Intelligence & Data Science</option>
    <option value="CSBS">CSBS - Computer Science & Business Systems</option>
    <option value="IOT">IoT - Internet of Things</option>


  </select>

  <button class="actionBtn" id="refreshBtn">Refresh</button>
</div>
<label>Select Section</label>
<select id="section">
  <option value="">-- select section --</option>
</select>

<input
  type="text"
  id="searchEnrollment"
  placeholder="Search by Enrollment Number"
  oninput="render(false)"
  style="
    padding:8px 12px;
    border-radius:8px;
    border:1px solid #d1d5db;
    font-size:14px;
    min-width:220px;
    outline:none;
  "
>
<div id="successMsg" style="
display:none;
margin-bottom:10px;
padding:10px;
background:#dcfce7;
color:#166534;
border-radius:8px;
font-weight:600;
text-align:center">
Attendance Submitted ‚úÖ
</div>

<button onclick="submitAttendance()" style="margin-bottom:10px">
Submit Attendance
</button>

<table>
<thead>
<tr>
  <th>Enrollment</th>
  <th>Name</th>
  <th>Year</th>
  <th>Branch</th>
  <th>Attendance</th>
</tr>
</thead>
<tbody id="studentsBody">
<tr><td colspan="7" class="no-data">Loading...</td></tr>
</tbody>
</table>

</main>


</head>
<script>
/* ===============================
   ACCESS CONTROL ‚Äî ADMIN
================================ */
const mentorId = localStorage.getItem("mentorId");
const source   = sessionStorage.getItem("accessSource");
const ALLOWED_SOURCES = ["ad","admin"];

if(!mentorId || !ALLOWED_SOURCES.includes(source)){
  document.body.innerHTML = `
    <h2 style="text-align:center;margin-top:20vh;color:red">
      ‚ùå Access Denied <br>
      Please open this page via Administration Panel
    </h2>
  `;
  throw new Error("Unauthorized access");
}

/* ===============================
   API ENDPOINTS
================================ */
const API_STUDENTS = "https://college-hwbb.onrender.com/api/admin/students";
const API_MARK_ATT = "https://college-hwbb.onrender.com/api/attendance/mark";

/* ===============================
   LOCAL STORAGE (DRAFT)
================================ */
const DRAFT_KEY = "attendance_draft";

function loadDraft(){
  const d = localStorage.getItem(DRAFT_KEY);
  return d ? JSON.parse(d) : {};
}
function saveDraft(d){
  localStorage.setItem(DRAFT_KEY, JSON.stringify(d));
}
function clearDraft(){
  localStorage.removeItem(DRAFT_KEY);
}

let marked = loadDraft();

/* ===============================
   LOGOUT
================================ */
function logout(){
  localStorage.clear();
  location.href = "login.html";
}

/* ===============================
   FETCH STUDENTS (CACHE)
================================ */
async function fetchStudents(force=false){
  if(!force){
    const cached = localStorage.getItem("admin_students");
    if(cached) return JSON.parse(cached);
  }

  const res = await fetch(API_STUDENTS);
  const data = await res.json();

  if(data.success){
    localStorage.setItem("admin_students", JSON.stringify(data.students));
    return data.students;
  }
  return [];
}

/* ===============================
   MARK ATTENDANCE (LOCAL ONLY)
================================ */
function markAttendance(enrollment, status){
  marked[enrollment] = status;
  saveDraft(marked);
}

/* ===============================
   ALL THE SECTIONS IN DB
================================ */
function populateSections(students, branch){
  const sectionSelect = document.getElementById("section");
  sectionSelect.innerHTML = `<option value="">-- select section --</option>`;

  if(!branch) return;

  const sections = [...new Set(
    students
      .filter(s => s.branch === branch)
      .map(s => String(s.section))
  )].sort();

  sections.forEach(sec=>{
    const opt = document.createElement("option");
    opt.value = sec;
    opt.textContent = sec;
    sectionSelect.appendChild(opt);
  });
}

/* ===============================
   SUBMIT ALL ATTENDANCE
================================ */
async function submitAttendance(){
  if(!Object.keys(marked).length){
    alert("No attendance marked");
    return;
  }

  try{
    const res = await fetch(API_MARK_ATT,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ records: marked })
    });

    const data = await res.json();
    if(data.success){
      clearDraft();
      marked = {};
      showSuccess();
    }else{
      alert(data.message || "Submission failed");
    }
  }catch(err){
    console.error(err);
    alert("Server error");
  }
}

/* ===============================
   SUCCESS MESSAGE
================================ */
function showSuccess(){
  const msg = document.getElementById("successMsg");
  msg.style.display = "block";
  setTimeout(()=>msg.style.display="none",3000);
}

/* ===============================
   RENDER (LOGIC SAME + SECTION FIX)
================================ */
async function render(refresh=false){
  const body = document.getElementById("studentsBody");

  const yearVal   = document.getElementById("year").value;
  const branchVal = document.getElementById("branch").value;
  const sectionVal= document.getElementById("section").value;
  const searchEnr = document.getElementById("searchEnrollment").value.trim().toLowerCase();

  const students = await fetchStudents(refresh);

  let filtered = students.filter(s=>{
    let ok = true;

    if(yearVal) ok = ok && String(s.year) === yearVal;

    // ‚úÖ branch + section combined
    if(branchVal && sectionVal){
      ok = ok && `${s.branch}${s.section}` === `${branchVal}${sectionVal}`;
    }else if(branchVal || sectionVal){
      ok = false;
    }

    if(searchEnr){
      ok = ok && s.enrollment.toLowerCase().includes(searchEnr);
    }

    return ok;
  });

  // üîπ SORT LOGIC
  filtered.sort((a, b) => {
    // 1Ô∏è‚É£ Compare by enrollment numbers (extract numeric part)
    const numA = a.enrollment.replace(/\D/g, ""); // keep only digits
    const numB = b.enrollment.replace(/\D/g, "");
    if(Number(numA) !== Number(numB)) return Number(numA) - Number(numB);

    // 2Ô∏è‚É£ If enrollment numbers equal, compare by section ascending
    return Number(a.section) - Number(b.section);
  });
  body.innerHTML = "";

  if(!filtered.length){
    body.innerHTML = `<tr><td colspan="5" class="no-data">No students found</td></tr>`;
    return;
  }

  for(const s of filtered){
    body.innerHTML += `
      <tr>
        <td>${s.enrollment}</td>
        <td>${s.name}</td>
        <td>${s.year}</td>
        <td>${s.branch}</td>
        <td>
          <button onclick="markAttendance('${s.enrollment}','P')">P</button>
          <button onclick="markAttendance('${s.enrollment}','A')">A</button>
        </td>
      </tr>
    `;
  }
}

/* ===============================
   EVENTS
================================ */
["year","branch","section"].forEach(id=>{
  document.getElementById(id).addEventListener("change",()=>render(false));
});
refreshBtn.onclick = ()=>render(true);
document.addEventListener("DOMContentLoaded",()=>render(false));
</script>



</body>
</html>
