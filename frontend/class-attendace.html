<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Attendance View</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{font-family:Inter,system-ui,sans-serif;background:#f5f6fc;margin:0;padding:20px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px}
select,button,input{padding:9px 14px;border-radius:8px;border:1px solid #cbd5e1;font-size:14px}
button{background:#003366;color:#fff;cursor:pointer}
.controls{display:flex;gap:10px;margin-bottom:15px;flex-wrap:wrap}
table{width:100%;border-collapse:collapse;background:#fff;border-radius:12px;overflow:hidden}
th{background:#eef3ff;padding:12px}
td{padding:10px;border-bottom:1px solid #e5e7eb;text-align:center}
.mark-btn{padding:6px 14px;border:none;border-radius:20px;cursor:pointer;font-weight:600;margin:2px}
.present{background:#16a34a;color:#fff}
.absent{background:#dc2626;color:#fff}
.badge{padding:4px 8px;border-radius:6px;font-size:12px;font-weight:700}
.perc{background:#e0e7ff;color:#1e3a8a}
.no-data{color:#666}
</style>
</head>

<body>

<header>
  <h2>Attendance Overview</h2>
  <button onclick="logout()">Logout</button>
</header>

<div class="controls">
  <input id="lectureName" placeholder="Lecture Name (eg. DSA â€“ Unit 3)">
  <input id="teacherName" placeholder="Teacher Name">
  <input id="lectureDate" type="date">
  
  <select id="year">
    <option value="">All Years</option>
    <option value="1">1st</option>
    <option value="2">2nd</option>
    <option value="3">3rd</option>
    <option value="4">4th</option>
  </select>

  <select id="branch">
    <option value="">All Branches</option>
    <option value="CSE1">CSE1</option>
    <option value="CSE2">CSE2</option>
    <option value="IT1">IT1</option>
    <option value="IT2">IT2</option>
  </select>

  <button onclick="render()">Refresh</button>
  <button onclick="undoLast()" style="background:#7c2d12">Undo Last</button>
  <button onclick="downloadPDF()" style="background:#065f46">Download PDF</button>
</div>

<div id="pdfArea">
<table>
<thead>
<tr>
  <th>Enrollment</th>
  <th>Name</th>
  <th>Year</th>
  <th>Branch</th>
  <th>Present</th>
  <th>Absent</th>
  <th>%</th>
</tr>
</thead>
<tbody id="studentsBody">
<tr><td colspan="7" class="no-data">Loading...</td></tr>
</tbody>
</table>
</div>

<script>
/* ============ ACCESS ============ */
const mentorId=localStorage.getItem("mentorId");
const source=sessionStorage.getItem("accessSource");
if(!mentorId||!["ad","admin"].includes(source)){
  document.body.innerHTML="<h2 style='text-align:center;margin-top:20vh;color:red'>Access Denied</h2>";
  throw new Error("Unauthorized");
}

/* ============ STORAGE ============ */
const DEVICE_KEY="attendance_device_count";
let deviceData=JSON.parse(localStorage.getItem(DEVICE_KEY)||"{}");
let history=[];

const API_STUDENTS="https://college-hwbb.onrender.com/api/admin/students";

/* ============ LOGIC ============ */
function logout(){localStorage.clear();location.href="login.html";}

async function fetchStudents(){
  const c=localStorage.getItem("admin_students");
  if(c) return JSON.parse(c);
  const r=await fetch(API_STUDENTS);
  const d=await r.json();
  if(d.success){
    localStorage.setItem("admin_students",JSON.stringify(d.students));
    return d.students;
  }
  return [];
}

function mark(enr,status){
  if(!deviceData[enr]) deviceData[enr]={P:0,A:0};
  deviceData[enr][status]++;
  history.push({enr,status});
  localStorage.setItem(DEVICE_KEY,JSON.stringify(deviceData));
  render();
}

function undoLast(){
  if(!history.length){ alert("Nothing to undo"); return; }
  const last=history.pop();
  deviceData[last.enr][last.status]--;
  if(deviceData[last.enr][last.status]<0) deviceData[last.enr][last.status]=0;
  localStorage.setItem(DEVICE_KEY,JSON.stringify(deviceData));
  render();
}

async function render(){
  const body=document.getElementById("studentsBody");
  const year=document.getElementById("year").value;
  const branch=document.getElementById("branch").value;

  const students=await fetchStudents();
  const filtered=students.filter(s=>{
    if(year && String(s.year)!==year) return false;
    if(branch && s.branch!==branch) return false;
    return true;
  });

  body.innerHTML="";
  if(!filtered.length){
    body.innerHTML=`<tr><td colspan="7" class="no-data">No students</td></tr>`;
    return;
  }

  filtered.forEach(s=>{
    const d=deviceData[s.enrollment]||{P:0,A:0};
    const total=d.P+d.A;
    const perc=total?((d.P/total)*100).toFixed(1):"0.0";
    body.innerHTML+=`
      <tr>
        <td>${s.enrollment}</td>
        <td>${s.name}</td>
        <td>${s.year}</td>
        <td>${s.branch}</td>
        <td><button class="mark-btn present" onclick="mark('${s.enrollment}','P')">P (${d.P})</button></td>
        <td><button class="mark-btn absent" onclick="mark('${s.enrollment}','A')">A (${d.A})</button></td>
        <td><span class="badge perc">${perc}%</span></td>
      </tr>
    `;
  });
}

/* ============ PDF DOWNLOAD ============ */
async function downloadPDF(){
  const lecture=document.getElementById("lectureName").value.trim();
  const teacher=document.getElementById("teacherName").value.trim();
  const date=document.getElementById("lectureDate").value;

  if(!lecture || !teacher){
    alert("Please enter Lecture Name and Teacher Name");
    return;
  }

  const area=document.getElementById("pdfArea");
  const canvas=await html2canvas(area,{scale:2});
  const img=canvas.toDataURL("image/png");

  const { jsPDF } = window.jspdf;
  const pdf=new jsPDF("p","mm","a4");

  pdf.setFontSize(16);
  pdf.text("Attendance Sheet",105,10,{align:"center"});

  pdf.setFontSize(12);
  pdf.text(`Lecture : ${lecture}`,10,20);
  pdf.text(`Teacher : ${teacher}`,10,28);
  pdf.text(`Date    : ${date || new Date().toLocaleDateString()}`,10,36);

  pdf.addImage(img,"PNG",10,45,190,0);
  pdf.save(`${lecture}_attendance.pdf`);
}

document.addEventListener("DOMContentLoaded",render);
</script>

</body>
</html>
