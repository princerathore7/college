<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Attendance View ‚Äî Admin</title>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
body{
  font-family:Inter,sans-serif;
  background:#f4f6fb;
  margin:0;
}
main{padding:20px}

table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:12px;
  overflow:hidden;
}
th,td{
  padding:12px 14px;
  border-bottom:1px solid #e5e7eb;
  text-align:left;
}
th{background:#eef2ff}

.badge{
  padding:6px 10px;
  border-radius:999px;
  font-weight:600;
  font-size:13px;
}
.green{background:#dcfce7;color:#166534}
.yellow{background:#fef9c3;color:#854d0e}
.red{background:#fee2e2;color:#991b1b}

.no-data{
  text-align:center;
  color:#6b7280;
}
</style>
</head>

<body>

<main>
<h2>üìä Attendance Overview</h2>

<input
  type="text"
  id="searchEnrollment"
  placeholder="Search by Enrollment Number"
  style="padding:8px 12px;border-radius:8px;border:1px solid #d1d5db;min-width:220px"
>

<table>
<thead>
<tr>
  <th>Enrollment</th>
  <th>Name</th>
  <th>Year</th>
  <th>Branch</th>
  <th>Attendance %</th>
</tr>
</thead>
<tbody id="studentsBody">
<tr><td colspan="5" class="no-data">Loading...</td></tr>
</tbody>
</table>
</main>

<script>
/* ===============================
   ACCESS CONTROL
================================ */
const mentorId = localStorage.getItem("mentorId");
const source   = sessionStorage.getItem("accessSource");
if(!mentorId || !["ad","admin"].includes(source)){
  document.body.innerHTML="<h2 style='text-align:center;margin-top:20vh;color:red'>‚ùå Access Denied</h2>";
  throw new Error("Unauthorized");
}

/* ===============================
   APIs
================================ */
const API_STUDENTS = "https://college-hwbb.onrender.com/api/admin/students";
const API_SUMMARY  = "https://college-hwbb.onrender.com/api/attendance/summary/";

/* ===============================
   FETCH STUDENTS (CACHE)
================================ */
async function fetchStudents(){
  const cached = localStorage.getItem("admin_students");
  if(cached) return JSON.parse(cached);

  const res = await fetch(API_STUDENTS);
  const d = await res.json();
  if(d.success){
    localStorage.setItem("admin_students", JSON.stringify(d.students));
    return d.students;
  }
  return [];
}

/* ===============================
   FETCH ATTENDANCE SUMMARY
================================ */
async function fetchSummary(enr){
  const res = await fetch(API_SUMMARY + enr);
  const d = await res.json();
  return d.success ? d.summary : null;
}

/* ===============================
   RENDER
================================ */
async function render(){
  const body = document.getElementById("studentsBody");
  const search = document.getElementById("searchEnrollment").value.toLowerCase();

  const students = await fetchStudents();
  const filtered = students.filter(s =>
    !search || s.enrollment.toLowerCase().includes(search)
  );

  body.innerHTML = "";

  if(!filtered.length){
    body.innerHTML = `<tr><td colspan="5" class="no-data">No students found</td></tr>`;
    return;
  }

  for(const s of filtered){
    const sum = await fetchSummary(s.enrollment);

    let badge = "‚Äî";
    if(sum && sum.total){
      const cls = sum.percentage>=75?"green":sum.percentage>=60?"yellow":"red";
      badge = `<span class="badge ${cls}">
        ${sum.percentage}% (${sum.present}/${sum.total})
      </span>`;
    }

    body.innerHTML += `
      <tr>
        <td>${s.enrollment}</td>
        <td>${s.name}</td>
        <td>${s.year}</td>
        <td>${s.branch}</td>
        <td>${badge}</td>
      </tr>
    `;
  }
}

document.getElementById("searchEnrollment").addEventListener("input", render);
document.addEventListener("DOMContentLoaded", render);
</script>

</body>
</html>
