<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="icon" href="https://i.ibb.co/8tZSKKT/logo-with-bg.webp">

<meta charset="UTF-8">
<title>Attendance View</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">

<style>
body{
  font-family:Inter,system-ui,sans-serif;
  background:#f5f6fc;
  margin:0;
  padding:20px
}
header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px
}
select,button{
  padding:8px 12px;
  border-radius:6px;
  border:1px solid #ccc
}
button{
  background:#003366;
  color:#fff;
  cursor:pointer
}
table{
  width:100%;
  border-collapse:collapse;
  background:#fff;
  border-radius:10px;
  overflow:hidden
}
th,td{
  padding:10px;
  border-bottom:1px solid #e5e7eb;
  text-align:center
}
th{
  background:#eef3ff
}
.no-data{
  color:#666
}
.controls{
  display:flex;
  gap:10px;
  margin-bottom:15px;
  flex-wrap:wrap
}
.badge{
  padding:4px 8px;
  border-radius:6px;
  font-size:13px;
  font-weight:600
}
.p{background:#dcfce7;color:#166534}
.a{background:#fee2e2;color:#991b1b}
.perc{background:#e0e7ff;color:#1e3a8a}
</style>
</head>

<body>

<header>
  <h2>Attendance Overview</h2>
  <button onclick="logout()">Logout</button>
</header>

<div class="controls">
  <select id="year">
    <option value="">Year</option>
    <option value="1">1st</option>
    <option value="2">2nd</option>
    <option value="3">3rd</option>
    <option value="4">4th</option>
  </select>

  <select id="branch">
    <option value="">Branch</option>
    <option value="CSE">CSE</option>
    <option value="IT">IT</option>
    <option value="ECE">ECE</option>
  </select>

  <select id="section">
    <option value="">Section</option>
    <option value="1">1</option>
    <option value="2">2</option>
    <option value="3">3</option>
  </select>

  <button onclick="renderTable()">Load Students</button>
</div>

<table>
<thead>
<tr>
  <th>Enrollment</th>
  <th>Name</th>
  <th>Present</th>
  <th>Absent</th>
  <th>Total</th>
  <th>Attendance %</th>
</tr>
</thead>
<tbody id="studentsBody">
<tr>
  <td colspan="6" class="no-data">Select filters & load students</td>
</tr>
</tbody>
</table>

<script>
/* ===============================
   ACCESS CONTROL
================================ */
const mentorId = localStorage.getItem("mentorId");
const source   = sessionStorage.getItem("accessSource");

if(!mentorId || !["ad","admin"].includes(source)){
  document.body.innerHTML =
    "<h2 style='text-align:center;margin-top:20vh;color:red'>Access Denied</h2>";
  throw new Error("Unauthorized");
}

/* ===============================
   CONFIG
================================ */
const API_ALL_STUDENTS = "https://college-hwbb.onrender.com/api/students";

/* ===============================
   DATA
================================ */
let allStudents = [];
let attendanceData = JSON.parse(localStorage.getItem("attendance_data") || "{}");

/* ===============================
   FETCH STUDENTS
================================ */
async function fetchStudents(){
  try{
    const res = await fetch(API_ALL_STUDENTS);
    const data = await res.json();
    if(data.success){
      allStudents = data.students;
    }
  }catch(err){
    console.error(err);
  }
}

/* ===============================
   RENDER TABLE
================================ */
function renderTable(){
  const body = document.getElementById("studentsBody");
  const year = document.getElementById("year").value;
  const branch = document.getElementById("branch").value.toLowerCase();
  const section = document.getElementById("section").value;

  const filtered = allStudents.filter(s=>{
    if(year && String(s.year) !== year) return false;
    if(branch && s.branch.toLowerCase() !== branch) return false;
    if(section && String(s.section) !== section) return false;
    return true;
  });

  body.innerHTML = "";

  if(!filtered.length){
    body.innerHTML = `<tr><td colspan="6" class="no-data">No students found</td></tr>`;
    return;
  }

  filtered.forEach(s=>{
    const att = attendanceData[s.enrollment] || {P:0,A:0};
    const total = att.P + att.A;
    const perc = total ? ((att.P / total) * 100).toFixed(1) : "0.0";

    body.innerHTML += `
      <tr>
        <td>${s.enrollment}</td>
        <td>${s.name}</td>
        <td><span class="badge p">${att.P}</span></td>
        <td><span class="badge a">${att.A}</span></td>
        <td>${total}</td>
        <td><span class="badge perc">${perc}%</span></td>
      </tr>
    `;
  });
}

/* ===============================
   INIT
================================ */
document.addEventListener("DOMContentLoaded", async ()=>{
  await fetchStudents();
});

/* ===============================
   LOGOUT
================================ */
function logout(){
  localStorage.clear();
  sessionStorage.clear();
  location.href="login.html";
}
</script>

</body>
</html>
