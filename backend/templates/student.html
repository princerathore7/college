<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Student Dashboard ‚Äî Acropolis</title>

<!-- Fonts & icons -->
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<style>
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Poppins',sans-serif;background:#f6f8fb;color:#222;overflow-y:auto}
  header{background:linear-gradient(135deg,#004d40,#009688);color:#fff;padding:14px 18px;display:flex;align-items:center;justify-content:space-between;box-shadow:0 2px 10px rgba(0,0,0,0.12);position:sticky;top:0;z-index:1000}
  .logo-area{display:flex;align-items:center;gap:12px}
  .logo-area img{height:44px;border-radius:6px}
  .logo-area h1{font-family:'Playfair Display',serif;font-size:1.4rem}
  .top-actions{display:flex;align-items:center;gap:12px}
  .action-btn{padding:9px 14px;border-radius:8px;border:none;background:#fff;color:#004d40;font-weight:600;cursor:pointer}
  .action-btn:hover{transform:translateY(-2px)}
  .sidebar{position:fixed;left:-260px;top:0;width:250px;height:100%;background:linear-gradient(180deg,#004d40,#009688);color:#fff;padding-top:74px;transition:left .28s;z-index:1200}
  .sidebar.active{left:0}
  .sidebar a{display:block;color:#fff;padding:12px 18px;text-decoration:none;font-weight:500}
  .backdrop{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.35);z-index:1100}
  .backdrop.active{display:block}
  main{max-width:1200px;margin:28px auto;padding:24px}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px}
  .col-4{grid-column:span 4}
  .col-8{grid-column:span 8}
  .section{background:#fff;padding:18px;border-radius:12px;box-shadow:0 6px 14px rgba(0,0,0,0.06)}
  .profile-box{text-align:center;padding:20px;border-radius:12px}
  .profile-box h2{color:#004d40;margin-bottom:8px}
  table{width:100%;border-collapse:collapse;margin-top:8px}
  table th,table td{padding:8px;border-bottom:1px solid #eee;text-align:left}
  h2.section-title{font-family:'Playfair Display',serif;color:#004d40;margin-bottom:10px}
  #eventsBanner{display:flex;overflow-x:auto;gap:12px;padding:12px;border-radius:10px;background:#e0f2f1;border:1px solid #b2dfdb}
  #eventsBanner img{width:220px;height:130px;object-fit:cover;border-radius:8px;cursor:pointer;transition:transform .25s}
  #eventsBanner img:hover{transform:scale(1.04)}
  .badge{display:inline-block;padding:5px 8px;border-radius:8px;color:#fff;font-weight:700}
  .badge.pending{background:#ff9800}.badge.paid{background:#28a745}
  .modal{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:1300}
  .modal.show{display:flex}
  .modal-box{background:#fff;padding:20px;border-radius:10px;width:360px;box-shadow:0 8px 20px rgba(0,0,0,0.2);position:relative}
  .close-x{position:absolute;right:14px;top:10px;cursor:pointer;font-size:20px}
  @media(max-width:900px){
    .col-4{grid-column:span 12}
    .col-8{grid-column:span 12}
    #eventsBanner img{width:160px;height:100px}
    .logo-area h1{font-size:1.1rem}
  }
</style>
</head>
<body>

<header>
  <div class="logo-area">
    <span style="font-size:22px;cursor:pointer;margin-right:6px" id="menuToggle">‚ò∞</span>
    <img src="logo.jpg" alt="logo">
    <h1>Acropolis ‚Äî Student</h1>
  </div>

  <div class="top-actions">
    <div id="mentorIdDisplay" style="color:#fff;margin-right:8px">Student</div>
    <button class="action-btn" id="logoutBtn">Logout</button>
  </div>
</header>

<div class="sidebar" id="sidebar">
  <h2 style="text-align:center;margin:0 0 12px 0;font-family:'Playfair Display',serif">Menu</h2>
  <a href="student-dashboard.html">üè† Dashboard</a>
  <a href="student-ass.html">üìö Assignments</a>
  <a href="#" id="openFeesNav">üí∞ Fees</a>
  <a href="timetable-view.html">üóì Timetable</a>
  <a href="exams.html">üìù Exams</a>
  <a href="notice-read.html?userType=students">üì∞ Notices <span class="notice-badge" style="background:red;color:#fff;border-radius:10px;padding:2px 6px;font-size:12px;margin-left:4px"></span></a>
  <a href="#" onclick="logout()">üö™ Logout</a>
</div>
<div class="backdrop" id="backdrop" onclick="closeSidebar()"></div>

<main>
  <div class="grid">
    <div class="col-4">
      <div class="section profile-box">
        <h2 id="studentName">Loading...</h2>
        <p><strong>Enrollment:</strong> <span id="studentEnrollment">‚Äî</span></p>
        <p><strong>Class:</strong> <span id="studentClass">‚Äî</span></p>
      </div>

      <div class="section" id="attendanceSection">
        <h2 class="section-title">Attendance</h2>
        <table>
          <thead><tr><th>Total</th><th>Present</th><th>%</th></tr></thead>
          <tbody id="attendanceBody"><tr><td colspan="3" style="text-align:center;color:#888;">Loading...</td></tr></tbody>
        </table>
      </div>

      <div class="section">
        <h2 class="section-title">Quick Actions</h2>
        <button class="action-btn" onclick="window.location.href='student-ass.html'">Assignments</button>
        <button class="action-btn" id="openFeesBtn">Check Fees</button>
        <button class="action-btn" onclick="window.location.href='timetable-view.html'">View Timetable</button>
      </div>
    </div>

    <div class="col-8">
      <div id="eventsBanner" class="section"></div>

      <div class="section" id="assignmentsSection">
        <h2 class="section-title">Assignments</h2>
        <table>
          <thead><tr><th>Title</th><th>Subject</th><th>Deadline</th><th>Status</th></tr></thead>
          <tbody id="assignmentsBody"><tr><td colspan="4" style="text-align:center;color:#888">Loading assignments...</td></tr></tbody>
        </table>
      </div>

      <div class="section" id="examsSection">
        <h2 class="section-title">Upcoming Exams</h2>
        <table>
          <thead><tr><th>Exam</th><th>Subject</th><th>Date</th><th>Room</th></tr></thead>
          <tbody id="examsBody"><tr><td colspan="4" style="text-align:center;color:#888">Loading exams...</td></tr></tbody>
        </table>
      </div>

      <div class="section" id="timetableSection">
        <h2 class="section-title">Class Timetable</h2>
        <div id="timetableContainer"><p style="color:#777">Loading timetable...</p></div>
      </div>
    </div>
  </div>
</main>

<div class="modal" id="feesModal" aria-hidden="true">
  <div class="modal-box">
    <span class="close-x" id="feesClose">&times;</span>
    <h3>Check Pending Fees</h3>
    <p>Enrollment</p>
    <input id="feeEnrollment" type="text" placeholder="Enter Enrollment" style="width:100%;padding:8px;border-radius:6px;border:1px solid #ddd" />
    <button style="margin-top:10px;padding:10px 12px;border-radius:8px;background:#007bff;color:#fff;border:none;width:100%" id="checkFeeBtn">Check</button>
    <div id="feeResult" style="margin-top:12px"></div>
  </div>
</div>

<script>
const API_ROOT = "http://localhost:5000";
const API_TIMETABLES = `${API_ROOT}/api/timetables`;

// Sidebar controls
const sidebar = document.getElementById('sidebar');
const backdrop = document.getElementById('backdrop');
document.getElementById('menuToggle').addEventListener('click', ()=> {
  sidebar.classList.toggle('active'); backdrop.classList.toggle('active');
});
function closeSidebar(){ sidebar.classList.remove('active'); backdrop.classList.remove('active'); }

// Logout
document.getElementById('logoutBtn').addEventListener('click', logout);
function logout(){ localStorage.clear(); window.location.href='student-login.html'; }

// Modal (fees)
const feesModal = document.getElementById('feesModal');
document.getElementById('feesClose').addEventListener('click', ()=> feesModal.classList.remove('show'));
document.getElementById('openFeesBtn').addEventListener('click', ()=> openFeesModal());
document.getElementById('openFeesNav').addEventListener('click', ()=> openFeesModal());
function openFeesModal(){
  feesModal.classList.add('show');
  document.getElementById('feeEnrollment').value = localStorage.getItem('enrollment') || '';
  document.getElementById('feeResult').innerHTML='';
}

// Load Attendance
async function loadAttendance(enrollment) {
  try {
    const res = await fetch(`${API_ROOT}/api/attendance/student/${encodeURIComponent(enrollment)}`, { cache: 'no-store' });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { throw new Error("Invalid JSON from server"); }

    const tbody = document.getElementById("attendanceBody");
    if (!tbody) return;

    if (res.ok && data.success && data.attendance) {
      const { total = 0, present = 0, percentage = 0 } = data.attendance;
      tbody.innerHTML = `<tr><td>${total}</td><td>${present}</td><td>${percentage}%</td></tr>`;
    } else {
      tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#888;">No attendance data</td></tr>`;
    }
  } catch (err) {
    const tbody = document.getElementById("attendanceBody");
    if (tbody) tbody.innerHTML = `<tr><td colspan="3" style="text-align:center;color:#e74c3c;">Error loading attendance</td></tr>`;
  }
}

// Other loaders (assignments, exams, events, timetable) remain same
// ... [same as your working ones from previous code] ...

// Load Unread Notices
async function loadUnreadCount(userType, enrollment){
  try{
    const res = await fetch(`${API_ROOT}/api/notices/get/${encodeURIComponent(userType)}`, {cache:'no-store'});
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch { throw new Error("Invalid JSON"); }

    if(res.ok && data.success && Array.isArray(data.notices)){
      const unread = data.notices.filter(n => !Array.isArray(n.readBy) || !n.readBy.includes(enrollment)).length;
      const badge = document.querySelector('.notice-badge');
      if(badge) badge.textContent = unread > 0 ? unread : '';
      const top = document.getElementById('mentorIdDisplay');
      if(top) top.textContent = unread>0 ? `You have ${unread} unread notices` : 'All notices read';
    }
  }catch(err){ console.warn('Notice load error:', err); }
}

// INIT
document.addEventListener('DOMContentLoaded', async ()=>{
  const enrollment = localStorage.getItem('enrollment') || prompt('Enter enrollment:');
  if(!enrollment){ alert('Enrollment required'); window.location.href='student-login.html'; return; }
  localStorage.setItem('enrollment', enrollment);

  loadUnreadCount('students', enrollment);
  loadAttendance(enrollment);
  // You can add your other load functions here (assignments, exams, etc.)
});
</script>

</body>
</html>
